

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>emat.database.sqlite.sqlite_db &mdash; TMIP-EMAT 0.6.4, January 2025 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/tmip_emat.css?v=eec227e2" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/jupyter-sphinx.css" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/thebelab.css" />

  
      <script src="../../../../_static/documentation_options.js?v=ff12c608"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../_static/thebelab-helper.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            TMIP-EMAT
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/emat.intro.html">Introduction to EMAT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/emat.install.html">Installation and Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/emat.scope/index.html">Exploratory Scoping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/emat.design/emat.design.html">Experimental Designs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/emat.models/index.html">Core Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/emat.metamodels/index.html">Meta Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/emat.database/index.html">Databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/emat.analysis/index.html">Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/emat.examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/emat.glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/emat.method-index.html">Methodology Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/emat.references.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">TMIP-EMAT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">emat.database.sqlite.sqlite_db</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for emat.database.sqlite.sqlite_db</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;sqlite_db:</span>
<span class="sd">    Methods for creating and deleting a sqlite3 database for emat.</span>
<span class="sd">    A Sqlite3 database is a single file.</span>
<span class="sd">    The class knows the set of sql files needed to create the necessary tables</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">atexit</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">AbstractSet</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">sql_queries</span> <span class="k">as</span> <span class="n">sq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..database</span><span class="w"> </span><span class="kn">import</span> <span class="n">Database</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">...util.deduplicate</span><span class="w"> </span><span class="kn">import</span> <span class="n">reindex_duplicates</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">...exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatabaseVersionWarning</span><span class="p">,</span> <span class="n">DatabaseVersionError</span><span class="p">,</span> <span class="n">DatabaseError</span><span class="p">,</span> <span class="n">ReadOnlyDatabaseError</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">...util.loggers</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_module_logger</span>
<span class="n">_logger</span> <span class="o">=</span> <span class="n">get_module_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">...util.docstrings</span><span class="w"> </span><span class="kn">import</span> <span class="n">copydoc</span>

<span class="n">sqlite3</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_to_uuid</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a value to a UUID&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">b</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">==</span><span class="mi">16</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xDE\xAD\xBE\xEF</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xDE\xAD\xBE\xEF</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>



<div class="viewcode-block" id="SQLiteDB">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SQLiteDB</span><span class="p">(</span><span class="n">Database</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SQLite implementation of the :class:`Database` abstract base class.</span>

<span class="sd">    Args:</span>
<span class="sd">        database_path (str, optional): file path and name of database file</span>
<span class="sd">            If not given, a database is initialized in-memory.</span>
<span class="sd">        initialize (bool or &#39;skip&#39;, default False):</span>
<span class="sd">            Whether to initialize emat database file.  The value of this argument</span>
<span class="sd">            is ignored if `database_path` is not given (as in-memory databases</span>
<span class="sd">            must always be initialized).  If given as &#39;skip&#39; then no setup</span>
<span class="sd">            scripts are run, and it is assumed that all relevant tables already</span>
<span class="sd">            exist in the database.</span>
<span class="sd">        readonly (bool, default False):</span>
<span class="sd">            Whether to open the database connection in readonly mode.</span>
<span class="sd">        check_same_thread (bool, default True):</span>
<span class="sd">            By default, check_same_thread is True and only the creating thread</span>
<span class="sd">            may use the connection. If set False, the returned connection may be</span>
<span class="sd">            shared across multiple threads.  The dask distributed evaluator has</span>
<span class="sd">            workers that run code in a separate thread from the model class object,</span>
<span class="sd">            so setting this to False is necessary to enable SQLite connections on</span>
<span class="sd">            the workers.</span>
<span class="sd">        update (bool, default True):</span>
<span class="sd">            Whether to attempt a database schema update if the open file appears</span>
<span class="sd">            to be an out-of-date database format.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">database_path</span><span class="o">=</span><span class="s2">&quot;:memory:&quot;</span><span class="p">,</span>
            <span class="n">initialize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">readonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">check_same_thread</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="n">readonly</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">database_path</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.gz&#39;</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span><span class="o">,</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">shutil</span><span class="o">,</span><span class="w"> </span><span class="nn">gzip</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">database_path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">database_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tempdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span>
            <span class="n">tempfilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">database_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tempfilename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">database_path</span><span class="p">),</span> <span class="n">tmp</span><span class="p">)</span>
            <span class="n">database_path</span> <span class="o">=</span> <span class="n">tempfilename</span>
        <span class="k">elif</span> <span class="n">database_path</span> <span class="o">==</span> <span class="s1">&#39;tempfile&#39;</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span><span class="o">,</span><span class="w"> </span><span class="nn">os</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tempdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span>
            <span class="n">database_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;emat-temp.db&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">database_path</span> <span class="o">=</span> <span class="n">database_path</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database_path</span> <span class="o">==</span> <span class="s2">&quot;:memory:&quot;</span><span class="p">:</span>
            <span class="n">initialize</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># in order:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modules</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialize</span> <span class="o">==</span> <span class="s1">&#39;skip&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create</span><span class="p">(</span>
                <span class="p">[],</span>
                <span class="n">wipe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">check_same_thread</span><span class="o">=</span><span class="n">check_same_thread</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">initialize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;emat_db_init.sql&quot;</span><span class="p">,</span> <span class="s2">&quot;meta_model.sql&quot;</span><span class="p">],</span>
                <span class="n">wipe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">check_same_thread</span><span class="o">=</span><span class="n">check_same_thread</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">readonly</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;file:</span><span class="si">{</span><span class="n">database_path</span><span class="si">}</span><span class="s1">?mode=ro&#39;</span><span class="p">,</span>
                <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">check_same_thread</span><span class="o">=</span><span class="n">check_same_thread</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;emat_db_init.sql&quot;</span><span class="p">,</span> <span class="s2">&quot;meta_model.sql&quot;</span><span class="p">],</span>
                <span class="n">wipe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">check_same_thread</span><span class="o">=</span><span class="n">check_same_thread</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">readonly</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys = ON&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">SET_VERSION_DATABASE</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">SET_MINIMUM_VERSION_DATABASE</span><span class="p">)</span>

        <span class="c1"># Warn if opening a database that requires a more recent version of tmip-emat.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_min_ver</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_MINIMUM_VERSION_DATABASE</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_min_ver</span><span class="p">):</span>
                <span class="n">_min_ver_number</span> <span class="o">=</span> <span class="n">_min_ver</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">...</span><span class="w"> </span><span class="kn">import</span> <span class="n">__version__</span>
                <span class="n">ver</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">__version__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)])</span>
                       <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">1000000</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">_min_ver_number</span> <span class="o">&gt;</span> <span class="n">ver</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Database requires emat version </span><span class="si">{</span><span class="n">_min_ver_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">category</span><span class="o">=</span><span class="n">DatabaseVersionWarning</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">update</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>

            <span class="c1"># update old databases</span>
            <span class="k">if</span> <span class="s1">&#39;design&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_query</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;ema_experiment&#39;</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_database</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">UPDATE_DATABASE_ema_design_experiment</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;run_source&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_query</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;ema_experiment_run&#39;</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_database</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">UPDATE_DATABASE_ema_experiment_run_ADD_run_source</span><span class="p">,</span> <span class="n">on_error</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="s1">&#39;scope_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_query</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;ema_scope&#39;</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="ow">or</span> <span class="s1">&#39;measure_source&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_query</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;ema_experiment_measure&#39;</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="ow">or</span> <span class="s2">&quot;UNIQUE&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_query</span><span class="p">(</span><span class="s2">&quot;SELECT sql FROM sqlite_master WHERE name=&#39;ema_scope_measure&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;sql&#39;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;measure_run&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_query</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;ema_experiment_measure&#39;</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_database</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">UPDATE_DATABASE_ema_experiment_measure_ADD_measure_run</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__apply_sql_script</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="s1">&#39;emat_db_rebuild.sql&#39;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_database_for_run_ids</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;UPDATE FAIL&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__apply_sql_script</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="s1">&#39;emat_db_init_views.sql&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;VIEWS FAIL&quot;</span><span class="p">)</span>
        <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">__create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">wipe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_same_thread</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call sql files to create sqlite database file</span>
<span class="sd">        &quot;&quot;&quot;</span>
       
        <span class="c1"># close connection and delete file if exists</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database_path</span> <span class="o">!=</span> <span class="s2">&quot;:memory:&quot;</span> <span class="ow">and</span> <span class="n">wipe</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__delete_database</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_path</span><span class="p">,</span> <span class="n">check_same_thread</span><span class="o">=</span><span class="n">check_same_thread</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatabaseError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;error on connecting to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">database_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__apply_sql_script</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conn</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__apply_sql_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">connection</span><span class="p">:</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;running script &quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__read_sql_file</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span>
                        <span class="n">filename</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">contents</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">z</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected output in database script </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SQLiteDB.vacuum">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.vacuum">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">vacuum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Vacuum the SQLite database.</span>

<span class="sd">        SQLite files grow over time, and may have inefficient allocation of data</span>
<span class="sd">        as more rows are added.  This command may make the database file run faster</span>
<span class="sd">        or be smaller on disk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;VACUUM&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SQLiteDB.update_database_for_run_ids">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.update_database_for_run_ids">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_database_for_run_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add run_id to runs that do not have one.</span>

<span class="sd">        This command is for updating older files, and  should not be needed</span>
<span class="sd">        on recently created database files.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># add run_id to runs that do not have one</span>

        <span class="k">if</span> <span class="s1">&#39;measure_source&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_query</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;ema_experiment_measure&#39;</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">():</span>
            <span class="c1"># measure source and experiment id</span>
            <span class="n">experiments_with_missing_run_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_query</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT DISTINCT experiment_id, measure_source FROM ema_experiment_measure WHERE measure_run IS NULL</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">experiments_with_missing_run_ids</span><span class="p">[</span><span class="s1">&#39;run_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">experiments_with_missing_run_ids</span><span class="p">[</span><span class="s1">&#39;experiment_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">)</span>
            <span class="n">experiments_with_missing_run_ids</span><span class="p">[</span><span class="s1">&#39;run_rowid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># experiment id only</span>
            <span class="n">experiments_with_missing_run_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_query</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT DISTINCT experiment_id FROM ema_experiment_measure WHERE measure_run IS NULL</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">experiments_with_missing_run_ids</span><span class="p">[</span><span class="s1">&#39;run_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">experiments_with_missing_run_ids</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">)</span>
            <span class="n">experiments_with_missing_run_ids</span><span class="p">[</span><span class="s1">&#39;run_rowid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">experiments_with_missing_run_ids</span><span class="p">[</span><span class="s1">&#39;measure_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">experiments_with_missing_run_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;found no experiments with missing run_id&#39;s&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">experiments_with_missing_run_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> experiments with missing run_id, updating database&quot;</span><span class="p">)</span>

        <span class="n">experiments_with_missing_run_ids</span><span class="p">[</span><span class="s1">&#39;run_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">experiments_with_missing_run_ids</span><span class="p">[</span><span class="s1">&#39;run_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">bytes</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="c1"># remove otherwise duplicate rows from ema_experiment_measure</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            DELETE FROM</span>
<span class="s2">                ema_experiment_measure</span>
<span class="s2">            WHERE</span>
<span class="s2">                rowid NOT IN (</span>
<span class="s2">                     SELECT min(rowid)</span>
<span class="s2">                     FROM ema_experiment_measure</span>
<span class="s2">                     GROUP BY </span>
<span class="s2">                        experiment_id, </span>
<span class="s2">                        measure_id, </span>
<span class="s2">                        measure_run</span>
<span class="s2">                )</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># write new run_ids to run table</span>
            <span class="n">qry</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            INSERT INTO ema_experiment_run (run_id, experiment_id, run_status, run_valid, run_location, run_source)</span>
<span class="s2">            VALUES (@run_id, @experiment_id, &#39;existing&#39;, 1, NULL, @measure_source) </span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">experiments_with_missing_run_ids</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">qry</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">experiments_with_missing_run_ids</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                <span class="n">experiments_with_missing_run_ids</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="s1">&#39;run_rowid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">lastrowid</span><span class="p">)</span>

            <span class="c1">#then update measures table with run ids.</span>
            <span class="k">if</span> <span class="s1">&#39;measure_source&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_query</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="s1">&#39;ema_experiment_measure&#39;</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">():</span>
                <span class="n">qry</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                UPDATE </span>
<span class="s2">                    ema_experiment_measure</span>
<span class="s2">                SET </span>
<span class="s2">                    measure_run = @run_rowid </span>
<span class="s2">                WHERE </span>
<span class="s2">                    measure_run IS NULL </span>
<span class="s2">                    AND experiment_id = @experiment_id</span>
<span class="s2">                    AND measure_source = @measure_source</span>
<span class="s2">                &quot;&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qry</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                UPDATE </span>
<span class="s2">                    ema_experiment_measure</span>
<span class="s2">                SET </span>
<span class="s2">                    measure_run = @run_rowid </span>
<span class="s2">                WHERE </span>
<span class="s2">                    measure_run IS NULL </span>
<span class="s2">                    AND experiment_id = @experiment_id</span>
<span class="s2">                &quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">experiments_with_missing_run_ids</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">bindings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">experiments_with_missing_run_ids</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">qry</span><span class="p">,</span> <span class="n">bindings</span><span class="p">)</span></div>


<div class="viewcode-block" id="SQLiteDB.update_database">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.update_database">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queries</span><span class="p">,</span> <span class="n">on_error</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update database for compatability with tmip-emat 0.4 and later</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatabaseVersionError</span><span class="p">(</span><span class="s2">&quot;cannot open or update an old database in readonly&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;updating database file&quot;</span><span class="p">,</span>
                <span class="n">category</span><span class="o">=</span><span class="n">DatabaseVersionWarning</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">on_error</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span><span class="s1">&#39;raise&#39;</span><span class="p">):</span>
                        <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SQL Query:</span><span class="se">\n</span><span class="si">{</span><span class="n">u</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">on_error</span> <span class="o">==</span> <span class="s1">&#39;raise&#39;</span><span class="p">:</span>
                        <span class="k">raise</span></div>



    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">scopes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_scope_names</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scopes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;emat.SQLiteDB with scope &quot;</span><span class="si">{</span><span class="n">scopes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot;&gt;&#39;</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">scopes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;emat.SQLiteDB with no scopes&gt;&#39;</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">scopes</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;emat.SQLiteDB with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">scopes</span><span class="p">)</span><span class="si">}</span><span class="s1"> scopes: &quot;</span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scopes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s1">&quot;&gt;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;emat.SQLiteDB with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">scopes</span><span class="p">)</span><span class="si">}</span><span class="s1"> scopes&gt;&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__read_sql_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        helper function to load sql files to create database</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sql_file_path</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sql_file_path</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sql_file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fil</span><span class="p">:</span>
            <span class="n">all_lines</span> <span class="o">=</span> <span class="n">fil</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">all_lines</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">__delete_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete the sqlite database file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_path</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_raw_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bindings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">qry</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">qry</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PRAGMA table_info(</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">);&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bindings</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">qry</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="n">bindings</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()))</span>
            <span class="k">elif</span> <span class="n">bindings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">qry</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">qry</span><span class="p">,</span> <span class="n">bindings</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">description</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

<div class="viewcode-block" id="SQLiteDB.get_db_info">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.get_db_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_db_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a short string describing this Database</span>

<span class="sd">        Returns:</span>
<span class="sd">            str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;SQLite @ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">database_path</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="SQLiteDB.init_xlm">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.init_xlm">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_xlm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter_list</span><span class="p">,</span> <span class="n">measure_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize or extend set of experiment variables and measures</span>

<span class="sd">        Initialize database with universe of risk variables,</span>
<span class="sd">        policy variables, and performance measures. All variables and measures</span>
<span class="sd">        defined in scopes must be defined in this set.</span>
<span class="sd">        This method only needs to be run</span>
<span class="sd">        once after creating a new database.</span>

<span class="sd">        Args:</span>
<span class="sd">            parameter_list (List[tuple]):</span>
<span class="sd">                Experiment variable tuples (variable name, type)</span>
<span class="sd">                where variable name is a string and</span>
<span class="sd">                type is &#39;uncertainty&#39;, &#39;lever&#39;, or &#39;constant&#39;</span>
<span class="sd">            measure_list (List[tuple]):</span>
<span class="sd">                Performance measure tuples (name, transform), where</span>
<span class="sd">                name is a string and transform is a defined transformation</span>
<span class="sd">                used in metamodeling, currently supported include {&#39;log&#39;, None}.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="c1"># experiment variables - description and type (risk or strategy)</span>
            <span class="k">for</span> <span class="n">xl</span> <span class="ow">in</span> <span class="n">parameter_list</span><span class="p">:</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">CONDITIONAL_INSERT_XL</span><span class="p">,</span> <span class="n">xl</span><span class="p">)</span>

            <span class="c1"># performance measures - description</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">measure_list</span><span class="p">:</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">CONDITIONAL_INSERT_M</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span></div>



    <span class="k">def</span><span class="w"> </span><span class="nf">_write_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="p">,</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">scp_xl</span><span class="p">,</span> <span class="n">scp_m</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the emat scope information to the database.</span>

<span class="sd">        Generally users should not call this function directly,</span>
<span class="sd">        use `store_scope` instead.</span>

<span class="sd">        Args:</span>
<span class="sd">            scope_name (str):</span>
<span class="sd">                The scope name, used to identify experiments,</span>
<span class="sd">                performance measures, and results associated with this model.</span>
<span class="sd">                Multiple scopes can be stored in the same database.</span>
<span class="sd">            sheet (str):</span>
<span class="sd">                Yaml file name with scope definition.</span>
<span class="sd">            scp_xl (List[str]):</span>
<span class="sd">                Scope parameter names - both uncertainties and policy levers</span>
<span class="sd">            scp_m (List[str]):</span>
<span class="sd">                Scope performance measure names</span>
<span class="sd">            content (Scope, optional):</span>
<span class="sd">                Scope object to be pickled and stored in the database.</span>
<span class="sd">        Raises:</span>
<span class="sd">            KeyError:</span>
<span class="sd">                If scope name already exists, the scp_vars are not</span>
<span class="sd">                available, or the performance measures are not initialized</span>
<span class="sd">                in the database.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ReadOnlyDatabaseError</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span><span class="o">,</span><span class="w"> </span><span class="nn">cloudpickle</span>
                <span class="n">blob</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">cloudpickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">blob</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">INSERT_SCOPE</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">blob</span><span class="p">])</span>
            <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;scope named &quot;</span><span class="si">{</span><span class="n">scope_name</span><span class="si">}</span><span class="s1">&quot; already exists&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">xl</span> <span class="ow">in</span> <span class="n">scp_xl</span><span class="p">:</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">INSERT_SCOPE_XL</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">xl</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Experiment Variable </span><span class="si">{0}</span><span class="s1"> not present in database&#39;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xl</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">scp_m</span><span class="p">:</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">INSERT_SCOPE_M</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">m</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Performance measure </span><span class="si">{0}</span><span class="s1"> not present in database&#39;</span>
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>

<div class="viewcode-block" id="SQLiteDB.update_scope">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.update_scope">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the emat scope information in the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            scope (Scope): scope to update</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ReadOnlyDatabaseError</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">...scope.scope</span><span class="w"> </span><span class="kn">import</span> <span class="n">Scope</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">Scope</span><span class="p">)</span>
        <span class="n">scope_name</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">name</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">scope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span><span class="o">,</span><span class="w"> </span><span class="nn">cloudpickle</span>
                <span class="n">blob</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">cloudpickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">scope</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unpickleable scope&quot;</span><span class="p">)</span>

            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">sq</span><span class="o">.</span><span class="n">UPDATE_SCOPE_CONTENT</span><span class="p">,</span>
                <span class="p">{</span><span class="s1">&#39;scope_name&#39;</span><span class="p">:</span><span class="n">scope_name</span><span class="p">,</span> <span class="s1">&#39;scope_pickle&#39;</span><span class="p">:</span><span class="n">blob</span><span class="p">},</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">xl</span> <span class="ow">in</span> <span class="n">scope</span><span class="o">.</span><span class="n">get_uncertainties</span><span class="p">()</span><span class="o">+</span><span class="n">scope</span><span class="o">.</span><span class="n">get_levers</span><span class="p">():</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">sq</span><span class="o">.</span><span class="n">CONDITIONAL_INSERT_XL</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">xl</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">xl</span><span class="o">.</span><span class="n">ptype</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">sq</span><span class="o">.</span><span class="n">INSERT_SCOPE_XL</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;INSERT&quot;</span><span class="p">,</span> <span class="s2">&quot;INSERT OR IGNORE&quot;</span><span class="p">),</span>
                    <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">xl</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
                <span class="p">)</span>

            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">scope</span><span class="o">.</span><span class="n">get_measures</span><span class="p">():</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">sq</span><span class="o">.</span><span class="n">CONDITIONAL_INSERT_M</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">transform</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">sq</span><span class="o">.</span><span class="n">INSERT_SCOPE_M</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;INSERT&quot;</span><span class="p">,</span> <span class="s2">&quot;INSERT OR IGNORE&quot;</span><span class="p">),</span>
                    <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
                <span class="p">)</span></div>



<div class="viewcode-block" id="SQLiteDB.store_scope">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.store_scope">[docs]</a>
    <span class="nd">@copydoc</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">store_scope</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">store_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save an emat.Scope directly to the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            scope (Scope): The scope object to store.</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If scope name already exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ReadOnlyDatabaseError</span>
        <span class="k">return</span> <span class="n">scope</span><span class="o">.</span><span class="n">store_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="SQLiteDB.read_scope">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.read_scope">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the pickled scope from the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            scope_name (str, optional):</span>
<span class="sd">                The name of the scope to load.  If not</span>
<span class="sd">                given and there is only one scope stored</span>
<span class="sd">                in the database, that scope is loaded. If not</span>
<span class="sd">                given and there are multiple scopes stored in</span>
<span class="sd">                the database, a KeyError is raised.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Scope</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If a name is given but is not found in</span>
<span class="sd">                the database, or if no name is given but there</span>
<span class="sd">                is more than one scope stored.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">scope_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scope_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_scope_names</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scope_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;multiple scopes stored in database, you must identify one:</span><span class="se">\n</span><span class="s2"> -&quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> -&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scope_names</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">scope_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;no scopes stored in database&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scope_name</span> <span class="o">=</span> <span class="n">scope_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">blob</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_SCOPE</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">])</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;scope &#39;</span><span class="si">{</span><span class="n">scope_name</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">blob</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">blob</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span><span class="o">,</span><span class="w"> </span><span class="nn">cloudpickle</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cloudpickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">gzip</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">blob</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ModuleNotFoundError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;ema_workbench&quot;</span> <span class="ow">in</span> <span class="n">err</span><span class="o">.</span><span class="n">msg</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">...</span><span class="w"> </span><span class="kn">import</span> <span class="n">workbench</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;ema_workbench&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workbench</span>
                <span class="k">return</span> <span class="n">cloudpickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">gzip</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">blob</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span></div>



<div class="viewcode-block" id="SQLiteDB.write_metamodel">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.write_metamodel">[docs]</a>
    <span class="nd">@copydoc</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">write_metamodel</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_metamodel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="p">,</span> <span class="n">metamodel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metamodel_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metamodel_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ReadOnlyDatabaseError</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metamodel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="s1">&#39;scope&#39;</span><span class="p">):</span>
                <span class="c1"># The metamodel was the one and only argument,</span>
                <span class="c1"># and it embeds the Scope.</span>
                <span class="n">metamodel</span> <span class="o">=</span> <span class="n">scope_name</span>
                <span class="n">scope_name</span> <span class="o">=</span> <span class="n">metamodel</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span>

            <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># Do not store PythonCoreModel, store the metamodel it wraps</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">...model.core_python</span><span class="w"> </span><span class="kn">import</span> <span class="n">PythonCoreModel</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">...model.meta_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetaModel</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metamodel</span><span class="p">,</span> <span class="n">PythonCoreModel</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metamodel</span><span class="o">.</span><span class="n">function</span><span class="p">,</span> <span class="n">MetaModel</span><span class="p">):</span>
                <span class="n">metamodel_name</span> <span class="o">=</span> <span class="n">metamodel_name</span> <span class="ow">or</span> <span class="n">metamodel</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="n">metamodel_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">metamodel_id</span> <span class="o">=</span> <span class="n">metamodel</span><span class="o">.</span><span class="n">metamodel_id</span>
                <span class="n">metamodel</span> <span class="o">=</span> <span class="n">metamodel</span><span class="o">.</span><span class="n">function</span>

            <span class="c1"># Get a new id if needed</span>
            <span class="k">if</span> <span class="n">metamodel_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">metamodel_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_metamodel_id</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>

            <span class="c1"># Don&#39;t pickle-zip a null model</span>
            <span class="k">if</span> <span class="n">metamodel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">blob</span> <span class="o">=</span> <span class="n">metamodel</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span><span class="o">,</span><span class="w"> </span><span class="nn">cloudpickle</span>
                <span class="n">blob</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">cloudpickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metamodel</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">INSERT_METAMODEL_PICKLE</span><span class="p">,</span>
                             <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">metamodel_id</span><span class="p">,</span> <span class="n">metamodel_name</span><span class="p">,</span> <span class="n">blob</span><span class="p">])</span>
            <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;metamodel_id </span><span class="si">{</span><span class="n">metamodel_id</span><span class="si">}</span><span class="s1"> for scope &quot;</span><span class="si">{</span><span class="n">scope_name</span><span class="si">}</span><span class="s1">&quot; already exists&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DatabaseError</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

        <span class="k">return</span> <span class="n">metamodel_id</span></div>


<div class="viewcode-block" id="SQLiteDB.read_metamodel">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.read_metamodel">[docs]</a>
    <span class="nd">@copydoc</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">read_metamodel</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_metamodel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="p">,</span> <span class="n">metamodel_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">metamodel_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">candidate_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_metamodel_ids</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">metamodel_id</span> <span class="o">=</span> <span class="n">candidate_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no metamodels for scope &quot;</span><span class="si">{</span><span class="n">scope_name</span><span class="si">}</span><span class="s1">&quot; are stored&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">candidate_ids</span><span class="p">)</span><span class="si">}</span><span class="s1"> metamodels for scope &quot;</span><span class="si">{</span><span class="n">scope_name</span><span class="si">}</span><span class="s1">&quot; are stored&#39;</span><span class="p">)</span>

        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">query_result</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">sq</span><span class="o">.</span><span class="n">GET_METAMODEL_PICKLE</span><span class="p">,</span>
            <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">metamodel_id</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">blob</span> <span class="o">=</span> <span class="n">query_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no metamodel_id </span><span class="si">{</span><span class="n">metamodel_id</span><span class="si">}</span><span class="s2"> for scope named &#39;</span><span class="si">{</span><span class="n">scope_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span><span class="o">,</span><span class="w"> </span><span class="nn">pickle</span>
        <span class="n">mm</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">gzip</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">blob</span><span class="p">))</span>

        <span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">...model.core_python</span><span class="w"> </span><span class="kn">import</span> <span class="n">PythonCoreModel</span>
        <span class="k">return</span> <span class="n">PythonCoreModel</span><span class="p">(</span>
            <span class="n">mm</span><span class="p">,</span>
            <span class="n">configuration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">,</span>
            <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">metamodel_id</span><span class="o">=</span><span class="n">metamodel_id</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SQLiteDB.read_metamodel_ids">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.read_metamodel_ids">[docs]</a>
    <span class="nd">@copydoc</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">read_metamodel_ids</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_metamodel_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="p">):</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">metamodel_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_METAMODEL_IDS</span><span class="p">,</span>
                                                         <span class="p">[</span><span class="n">scope_name</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">metamodel_ids</span></div>


<div class="viewcode-block" id="SQLiteDB.get_new_metamodel_id">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.get_new_metamodel_id">[docs]</a>
    <span class="nd">@copydoc</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">get_new_metamodel_id</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_new_metamodel_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">metamodel_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_NEW_METAMODEL_ID</span><span class="p">,)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_metamodel</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">metamodel_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">,</span> <span class="n">DatabaseError</span><span class="p">,</span> <span class="n">ReadOnlyDatabaseError</span><span class="p">):</span>
                <span class="c1"># for read only database, generate a random large integer</span>
                <span class="n">metamodel_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">63</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">metamodel_id</span></div>



<div class="viewcode-block" id="SQLiteDB.add_scope_meas">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.add_scope_meas">[docs]</a>
    <span class="nd">@copydoc</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">add_scope_meas</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_scope_meas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="p">,</span> <span class="n">scp_m</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;deprecated: use update_scope instead&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="SQLiteDB.delete_scope">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.delete_scope">[docs]</a>
    <span class="nd">@copydoc</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">delete_scope</span><span class="p">)</span> 
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ReadOnlyDatabaseError</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">DELETE_SCOPE</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">])</span></div>


<div class="viewcode-block" id="SQLiteDB.write_experiment_parameters">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.write_experiment_parameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_experiment_parameters</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">scope_name</span><span class="p">,</span>
            <span class="n">design_name</span><span class="p">,</span>
            <span class="n">xl_df</span><span class="p">,</span>
            <span class="n">force_ids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write experiment definitions the the database.</span>

<span class="sd">        This method records values for each experiment parameter,</span>
<span class="sd">        for each experiment in a design of one or more experiments.</span>

<span class="sd">        Args:</span>
<span class="sd">            scope_name (str):</span>
<span class="sd">                A scope name, used to identify experiments,</span>
<span class="sd">                performance measures, and results associated with this</span>
<span class="sd">                exploratory analysis. The scope with this name should</span>
<span class="sd">                already have been stored in this database.</span>
<span class="sd">            design_name (str):</span>
<span class="sd">                An experiment design name. This name should be unique</span>
<span class="sd">                within the named scope, and typically will include a</span>
<span class="sd">                reference to the design sampler, for example:</span>
<span class="sd">                &#39;uni&#39; - generated by univariate sensitivity test design</span>
<span class="sd">                &#39;lhs&#39; - generated by latin hypercube sample design</span>
<span class="sd">                The design_name is used primarily to load groups of</span>
<span class="sd">                related experiments together.</span>
<span class="sd">            xl_df (pandas.DataFrame):</span>
<span class="sd">                The columns of this DataFrame are the experiment</span>
<span class="sd">                parameters (i.e. policy levers, uncertainties, and</span>
<span class="sd">                constants), and each row is an experiment.</span>
<span class="sd">            force_ids (bool, default False):</span>
<span class="sd">                For the experiment id&#39;s saved into the database to match</span>
<span class="sd">                the id&#39;s in the index of `xl_df`, or raise an error if</span>
<span class="sd">                this cannot be completed, either because that id is in</span>
<span class="sd">                use for a different experiment, or because this experiment</span>
<span class="sd">                is already saved with a different id.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: the experiment id&#39;s of the newly recorded experiments</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserWarning: If scope name does not exist</span>
<span class="sd">            TypeError: If not all scope variables are defined in the</span>
<span class="sd">                exp_def</span>
<span class="sd">            ValueError: If `force_ids` is True but the same experiment</span>
<span class="sd">                already has a different id.</span>
<span class="sd">            sqlite3.IntegrityError: If `force_ids` is True but a different</span>
<span class="sd">                experiment is already using the given id.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ReadOnlyDatabaseError</span>
        <span class="k">if</span> <span class="n">design_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">design_name</span> <span class="o">=</span> <span class="s1">&#39;ad hoc&#39;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">design_name</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">design_name_map</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">design_name</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">...util.seq_grouping</span><span class="w"> </span><span class="kn">import</span> <span class="n">seq_int_group_expander</span>
                    <span class="n">design_name_map</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq_int_group_expander</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">design_name_map</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">design_name_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">design_name</span><span class="p">:</span> <span class="n">xl_df</span><span class="o">.</span><span class="n">index</span><span class="p">}</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="s1">&#39;design_name&#39;</span><span class="p">)</span>
            <span class="c1"># local cursor because we&#39;ll depend on lastrowid</span>
            <span class="n">fcur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="c1"># get list of experiment variables - except &quot;one&quot;</span>
            <span class="n">scp_xl</span> <span class="o">=</span> <span class="n">fcur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_SCOPE_XL</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">])</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scp_xl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">UserWarning</span><span class="p">(</span><span class="s1">&#39;named scope </span><span class="si">{0}</span><span class="s1"> not found - experiments will </span><span class="se">\</span>
<span class="s1">                                      not be recorded&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scope_name</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">design_name_map</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fcur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">INSERT_DESIGN</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span>
                <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">DatabaseError</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

            <span class="c1">### split experiments into novel and duplicate ###</span>
            <span class="c1"># first join to existing experiments</span>
            <span class="n">existing_experiments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_experiment_parameters</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">combined_experiments</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
                <span class="n">existing_experiments</span><span class="p">,</span>
                <span class="n">xl_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xl_df</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)),</span>
            <span class="p">])</span>
            <span class="n">combined_experiments_reindexed</span> <span class="o">=</span> <span class="n">reindex_duplicates</span><span class="p">(</span><span class="n">combined_experiments</span><span class="p">)</span>
            <span class="n">xl_df_</span> <span class="o">=</span> <span class="n">combined_experiments_reindexed</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">xl_df</span><span class="p">):]</span>
            <span class="n">novel_flag</span> <span class="o">=</span> <span class="n">xl_df_</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">novel_experiments</span> <span class="o">=</span> <span class="n">xl_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">novel_flag</span><span class="p">]</span>
            <span class="n">duplicate_experiments</span> <span class="o">=</span> <span class="n">xl_df_</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">novel_flag</span><span class="p">]</span>

            <span class="n">ex_ids</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">ex_id_as_input</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">novel_experiments</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">force_ids</span><span class="p">:</span>
                    <span class="c1"># create new experiment and set id</span>
                    <span class="n">fcur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">INSERT_EXPERIMENT_WITH_ID</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">ex_id_as_input</span><span class="p">])</span>
                    <span class="n">ex_id</span> <span class="o">=</span> <span class="n">ex_id_as_input</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># create new experiment and get id</span>
                    <span class="n">fcur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">INSERT_EXPERIMENT</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">])</span>
                    <span class="n">ex_id</span> <span class="o">=</span> <span class="n">fcur</span><span class="o">.</span><span class="n">lastrowid</span>
                <span class="c1"># set each from experiment defitinion</span>
                <span class="k">for</span> <span class="n">xl</span> <span class="ow">in</span> <span class="n">scp_xl</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">xl</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="n">fcur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">INSERT_EX_XL</span><span class="p">,</span> <span class="p">[</span><span class="n">ex_id</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">xl</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Experiment definition missing </span><span class="si">{</span><span class="n">xl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> variable&#39;</span><span class="p">)</span>
                        <span class="k">raise</span>

                <span class="c1"># Add this experiment id to this design</span>
                <span class="n">ex_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex_id</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">design_name_</span><span class="p">,</span> <span class="n">design_experiment_ids</span> <span class="ow">in</span> <span class="n">design_name_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">ex_id_as_input</span> <span class="ow">in</span> <span class="n">design_experiment_ids</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">fcur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">INSERT_DESIGN_EXPERIMENT</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">design_name_</span><span class="p">,</span> <span class="n">ex_id</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;scope_name, design_name, ex_id= </span><span class="si">{</span><span class="n">scope_name</span><span class="p">,</span><span class="w"> </span><span class="n">design_name_</span><span class="p">,</span><span class="w"> </span><span class="n">ex_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">raise</span>

            <span class="k">for</span> <span class="n">ex_id</span><span class="p">,</span> <span class="n">ex_id_as_input</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">duplicate_experiments</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">xl_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">novel_flag</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">force_ids</span> <span class="ow">and</span> <span class="n">ex_id</span> <span class="o">!=</span> <span class="n">ex_id_as_input</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cannot change experiment id </span><span class="si">{</span><span class="n">ex_id_as_input</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">ex_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Add this experiment id to this design</span>
                <span class="n">ex_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex_id</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">design_name_</span><span class="p">,</span> <span class="n">design_experiment_ids</span> <span class="ow">in</span> <span class="n">design_name_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">ex_id_as_input</span> <span class="ow">in</span> <span class="n">design_experiment_ids</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">fcur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">INSERT_DESIGN_EXPERIMENT</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">design_name_</span><span class="p">,</span> <span class="n">ex_id</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;scope_name, design_name, ex_id= </span><span class="si">{</span><span class="n">scope_name</span><span class="p">,</span><span class="w"> </span><span class="n">design_name_</span><span class="p">,</span><span class="w"> </span><span class="n">ex_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">raise</span>

            <span class="k">return</span> <span class="n">ex_ids</span></div>


<div class="viewcode-block" id="SQLiteDB.read_experiment_id">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.read_experiment_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_experiment_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the experiment id previously defined in the database</span>

<span class="sd">        Args:</span>
<span class="sd">            scope_name (str): scope name, used to identify experiments,</span>
<span class="sd">                performance measures, and results associated with this run</span>
<span class="sd">            parameters (dict): keys are experiment parameters, values are the</span>
<span class="sd">                experimental values to look up.  Subsequent positional or keyword</span>
<span class="sd">                arguments are used to update parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: the experiment id of the identified experiment</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If scope name does not exist</span>
<span class="sd">            ValueError: If multiple experiments match an experiment definition.</span>
<span class="sd">                This can happen, for example, if the definition is incomplete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="s1">&#39;design_name&#39;</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">xl_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_experiment_ids</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">xl_df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="SQLiteDB.get_experiment_id">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.get_experiment_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_experiment_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read or create an experiment id in the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            scope_name (str): scope name, used to identify experiments,</span>
<span class="sd">                performance measures, and results associated with this run</span>
<span class="sd">            parameters (dict): keys are experiment parameters, values are the</span>
<span class="sd">                experimental values to look up.  Subsequent positional or keyword</span>
<span class="sd">                arguments are used to update parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: the experiment id of the identified experiment</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If scope name does not exist</span>
<span class="sd">            ValueError: If multiple experiments match an experiment definition.</span>
<span class="sd">                This can happen, for example, if the definition is incomplete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="s1">&#39;design_name&#39;</span><span class="p">)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">...exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">MissingIdWarning</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">MissingIdWarning</span><span class="p">)</span>
            <span class="n">ex_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_experiment_id</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ex_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span><span class="o">.</span><span class="n">get_parameter_defaults</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ex_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_experiment_parameters</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">df</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ex_id</span></div>


<div class="viewcode-block" id="SQLiteDB.set_experiment_id">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.set_experiment_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_experiment_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">experiment_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set an experiment id in the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            scope_name (str): scope name, used to identify experiments,</span>
<span class="sd">                performance measures, and results associated with this run</span>
<span class="sd">            parameters (dict): keys are experiment parameters, values are the</span>
<span class="sd">                experimental values to look up.  Subsequent positional or keyword</span>
<span class="sd">                arguments are used to update parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: the experiment id of the identified experiment</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError:</span>
<span class="sd">                If scope name does not exist, or another experiments</span>
<span class="sd">                already has this id, or this experiment already has a</span>
<span class="sd">                different id.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="s1">&#39;design_name&#39;</span><span class="p">)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">...exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">MissingIdWarning</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">MissingIdWarning</span><span class="p">)</span>
            <span class="n">ex_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_experiment_id</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ex_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># check the id is not yet used</span>
            <span class="k">if</span> <span class="n">experiment_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_all_experiment_ids</span><span class="p">(</span><span class="n">scope_name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;experiment_id </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2"> already exists&quot;</span><span class="p">)</span>

            <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span><span class="o">.</span><span class="n">get_parameter_defaults</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ex_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_experiment_parameters</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">df</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ex_id</span> <span class="o">!=</span> <span class="n">experiment_id</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;these parameters already have experiment_id &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ex_id</span><span class="si">}</span><span class="s2">, cannot change to </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ex_id</span></div>


<div class="viewcode-block" id="SQLiteDB.new_run_id">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.new_run_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">new_run_id</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">scope_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">experiment_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="o">**</span><span class="n">extra_attrs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new run_id in the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            scope_name (str): scope name, used to identify experiments,</span>
<span class="sd">                performance measures, and results associated with this run</span>
<span class="sd">            parameters (dict): keys are experiment parameters, values are the</span>
<span class="sd">                experimental values to look up.  Subsequent positional or keyword</span>
<span class="sd">                arguments are used to update parameters.</span>
<span class="sd">            location (str or True, optional): An identifier for this location</span>
<span class="sd">                (i.e. this computer).  If set to True, the name of this node</span>
<span class="sd">                is found using the `platform` module.</span>
<span class="sd">            experiment_id (int, optional): The experiment id associated</span>
<span class="sd">                with this run.  If given, the parameters are ignored.</span>
<span class="sd">            source (int, default 0): The metamodel_id of the source for this</span>
<span class="sd">                run, or 0 for a core model run.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[Int,Int]:</span>
<span class="sd">                The run_id and experiment_id of the identified experiment</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If scope name does not exist</span>
<span class="sd">            ValueError: If multiple experiments match an experiment definition.</span>
<span class="sd">                This can happen, for example, if the definition is incomplete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ReadOnlyDatabaseError</span>
        <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="s1">&#39;design_name&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">experiment_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;must give experiment_id or parameters&#39;</span><span class="p">)</span>
            <span class="n">experiment_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_experiment_id</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
        <span class="n">run_id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">location</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">node</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">sq</span><span class="o">.</span><span class="n">NEW_EXPERIMENT_RUN</span><span class="p">,</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">run_id</span><span class="o">=</span><span class="n">run_id</span><span class="o">.</span><span class="n">bytes</span><span class="p">,</span>
                    <span class="n">experiment_id</span><span class="o">=</span><span class="n">experiment_id</span><span class="p">,</span>
                    <span class="n">run_location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
                    <span class="n">run_source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">experiment_id</span></div>


<div class="viewcode-block" id="SQLiteDB.existing_run_id">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.existing_run_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">existing_run_id</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">run_id</span><span class="p">,</span>
            <span class="n">scope_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">experiment_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Store an existing run_id in the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            run_id (bytes or UUID): run id to be stored</span>
<span class="sd">            scope_name (str): scope name, used to identify experiments,</span>
<span class="sd">                performance measures, and results associated with this run</span>
<span class="sd">            parameters (dict): keys are experiment parameters, values are the</span>
<span class="sd">                experimental values to look up.  Subsequent positional or keyword</span>
<span class="sd">                arguments are used to update parameters.</span>
<span class="sd">            location (str or True, optional): An identifier for this location</span>
<span class="sd">                (i.e. this computer).  If set to True, the name of this node</span>
<span class="sd">                is found using the `platform` module.</span>
<span class="sd">            experiment_id (int, optional): The experiment id associated</span>
<span class="sd">                with this run.  If given, the parameters are ignored.</span>
<span class="sd">            source (int, default 0): The metamodel_id of the source for this</span>
<span class="sd">                run, or 0 for a core model run.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[Int,Int]:</span>
<span class="sd">                The run_id and experiment_id of the identified experiment</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If scope name does not exist</span>
<span class="sd">            ValueError: If multiple experiments match an experiment definition.</span>
<span class="sd">                This can happen, for example, if the definition is incomplete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ReadOnlyDatabaseError</span>
        <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="s1">&#39;design_name&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">experiment_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;must give experiment_id or parameters&#39;</span><span class="p">)</span>
            <span class="n">experiment_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_experiment_id</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
        <span class="n">run_id</span> <span class="o">=</span> <span class="n">_to_uuid</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span><span class="o">.</span><span class="n">bytes</span>
        <span class="k">if</span> <span class="n">location</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">node</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">sq</span><span class="o">.</span><span class="n">NEW_EXPERIMENT_RUN</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;INSERT&quot;</span><span class="p">,</span> <span class="s2">&quot;INSERT OR IGNORE&quot;</span><span class="p">),</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">run_id</span><span class="o">=</span><span class="n">run_id</span><span class="p">,</span>
                    <span class="n">experiment_id</span><span class="o">=</span><span class="n">experiment_id</span><span class="p">,</span>
                    <span class="n">run_location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
                    <span class="n">run_source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">experiment_id</span></div>




<div class="viewcode-block" id="SQLiteDB.read_experiment_ids">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.read_experiment_ids">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_experiment_ids</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">scope_name</span><span class="p">,</span>
            <span class="n">xl_df</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the experiment ids previously defined in the database.</span>

<span class="sd">        This method is used to recover the experiment id, if the</span>
<span class="sd">        set of parameter values is known but the id of the experiment</span>
<span class="sd">        is not known.</span>

<span class="sd">        Args:</span>
<span class="sd">            scope_name (str): scope name, used to identify experiments,</span>
<span class="sd">                performance measures, and results associated with this run</span>
<span class="sd">            xl_df (pandas.DataFrame):</span>
<span class="sd">                The columns of this DataFrame are experiment parameters</span>
<span class="sd">                to lookup, and each row is a full experiment.  It is</span>
<span class="sd">                possible to include only a subset of the columns, and</span>
<span class="sd">                matches will be returned if that subset matches only one</span>
<span class="sd">                experiment.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: the experiment id&#39;s of the identified experiments</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If scope name does not exist</span>
<span class="sd">            ValueError: If multiple experiments match an experiment definition.</span>
<span class="sd">                This can happen, for example, if the definition is incomplete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># local cursor</span>
        <span class="n">fcur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">ex_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">missing_ids</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># get list of experiment variables - except &quot;one&quot;</span>
            <span class="n">scp_xl</span> <span class="o">=</span> <span class="n">fcur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_SCOPE_XL</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">])</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scp_xl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;named scope </span><span class="si">{0}</span><span class="s1"> not found - experiment ids </span><span class="se">\</span>
<span class="s1">                                      not available&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scope_name</span><span class="p">))</span>

            <span class="n">scp_xl</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">scp_xl</span><span class="p">]</span>
            <span class="n">use_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">xl_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">scp_xl</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">xl_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

                <span class="n">candidate_ids</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># get all ids by value</span>
                <span class="k">for</span> <span class="n">par_name</span><span class="p">,</span> <span class="n">par_value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xl_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">par_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">use_cols</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">possible_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fcur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="n">sq</span><span class="o">.</span><span class="n">GET_EXPERIMENT_IDS_BY_VALUE</span><span class="p">,</span>
                        <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">par_name</span><span class="p">,</span> <span class="n">par_value</span><span class="p">],</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()])</span>
                    <span class="k">if</span> <span class="n">candidate_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">candidate_ids</span> <span class="o">=</span> <span class="n">possible_ids</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">candidate_ids</span> <span class="o">&amp;=</span> <span class="n">possible_ids</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;multiple matching experiment ids found&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ex_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">candidate_ids</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">missing_ids</span> <span class="o">+=</span><span class="mi">1</span>
                    <span class="n">ex_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">fcur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">missing_ids</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">...exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">MissingIdWarning</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;missing </span><span class="si">{</span><span class="n">missing_ids</span><span class="si">}</span><span class="s1"> ids&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">MissingIdWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ex_ids</span></div>


<div class="viewcode-block" id="SQLiteDB.read_all_experiment_ids">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.read_all_experiment_ids">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_all_experiment_ids</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">scope_name</span><span class="p">,</span>
            <span class="n">design_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">grouped</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the experiment ids previously defined in the database</span>

<span class="sd">        Args:</span>
<span class="sd">            scope_name (str): scope name, used to identify experiments,</span>
<span class="sd">                performance measures, and results associated with this run</span>
<span class="sd">            design_name (str or None):</span>
<span class="sd">                Name of experiment design.  Set to None to find experiments</span>
<span class="sd">                across all designs in aggregate.  Set to &#39;*&#39; to get a</span>
<span class="sd">                dictionary giving the experiment ids in each design</span>
<span class="sd">                individually.</span>
<span class="sd">            grouped (bool, default False):</span>
<span class="sd">                The default return value is a list of all experiment id&#39;s,</span>
<span class="sd">                but by setting this to True, this method instead returns</span>
<span class="sd">                a human-readable string giving contiguous ranges of</span>
<span class="sd">                experiment id&#39;s.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list or dict or str: the experiment id&#39;s of the identified experiments</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If scope name does not exist</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">design_name</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">design_name_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_design_names</span><span class="p">(</span><span class="n">scope_name</span><span class="p">):</span>
                <span class="n">result</span><span class="p">[</span><span class="n">design_name_</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_all_experiment_ids</span><span class="p">(</span>
                    <span class="n">scope_name</span><span class="o">=</span><span class="n">scope_name</span><span class="p">,</span>
                    <span class="n">design_name</span><span class="o">=</span><span class="n">design_name_</span><span class="p">,</span>
                    <span class="n">grouped</span><span class="o">=</span><span class="n">grouped</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="s1">&#39;design_name&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">design_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">experiment_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_EXPERIMENT_IDS_ALL</span><span class="p">,</span>
                                                             <span class="p">[</span><span class="n">scope_name</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">experiment_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_EXPERIMENT_IDS_IN_DESIGN</span><span class="p">,</span>
                                                             <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">grouped</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">...util.seq_grouping</span><span class="w"> </span><span class="kn">import</span> <span class="n">seq_int_grouper</span>
            <span class="k">return</span> <span class="n">seq_int_grouper</span><span class="p">(</span><span class="n">experiment_ids</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">experiment_ids</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="p">,</span> <span class="n">design_parameter_name</span><span class="o">=</span><span class="s2">&quot;design_name&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate the scope argument to a function.&quot;&quot;&quot;</span>
        <span class="n">known_scopes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_scope_names</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">known_scopes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;there are no stored scopes&#39;</span><span class="p">)</span>

        <span class="c1"># None, but there is only one scope in the DB, so use it.</span>
        <span class="k">if</span> <span class="n">scope_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">scope_name</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">known_scopes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">known_scopes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;there are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">known_scopes</span><span class="p">)</span><span class="si">}</span><span class="s1"> scopes, must identify scope explicitly&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scope_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">known_scopes</span><span class="p">:</span>
            <span class="n">oops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_scope_names</span><span class="p">(</span><span class="n">design_name</span><span class="o">=</span><span class="n">scope_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">oops</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">design_parameter_name</span><span class="p">:</span>
                    <span class="n">des</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">design_parameter_name</span><span class="si">}</span><span class="s2">=&#39;</span><span class="si">{</span><span class="n">oops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">des</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;&#39;no scope named &quot;</span><span class="si">{</span><span class="n">scope_name</span><span class="si">}</span><span class="s1">&quot;, did you mean &#39;&#39;&#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;&#39;&#39;&quot;...(scope=&#39;</span><span class="si">{</span><span class="n">scope_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">des</span><span class="si">}</span><span class="s1">,...)&quot;?&#39;&#39;&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no scope named &quot;</span><span class="si">{</span><span class="n">scope_name</span><span class="si">}</span><span class="s1">&quot; is stored in the database, only </span><span class="si">{</span><span class="n">known_scopes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">scope_name</span>

<div class="viewcode-block" id="SQLiteDB.read_experiment_parameters">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.read_experiment_parameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_experiment_parameters</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">scope_name</span><span class="p">,</span>
            <span class="n">design_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">only_pending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">design</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">experiment_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">ensure_dtypes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read experiment definitions from the database.</span>

<span class="sd">        Read the values for each experiment parameter per experiment.</span>

<span class="sd">        Args:</span>
<span class="sd">            scope_name (str):</span>
<span class="sd">                A scope name, used to identify experiments,</span>
<span class="sd">                performance measures, and results associated with this</span>
<span class="sd">                exploratory analysis.</span>
<span class="sd">            design_name (str, optional): If given, only experiments</span>
<span class="sd">                associated with both the scope and the named design</span>
<span class="sd">                are returned, otherwise all experiments associated</span>
<span class="sd">                with the scope are returned.</span>
<span class="sd">            only_pending (bool, default False): If True, only pending</span>
<span class="sd">                experiments (which have no performance measure results</span>
<span class="sd">                stored in the database) are returned.</span>
<span class="sd">            design (str, optional): Deprecated.  Use design_name.</span>
<span class="sd">            experiment_ids (Collection, optional):</span>
<span class="sd">                A collection of experiment id&#39;s to load.  If given,</span>
<span class="sd">                both `design_name` and `only_pending` are ignored.</span>
<span class="sd">            ensure_dtypes (bool, default True): If True, the scope</span>
<span class="sd">                associated with these experiments is also read out</span>
<span class="sd">                of the database, and that scope file is used to</span>
<span class="sd">                format experimental data consistently (i.e., as</span>
<span class="sd">                float, integer, bool, or categorical).</span>

<span class="sd">        Returns:</span>
<span class="sd">            emat.ExperimentalDesign:</span>
<span class="sd">                The experiment parameters are returned in a subclass</span>
<span class="sd">                of a normal pandas.DataFrame, which allows attaching</span>
<span class="sd">                the `design_name` as meta-data to the DataFrame.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: if `scope_name` is not stored in this database</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">design</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">design_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">design_name</span> <span class="o">=</span> <span class="n">design</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;the `design` argument is deprecated for &quot;</span>
                              <span class="s2">&quot;read_experiment_parameters, use `design_name`&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">design</span> <span class="o">!=</span> <span class="n">design_name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cannot give both `design_name` and `design`&quot;</span><span class="p">)</span>

        <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="s1">&#39;design_name&#39;</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">experiment_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">GET_EX_XL_IDS_IN</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">experiment_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">experiment_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">experiment_ids</span><span class="p">]</span>
            <span class="n">subquery</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;?</span><span class="si">{</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">experiment_ids</span><span class="p">)))</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;???&quot;</span><span class="p">,</span> <span class="n">subquery</span><span class="p">)</span>
            <span class="n">bindings</span> <span class="o">=</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="o">*</span><span class="n">experiment_ids</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">design_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">GET_EX_XL_ALL</span>
            <span class="n">bindings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">scope_name</span><span class="o">=</span><span class="n">scope_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">GET_EXPERIMENT_PARAMETERS</span>
            <span class="n">bindings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">scope_name</span><span class="o">=</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">design_name</span><span class="o">=</span><span class="n">design_name</span><span class="p">)</span>
        <span class="n">xl_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">query</span><span class="p">,</span>
            <span class="n">bindings</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">xl_df</span><span class="o">.</span><span class="n">empty</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">xl_df</span> <span class="o">=</span> <span class="n">xl_df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">xl_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;experiment&#39;</span>
        <span class="n">xl_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">column_order</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_constants</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_uncertainties</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_levers</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">...experiment.experimental_design</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExperimentalDesign</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ExperimentalDesign</span><span class="p">(</span><span class="n">xl_df</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">column_order</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xl_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]])</span>
        <span class="n">result</span><span class="o">.</span><span class="n">design_name</span> <span class="o">=</span> <span class="n">design_name</span>
        <span class="k">if</span> <span class="n">ensure_dtypes</span><span class="p">:</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">ensure_dtypes</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">only_pending</span><span class="p">:</span>
            <span class="n">valid_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_experiment_measures</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">valid_ex_ids</span> <span class="o">=</span> <span class="n">valid_results</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">result</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">valid_ex_ids</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="SQLiteDB.write_experiment_measures">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.write_experiment_measures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_experiment_measures</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">scope_name</span><span class="p">,</span>
            <span class="n">source</span><span class="p">,</span>
            <span class="n">m_df</span><span class="p">,</span>
            <span class="n">run_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">experiment_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write experiment results to the database.</span>

<span class="sd">        Write the performance measure results for each experiment</span>
<span class="sd">        in the scope - if the scope does not exist, nothing is recorded.</span>

<span class="sd">        Note that the design_name is not required to write experiment</span>
<span class="sd">        measures, as the individual experiments from any design are</span>
<span class="sd">        uniquely identified by the experiment id&#39;s.</span>

<span class="sd">        Args:</span>
<span class="sd">            scope_name (str):</span>
<span class="sd">                A scope name, used to identify experiments,</span>
<span class="sd">                performance measures, and results associated with this</span>
<span class="sd">                exploratory analysis. The scope with this name should</span>
<span class="sd">                already have been stored in this database.</span>
<span class="sd">            source (int):</span>
<span class="sd">                An indicator of performance measure source. This should</span>
<span class="sd">                be 0 for a bona-fide run of the associated core models,</span>
<span class="sd">                or some non-zero metamodel_id number.</span>
<span class="sd">            m_df (pandas.DataFrame or dict):</span>
<span class="sd">                The columns of this DataFrame are the performance</span>
<span class="sd">                measure names, and row indexes are the experiment id&#39;s.</span>
<span class="sd">                If given as a `dict` instead of a DataFrame, the keys are</span>
<span class="sd">                treated as columns and an `experiment_id` must be provided.</span>
<span class="sd">            run_ids (pandas.Index, optional):</span>
<span class="sd">                Provide an optional index of universally unique run ids</span>
<span class="sd">                (UUIDs) for these results. The UUIDs can be used to help</span>
<span class="sd">                identify problems and organize model runs.</span>
<span class="sd">            experiment_id (int, optional):</span>
<span class="sd">                Provide an experiment_id.  This is only used if the</span>
<span class="sd">                `m_df` is provided as a dict instead of a DataFrame</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserWarning: If scope name does not exist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ReadOnlyDatabaseError</span>
        <span class="k">if</span> <span class="n">experiment_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m_df</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;only give an experiment_id with a dict as `m_df`&quot;</span><span class="p">)</span>
            <span class="n">m_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">m_df</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">experiment_id</span><span class="p">])</span>

        <span class="c1"># split run_ids from multiindex</span>
        <span class="k">if</span> <span class="n">m_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">nlevels</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">run_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;run_ids cannot be given when they are embedded in m_df.index&#39;</span><span class="p">)</span>
            <span class="n">run_ids</span> <span class="o">=</span> <span class="n">m_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">m_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">m_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>

            <span class="n">scope</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># don&#39;t load unless needed</span>

            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">scp_m</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_SCOPE_M</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">])</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scp_m</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">UserWarning</span><span class="p">(</span><span class="s1">&#39;named scope </span><span class="si">{0}</span><span class="s1"> not found - experiments will </span><span class="se">\</span>
<span class="s1">                                      not be recorded&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scope_name</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">run_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># generate new run_ids if none is given</span>
                <span class="n">run_ids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">experiment_id</span> <span class="ow">in</span> <span class="n">m_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="n">run_id</span><span class="p">,</span> <span class="n">experiment_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_run_id</span><span class="p">(</span>
                        <span class="n">scope_name</span><span class="p">,</span>
                        <span class="n">experiment_id</span><span class="o">=</span><span class="n">experiment_id</span><span class="p">,</span>
                        <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">run_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">experiment_id</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">run_ids</span><span class="p">,</span> <span class="n">m_df</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">existing_run_id</span><span class="p">(</span>
                        <span class="n">run_id</span><span class="p">,</span>
                        <span class="n">scope_name</span><span class="p">,</span>
                        <span class="n">experiment_id</span><span class="o">=</span><span class="n">experiment_id</span><span class="p">,</span>
                        <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">scp_m</span><span class="p">:</span>
                <span class="n">dataseries</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">measure_name</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">measure_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">m_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">scope</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>
                    <span class="n">formula</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">scope</span><span class="p">[</span><span class="n">measure_name</span><span class="p">],</span> <span class="s1">&#39;formula&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">formula</span><span class="p">:</span>
                        <span class="n">dataseries</span> <span class="o">=</span> <span class="n">m_df</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">measure_name</span> <span class="ow">in</span> <span class="n">m_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">dataseries</span> <span class="o">=</span> <span class="n">m_df</span><span class="p">[</span><span class="n">measure_name</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">dataseries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">ex_id</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span> <span class="n">uid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dataseries</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(),</span><span class="n">run_ids</span><span class="p">):</span>
                        <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;write_experiment_measures: writing </span><span class="si">{</span><span class="n">measure_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">ex_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">uid</span> <span class="o">=</span> <span class="n">_to_uuid</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
                        <span class="c1"># index is experiment id</span>
                        <span class="n">bindings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                            <span class="n">experiment_id</span><span class="o">=</span><span class="n">ex_id</span><span class="p">,</span>
                            <span class="n">measure_value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">measure_source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
                            <span class="n">measure_name</span><span class="o">=</span><span class="n">measure_name</span><span class="p">,</span>
                            <span class="n">measure_run</span><span class="o">=</span><span class="n">uid</span><span class="o">.</span><span class="n">bytes</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">INSERT_EX_M</span><span class="p">,</span> <span class="n">bindings</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> to m </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> for ex </span><span class="si">{</span><span class="n">ex_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">binding</span><span class="p">,</span> <span class="n">bval</span> <span class="ow">in</span> <span class="n">bindings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bindings[</span><span class="si">{</span><span class="n">binding</span><span class="si">}</span><span class="s2">]=</span><span class="si">{</span><span class="n">bval</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">bval</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">_DEBUG_INSERT_EX_M</span><span class="p">,</span> <span class="n">bindings</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()))</span>
                            <span class="k">raise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;write_experiment_measures: no dataseries for </span><span class="si">{</span><span class="n">measure_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SQLiteDB.write_ex_m_1">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.write_ex_m_1">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_ex_m_1</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">scope_name</span><span class="p">,</span>
            <span class="n">source</span><span class="p">,</span>
            <span class="n">ex_id</span><span class="p">,</span>
            <span class="n">m_name</span><span class="p">,</span>
            <span class="n">m_value</span><span class="p">,</span>
            <span class="n">run_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write a single performance measure result for an experiment</span>

<span class="sd">        Write the performance measure result for an experiment</span>
<span class="sd">        in the scope - if the scope does not exist, nothing is recorded</span>

<span class="sd">        Args:</span>
<span class="sd">            scope_name (str): scope name, used to identify experiments,</span>
<span class="sd">                performance measures, and results associated with this run</span>
<span class="sd">            source (int): indicator of performance measure source</span>
<span class="sd">                (0 = core model or non-zero = meta-model id)</span>
<span class="sd">            ex_id (int): experiment id</span>
<span class="sd">            m_name (str): performance measure name</span>
<span class="sd">            m_value (numeric): performance measure value</span>
<span class="sd">            run_ids (uuid, optional):</span>
<span class="sd">                Provide an optional universally unique run id</span>
<span class="sd">                (UUID) for these results. The UUID can be used to help</span>
<span class="sd">                identify problems and organize model runs.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserWarning: If scope name does not exist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ReadOnlyDatabaseError</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">scp_m</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_SCOPE_M</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">])</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scp_m</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">UserWarning</span><span class="p">(</span><span class="s1">&#39;named scope </span><span class="si">{0}</span><span class="s1"> not found - experiments will </span><span class="se">\</span>
<span class="s1">                                      not be recorded&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scope_name</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">scp_m</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">m_name</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                                <span class="n">sq</span><span class="o">.</span><span class="n">INSERT_EX_M</span><span class="p">,</span>
                                <span class="nb">dict</span><span class="p">(</span>
                                    <span class="n">experiment_id</span><span class="o">=</span><span class="n">ex_id</span><span class="p">,</span>
                                    <span class="n">measure_value</span><span class="o">=</span><span class="n">m_value</span><span class="p">,</span>
                                    <span class="n">measure_source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
                                    <span class="n">measure_name</span><span class="o">=</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="n">measure_run</span><span class="o">=</span><span class="n">run_id</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving </span><span class="si">{</span><span class="n">m_value</span><span class="si">}</span><span class="s2"> to m </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> for ex </span><span class="si">{</span><span class="n">ex_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">raise</span></div>


<div class="viewcode-block" id="SQLiteDB.read_experiment_all">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.read_experiment_all">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_experiment_all</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">scope_name</span><span class="p">,</span>
            <span class="n">design_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">only_pending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">only_incomplete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">only_complete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">only_with_measures</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">ensure_dtypes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">with_run_ids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">runs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">formulas</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read experiment definitions and results</span>

<span class="sd">        Read the values from each experiment variable and the</span>
<span class="sd">        results for each performance measure per experiment.</span>

<span class="sd">        Args:</span>
<span class="sd">            scope_name (str or Scope):</span>
<span class="sd">                A scope name, used to identify experiments,</span>
<span class="sd">                performance measures, and results associated with this</span>
<span class="sd">                exploratory analysis.</span>
<span class="sd">            design_name (str or Collection[str], optional):</span>
<span class="sd">                The experimental design name (a single `str`) or</span>
<span class="sd">                a collection of design names to read.</span>
<span class="sd">            source (int, optional): The source identifier of the</span>
<span class="sd">                experimental outcomes to load.  If not given, but</span>
<span class="sd">                there are only results from a single source in the</span>
<span class="sd">                database, those results are returned.  If there are</span>
<span class="sd">                results from multiple sources, an error is raised.</span>
<span class="sd">            only_pending (bool, default False): If True, only pending</span>
<span class="sd">                experiments (which have no performance measure results</span>
<span class="sd">                stored in the database) are returned. Experiments that</span>
<span class="sd">                have any results, even if only partial results, are</span>
<span class="sd">                excluded.</span>
<span class="sd">            only_incomplete (bool, default False): If True, only incomplete</span>
<span class="sd">                experiments (which have at least one missing performance</span>
<span class="sd">                measure result that is not stored in the database) are</span>
<span class="sd">                returned.  Only complete experiments (that have every</span>
<span class="sd">                performance measure populated) are excluded.</span>
<span class="sd">            only_complete (bool, default False): If True, only complete</span>
<span class="sd">                experiments (which have no missing performance measure</span>
<span class="sd">                results stored in the database) are returned.</span>
<span class="sd">            only_with_measures (bool, default False): If True, only</span>
<span class="sd">                experiments with at least one stored performance measure</span>
<span class="sd">                are returned.</span>
<span class="sd">            ensure_dtypes (bool, default True): If True, the scope</span>
<span class="sd">                associated with these experiments is also read out</span>
<span class="sd">                of the database, and that scope file is used to</span>
<span class="sd">                format experimental data consistently (i.e., as</span>
<span class="sd">                float, integer, bool, or categorical).</span>
<span class="sd">            with_run_ids (bool, default False): Whether to use a</span>
<span class="sd">                two-level pd.MultiIndex that includes both the</span>
<span class="sd">                experiment_id (which always appears in the index)</span>
<span class="sd">                as well as the run_id (which only appears in the</span>
<span class="sd">                index if this argument is set to True).</span>
<span class="sd">            runs ({None, &#39;all&#39;, &#39;valid&#39;, &#39;invalid&#39;}, default None):</span>
<span class="sd">                By default, this method returns the one and only</span>
<span class="sd">                valid model run matching the given `design_name`</span>
<span class="sd">                and `source` (if any) for any experiment, and fails</span>
<span class="sd">                if there is more than one such valid run. Set this to</span>
<span class="sd">                &#39;valid&#39; or &#39;invalid&#39; to get all valid or invalid model</span>
<span class="sd">                runs (instead of raising an exception). Set to &#39;all&#39; to get</span>
<span class="sd">                everything, including both valid and invalidated results.</span>
<span class="sd">            formulas (bool, default True): If the scope includes</span>
<span class="sd">                formulaic measures (computed directly from other</span>
<span class="sd">                measures) then compute these values and include them in</span>
<span class="sd">                the results.</span>

<span class="sd">        Returns:</span>
<span class="sd">            emat.ExperimentalDesign:</span>
<span class="sd">                The experiment parameters are returned in a subclass</span>
<span class="sd">                of a normal pandas.DataFrame, which allows attaching</span>
<span class="sd">                the `design_name` as meta-data to the DataFrame.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError</span>
<span class="sd">                When no source is given but the database contains</span>
<span class="sd">                results from multiple sources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">...scope.scope</span><span class="w"> </span><span class="kn">import</span> <span class="n">Scope</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">Scope</span><span class="p">):</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="n">scope_name</span>
            <span class="n">scope_name</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">df_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_experiment_parameters</span><span class="p">(</span>
            <span class="n">scope_name</span><span class="o">=</span><span class="n">scope_name</span><span class="p">,</span>
            <span class="n">design_name</span><span class="o">=</span><span class="n">design_name</span><span class="p">,</span>
            <span class="n">ensure_dtypes</span><span class="o">=</span><span class="n">ensure_dtypes</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">df_m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_experiment_measures</span><span class="p">(</span>
            <span class="n">scope_name</span><span class="o">=</span><span class="n">scope</span> <span class="ow">or</span> <span class="n">scope_name</span><span class="p">,</span>
            <span class="n">design_name</span><span class="o">=</span><span class="n">design_name</span><span class="p">,</span>
            <span class="n">runs</span><span class="o">=</span><span class="n">runs</span><span class="p">,</span>
            <span class="n">formulas</span><span class="o">=</span><span class="n">formulas</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ex_xlm</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">df_p</span><span class="p">,</span>
            <span class="n">df_m</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;experiment&#39;</span><span class="p">),</span>
            <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="s1">&#39;experiment&#39;</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">runs</span> <span class="o">==</span> <span class="s1">&#39;valid_mean&#39;</span><span class="p">:</span>
            <span class="n">ex_xlm</span> <span class="o">=</span> <span class="n">ex_xlm</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;experiment&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ex_xlm</span> <span class="o">=</span> <span class="n">ex_xlm</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;experiment&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">with_run_ids</span><span class="p">:</span>
                <span class="n">ex_xlm</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ex_xlm</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">only_incomplete</span><span class="p">:</span>
            <span class="n">retain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ex_xlm</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">meas_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_measures</span><span class="p">(</span><span class="n">scope_name</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">meas_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ex_xlm</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">retain</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">retain</span><span class="p">[:]</span> <span class="o">|=</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">ex_xlm</span><span class="p">[</span><span class="n">meas_name</span><span class="p">])</span>
            <span class="n">ex_xlm</span> <span class="o">=</span> <span class="n">ex_xlm</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">retain</span><span class="p">,</span> <span class="p">:]</span>

        <span class="k">if</span> <span class="n">scope</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">column_order</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_constants</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_uncertainties</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_levers</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_measures</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">column_order</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">scope</span><span class="o">.</span><span class="n">get_constant_names</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">scope</span><span class="o">.</span><span class="n">get_uncertainty_names</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">scope</span><span class="o">.</span><span class="n">get_lever_names</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">scope</span><span class="o">.</span><span class="n">get_measure_names</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ex_xlm</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">column_order</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ex_xlm</span><span class="o">.</span><span class="n">columns</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">only_complete</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="o">~</span><span class="n">result</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="n">only_incomplete</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">only_with_measures</span><span class="p">:</span>
            <span class="n">result_measures</span> <span class="o">=</span> <span class="n">result</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_measures</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">]]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="o">~</span><span class="n">result_measures</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="n">only_pending</span><span class="p">:</span>
            <span class="n">result_measures</span> <span class="o">=</span> <span class="n">result</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_measures</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">]]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">result_measures</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">ensure_dtypes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scope</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">ensure_dtypes</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">...experiment.experimental_design</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExperimentalDesign</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ExperimentalDesign</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">design_name</span> <span class="o">=</span> <span class="n">design_name</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="SQLiteDB.read_experiment_measures">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.read_experiment_measures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_experiment_measures</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">scope_name</span><span class="p">,</span>
            <span class="n">design_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">experiment_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">design</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">runs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">formulas</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">with_validity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read experiment results from the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            scope_name (str or Scope):</span>
<span class="sd">                A scope or just its name, used to identify experiments,</span>
<span class="sd">                performance measures, and results associated with this</span>
<span class="sd">                exploratory analysis.</span>
<span class="sd">            design_name (str, optional): If given, only experiments</span>
<span class="sd">                associated with both the scope and the named design</span>
<span class="sd">                are returned, otherwise all experiments associated</span>
<span class="sd">                with the scope are returned.</span>
<span class="sd">            experiment_id (int, optional): The id of the experiment to</span>
<span class="sd">                retrieve.  If omitted, get all experiments matching the</span>
<span class="sd">                named scope and design.</span>
<span class="sd">            source (int, optional): The source identifier of the</span>
<span class="sd">                experimental outcomes to load.  If not given, but</span>
<span class="sd">                there are only results from a single source in the</span>
<span class="sd">                database, those results are returned.  If there are</span>
<span class="sd">                results from multiple sources, an error is raised.</span>
<span class="sd">            design (str): Deprecated, use `design_name`.</span>
<span class="sd">            runs ({None, &#39;all&#39;, &#39;valid&#39;, &#39;invalid&#39;, &#39;valid_mean&#39;}, default None):</span>
<span class="sd">                By default, this method returns the most recent timestamped</span>
<span class="sd">                valid model run matching the given `design_name`</span>
<span class="sd">                and `source` (if any) for any experiment. Set this to</span>
<span class="sd">                &#39;valid&#39; or &#39;invalid&#39; to get all valid or invalid model</span>
<span class="sd">                runs (instead of raising an exception). Set to &#39;all&#39; to get</span>
<span class="sd">                everything, including both valid and invalidated results.</span>
<span class="sd">                Set to &#39;valid_mean&#39; to get the average of all valid runs</span>
<span class="sd">                instead of the single most recent one.</span>
<span class="sd">            formulas (bool, default True): If the scope includes</span>
<span class="sd">                formulaic measures (computed directly from other</span>
<span class="sd">                measures) then compute these values and include them in</span>
<span class="sd">                the results.</span>

<span class="sd">        Returns:</span>
<span class="sd">            results (pandas.DataFrame): performance measures</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError</span>
<span class="sd">                When the database contains multiple sets of results</span>
<span class="sd">                matching the given `design_name` and/or `source`</span>
<span class="sd">                (if any) for any experiment.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="n">runs</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="s1">&#39;invalid&#39;</span><span class="p">,</span> <span class="s1">&#39;valid_mean&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">design</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">design_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">design_name</span> <span class="o">=</span> <span class="n">design</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;the `design` argument is deprecated for &quot;</span>
                              <span class="s2">&quot;read_experiment_parameters, use `design_name`&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">design</span> <span class="o">!=</span> <span class="n">design_name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cannot give both `design_name` and `design`&quot;</span><span class="p">)</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">...scope.scope</span><span class="w"> </span><span class="kn">import</span> <span class="n">Scope</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">Scope</span><span class="p">):</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="n">scope_name</span>
            <span class="n">scope_name</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="s1">&#39;design_name&#39;</span><span class="p">)</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">GET_EXPERIMENT_MEASURES_MASTER</span>

        <span class="k">if</span> <span class="n">design_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;AND ed.design = @design_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;AND run_source = @measure_source&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">experiment_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;AND eem.experiment_id = @experiment_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">runs</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="p">):</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;AND run_valid = 1&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">runs</span> <span class="o">==</span> <span class="s1">&#39;invalid&#39;</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;AND run_valid = 1&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;AND run_valid = 0&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">runs</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="s1">&#39;invalid&#39;</span><span class="p">,</span> <span class="s1">&#39;valid_mean&#39;</span><span class="p">):</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
                <span class="sa">r</span><span class="s2">&quot;/\* most recent .* end most recent \*/&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ema_experiment_run&quot;</span><span class="p">,</span>
                <span class="n">sql</span><span class="p">,</span>
                <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span>
            <span class="p">)</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">scope_name</span><span class="o">=</span><span class="n">scope_name</span><span class="p">,</span>
            <span class="n">design_name</span><span class="o">=</span><span class="n">design_name</span><span class="p">,</span>
            <span class="n">experiment_id</span><span class="o">=</span><span class="n">experiment_id</span><span class="p">,</span>
            <span class="n">measure_source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ex_m</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR ON READ MEASURES query=</span><span class="se">\n</span><span class="si">{</span><span class="n">sql</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR ON READ MEASURES arg=</span><span class="se">\n</span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">if</span> <span class="n">ex_m</span><span class="o">.</span><span class="n">empty</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">runs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># by default, raise a value error if there are runs from multiple sources</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ex_m</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;duplicate experiment ids suggest results &quot;</span>
                                     <span class="s2">&quot;from more than one model source are stored</span><span class="se">\n</span><span class="s2">&quot;</span>
                                     <span class="s2">&quot;set `runs=&#39;valid&#39;` to return results from all &quot;</span>
                                     <span class="s2">&quot;sources or set the `source` argument.&quot;</span><span class="p">)</span>
            <span class="n">ex_m</span> <span class="o">=</span> <span class="n">ex_m</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ex_m</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
            <span class="n">fix_levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">_to_uuid</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ex_m</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">zero_uuid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">zero_index</span> <span class="o">=</span> <span class="n">fix_levels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">zero_uuid</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">zero_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fix_levels</span><span class="p">)</span>
                <span class="n">fix_levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zero_uuid</span><span class="p">)</span> <span class="c1"># add a zero level</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fix_levels</span><span class="p">):</span>
                <span class="n">ex_m</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ex_m</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">set_levels</span><span class="p">(</span><span class="n">fix_levels</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">fix_codes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ex_m</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">codes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">fix_codes</span><span class="p">[</span><span class="n">fix_codes</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_index</span>
            <span class="n">ex_m</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ex_m</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">set_codes</span><span class="p">(</span><span class="n">fix_codes</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ex_m</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ex_m</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ex_m</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">(</span>
                <span class="n">levels</span><span class="o">=</span><span class="p">[[],[]],</span>
                <span class="n">codes</span><span class="o">=</span><span class="p">[[],[]],</span>
                <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="n">ex_m</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">formulas</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scope</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">measure</span> <span class="ow">in</span> <span class="n">scope</span><span class="o">.</span><span class="n">get_measures</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">measure</span><span class="p">,</span> <span class="s1">&#39;formula&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">ex_m</span><span class="p">[</span><span class="n">measure</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ex_m</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">measure</span><span class="o">.</span><span class="n">formula</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scope</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">column_order</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_measures</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">column_order</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">get_measure_names</span><span class="p">()</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">ex_m</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">column_order</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ex_m</span><span class="o">.</span><span class="n">columns</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">runs</span> <span class="o">==</span> <span class="s1">&#39;valid_mean&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;experiment&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="SQLiteDB.read_experiment_measure_sources">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.read_experiment_measure_sources">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_experiment_measure_sources</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">scope_name</span><span class="p">,</span>
            <span class="n">design_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">experiment_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">design</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read all source ids from the results stored in the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            scope_name (str):</span>
<span class="sd">                A scope name, used to identify experiments,</span>
<span class="sd">                performance measures, and results associated with this</span>
<span class="sd">                exploratory analysis.</span>
<span class="sd">            design_name (str, optional): If given, only experiments</span>
<span class="sd">                associated with both the scope and the named design</span>
<span class="sd">                are returned, otherwise all experiments associated</span>
<span class="sd">                with the scope are returned.</span>
<span class="sd">            experiment_id (int, optional): The id of the experiment to</span>
<span class="sd">                retrieve.  If omitted, get all experiments matching the</span>
<span class="sd">                named scope and design.</span>
<span class="sd">            design (str): Deprecated, use `design_name`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Int]: performance measure source ids</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">design</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">design_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">design_name</span> <span class="o">=</span> <span class="n">design</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;the `design` argument is deprecated for &quot;</span>
                              <span class="s2">&quot;read_experiment_parameters, use `design_name`&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">design</span> <span class="o">!=</span> <span class="n">design_name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cannot give both `design_name` and `design`&quot;</span><span class="p">)</span>

        <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="s1">&#39;design_name&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">design_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">GET_EXPERIMENT_MEASURE_SOURCES</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scope_name&#39;</span><span class="p">:</span><span class="n">scope_name</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">experiment_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; AND eem.experiment_id = @experiment_id&quot;</span>
                <span class="n">arg</span><span class="p">[</span><span class="s1">&#39;experiment_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">experiment_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">GET_EXPERIMENT_MEASURE_SOURCES_BY_DESIGN</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scope_name&#39;</span><span class="p">:</span> <span class="n">scope_name</span><span class="p">,</span> <span class="s1">&#39;design_name&#39;</span><span class="p">:</span><span class="n">design_name</span><span class="p">,</span> <span class="p">}</span>
            <span class="k">if</span> <span class="n">experiment_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; AND eem.experiment_id = @experiment_id&quot;</span>
                <span class="n">arg</span><span class="p">[</span><span class="s1">&#39;experiment_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">experiment_id</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span></div>


<div class="viewcode-block" id="SQLiteDB.delete_experiments">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.delete_experiments">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_experiments</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">scope_name</span><span class="p">,</span>
            <span class="n">design_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">design</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete experiment definitions and results.</span>

<span class="sd">        The method removes the linkage between experiments and the</span>
<span class="sd">        identified experimental design.  Experiment parameters and results</span>
<span class="sd">        are only removed if they are also not linked to any other experimental</span>
<span class="sd">        design stored in the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            scope_name (str): scope name, used to identify experiments,</span>
<span class="sd">                performance measures, and results associated with this run</span>
<span class="sd">            design_name (str): Only experiments</span>
<span class="sd">                associated with both the scope and the named design</span>
<span class="sd">                are deleted.</span>
<span class="sd">            design (str): Deprecated, use `design_name`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ReadOnlyDatabaseError</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">design</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">design_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">design_name</span> <span class="o">=</span> <span class="n">design</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;the `design` argument is deprecated for &quot;</span>
                                  <span class="s2">&quot;read_experiment_parameters, use `design_name`&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">design</span> <span class="o">!=</span> <span class="n">design_name</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cannot give both `design_name` and `design`&quot;</span><span class="p">)</span>
            <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="s1">&#39;design_name&#39;</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">DELETE_DESIGN_EXPERIMENTS</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">])</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">DELETE_LOOSE_EXPERIMENTS</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">,])</span></div>


<div class="viewcode-block" id="SQLiteDB.delete_experiment_measures">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.delete_experiment_measures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_experiment_measures</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">run_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete experiment performance measure results.</span>

<span class="sd">        The method removes only the performance measures, not the</span>
<span class="sd">        parameters.  This can be useful if a set of corrupted model</span>
<span class="sd">        results was stored in the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            run_ids (Collection, optional):</span>
<span class="sd">                A collection of run_id&#39;s for which measures shall</span>
<span class="sd">                be deleted.  Note that no scope or design are given here,</span>
<span class="sd">                experiments must be individually identified.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ReadOnlyDatabaseError</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">run_ids</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">):</span>
            <span class="n">run_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">run_ids</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">run_ids</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="n">run_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">_to_uuid</span><span class="p">(</span><span class="n">run_ids</span><span class="p">)]</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">run_id</span> <span class="ow">in</span> <span class="n">run_ids</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">_to_uuid</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span><span class="o">.</span><span class="n">bytes</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cannot interpret run_id &quot;</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">sq</span><span class="o">.</span><span class="n">DELETE_RUN_ID</span><span class="p">,</span>
                    <span class="nb">dict</span><span class="p">(</span><span class="n">run_id</span><span class="o">=</span><span class="n">b</span><span class="p">),</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="SQLiteDB.invalidate_experiment_runs">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.invalidate_experiment_runs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">invalidate_experiment_runs</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">run_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">queries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invalidate experiment performance measure results.</span>

<span class="sd">        The method marks the performance measures as invalid, not the</span>
<span class="sd">        parameters.  It does not actually remove any data from the model.</span>
<span class="sd">        This can be useful if a set of corrupted model results was stored</span>
<span class="sd">        in the database, to be able to ignore them in analysis but also</span>
<span class="sd">        keep tabs on the results and know if they are attempted to be</span>
<span class="sd">        stored again.</span>

<span class="sd">        Args:</span>
<span class="sd">            run_ids (Collection, optional):</span>
<span class="sd">                A collection of run_id&#39;s for which measures shall</span>
<span class="sd">                be deleted.  Note that no scope or design are given here,</span>
<span class="sd">                experiments must be individually identified.</span>
<span class="sd">            run_ids (Collection[str], optional):</span>
<span class="sd">                A collection of query commands that will select invalid</span>
<span class="sd">                experiment runs.  The queries are run against a DataFrame</span>
<span class="sd">                of parameters and measures.</span>

<span class="sd">        Returns:</span>
<span class="sd">            n_runs_invalidated (int or list):</span>
<span class="sd">                The number of runs that were actually invalidated in the</span>
<span class="sd">                database (total, if run_ids is given, otherwise per query)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">queries</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">run_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;must give run_ids or queries&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">queries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">run_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;must give run_ids or queries, not both&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">queries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_runs_invalidated</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">scope_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;scope_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;with_run_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;runs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;valid&#39;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">queries</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">queries</span> <span class="o">=</span> <span class="p">[</span><span class="n">queries</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
                <span class="n">bad_runs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_experiment_all</span><span class="p">(</span>
                    <span class="n">scope_name</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">bad_runs</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">n_runs_invalidated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">invalidate_experiment_runs</span><span class="p">(</span><span class="n">bad_runs</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">n_runs_invalidated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">n_runs_invalidated</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ReadOnlyDatabaseError</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">run_ids</span><span class="p">,</span> <span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="n">run_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">_to_uuid</span><span class="p">(</span><span class="n">run_ids</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">run_ids</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">)</span> <span class="ow">and</span> <span class="n">run_ids</span><span class="o">.</span><span class="n">nlevels</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">run_ids</span> <span class="o">=</span> <span class="n">run_ids</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">run_ids</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="n">run_ids</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">nlevels</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">run_ids</span> <span class="o">=</span> <span class="n">run_ids</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">run_ids</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="ow">and</span> <span class="n">run_ids</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">nlevels</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">run_ids</span><span class="o">.</span><span class="n">dtype</span><span class="o">==</span><span class="nb">bool</span><span class="p">:</span>
            <span class="n">run_ids</span> <span class="o">=</span> <span class="n">run_ids</span><span class="p">[</span><span class="n">run_ids</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">n_runs_invalidated</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">run_id</span> <span class="ow">in</span> <span class="n">run_ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">_to_uuid</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span><span class="o">.</span><span class="n">bytes</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error run_id type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">sq</span><span class="o">.</span><span class="n">INVALIDATE_RUN_ID</span><span class="p">,</span>
                    <span class="nb">dict</span><span class="p">(</span><span class="n">run_id</span><span class="o">=</span><span class="n">b</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">n_runs_invalidated</span> <span class="o">+=</span> <span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span>
        <span class="k">return</span> <span class="n">n_runs_invalidated</span></div>


<div class="viewcode-block" id="SQLiteDB.write_experiment_all">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.write_experiment_all">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_experiment_all</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">scope_name</span><span class="p">,</span>
            <span class="n">design_name</span><span class="p">,</span>
            <span class="n">source</span><span class="p">,</span>
            <span class="n">xlm_df</span><span class="p">,</span>
            <span class="n">run_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write experiment definitions and results</span>

<span class="sd">        Writes the values from each experiment variable and the</span>
<span class="sd">        results for each performance measure per experiment</span>

<span class="sd">        Args:</span>
<span class="sd">            scope_name (str):</span>
<span class="sd">                A scope name, used to identify experiments,</span>
<span class="sd">                performance measures, and results associated with this</span>
<span class="sd">                exploratory analysis. The scope with this name should</span>
<span class="sd">                already have been stored in this database.</span>
<span class="sd">            design_name (str or dict):</span>
<span class="sd">                An experiment design name. This name should be unique</span>
<span class="sd">                within the named scope, and typically will include a</span>
<span class="sd">                reference to the design sampler, for example:</span>
<span class="sd">                &#39;uni&#39; - generated by univariate sensitivity test design</span>
<span class="sd">                &#39;lhs&#39; - generated by latin hypercube sample design</span>
<span class="sd">                The design_name is used primarily to load groups of</span>
<span class="sd">                related experiments together.</span>
<span class="sd">                TODO: document dict</span>
<span class="sd">            source (int):</span>
<span class="sd">                An indicator of performance measure source. This should</span>
<span class="sd">                be 0 for a bona fide run of the associated core models,</span>
<span class="sd">                or some non-zero metamodel_id number.</span>
<span class="sd">            xlm_df (pandas.DataFrame):</span>
<span class="sd">                The columns of this DataFrame are the experiment</span>
<span class="sd">                parameters (i.e. policy levers, uncertainties, and</span>
<span class="sd">                constants) and performance measures, and each row</span>
<span class="sd">                is an experiment.</span>
<span class="sd">            run_ids (pandas.Index, optional):</span>
<span class="sd">                Provide an optional index of universally unique run ids</span>
<span class="sd">                (UUIDs) for these results. The UUIDs can be used to help</span>
<span class="sd">                identify problems and organize model runs.</span>

<span class="sd">        Raises:</span>
<span class="sd">            DesignExistsError: If scope and design already exist</span>
<span class="sd">            TypeError: If not all scope variables are defined in the</span>
<span class="sd">                experiment</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ReadOnlyDatabaseError</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="s1">&#39;design_name&#39;</span><span class="p">)</span>
            <span class="n">fcur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">design_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">design_name_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">design_name</span><span class="p">:</span> <span class="n">xlm_df</span><span class="o">.</span><span class="n">index</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">design_name_map</span> <span class="o">=</span> <span class="n">design_name</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">design_name_map</span><span class="p">:</span>
                <span class="n">exist</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fcur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">sq</span><span class="o">.</span><span class="n">GET_EXPERIMENT_PARAMETERS_AND_MEASURES</span><span class="p">,</span>
                    <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span>
                <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">exist</span><span class="o">.</span><span class="n">empty</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">...exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">DesignExistsError</span>
                    <span class="k">raise</span> <span class="n">DesignExistsError</span><span class="p">(</span>
                        <span class="s1">&#39;scope </span><span class="si">{0}</span><span class="s1"> with design </span><span class="si">{1}</span><span class="s1"> found, &#39;</span> 
                        <span class="s1">&#39;must be deleted before recording&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                    <span class="p">)</span>

            <span class="c1"># get list of experiment variables</span>
            <span class="n">scp_xl</span> <span class="o">=</span> <span class="n">fcur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_SCOPE_XL</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">])</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="n">scp_m</span> <span class="o">=</span> <span class="n">fcur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_SCOPE_M</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">])</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

            <span class="n">experiment_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_experiment_parameters</span><span class="p">(</span>
                <span class="n">scope_name</span><span class="p">,</span>
                <span class="n">design_name_map</span><span class="p">,</span>
                <span class="n">xlm_df</span><span class="p">[[</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">scp_xl</span><span class="p">]],</span>
            <span class="p">)</span>
            <span class="n">xlm_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">experiment_ids</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_experiment_measures</span><span class="p">(</span>
                <span class="n">scope_name</span><span class="p">,</span>
                <span class="n">source</span><span class="p">,</span>
                <span class="n">xlm_df</span><span class="p">[[</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">scp_m</span> <span class="k">if</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">xlm_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]],</span>
                <span class="n">run_ids</span><span class="o">=</span><span class="n">run_ids</span><span class="p">,</span>
            <span class="p">)</span></div>


        
<div class="viewcode-block" id="SQLiteDB.read_scope_names">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.read_scope_names">[docs]</a>
    <span class="nd">@copydoc</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">read_scope_names</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_scope_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">design_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">design_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scopes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_SCOPE_NAMES</span> <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scopes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_SCOPES_CONTAINING_DESIGN_NAME</span><span class="p">,</span>
                                                     <span class="p">[</span><span class="n">design_name</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">scopes</span></div>


<div class="viewcode-block" id="SQLiteDB.read_design_names">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.read_design_names">[docs]</a>
    <span class="nd">@copydoc</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">read_design_names</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_design_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">designs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_DESIGN_NAMES</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">designs</span></div>


<div class="viewcode-block" id="SQLiteDB.read_uncertainties">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.read_uncertainties">[docs]</a>
    <span class="nd">@copydoc</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">read_uncertainties</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_uncertainties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">scp_x</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_SCOPE_X</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">])</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">scp_x</span><span class="p">]</span></div>


<div class="viewcode-block" id="SQLiteDB.read_levers">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.read_levers">[docs]</a>
    <span class="nd">@copydoc</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">read_levers</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_levers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">scp_l</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_SCOPE_L</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">])</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">scp_l</span><span class="p">]</span></div>


<div class="viewcode-block" id="SQLiteDB.read_constants">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.read_constants">[docs]</a>
    <span class="nd">@copydoc</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">read_constants</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">scp_c</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_SCOPE_C</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">])</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">scp_c</span><span class="p">]</span></div>


<div class="viewcode-block" id="SQLiteDB.read_measures">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.read_measures">[docs]</a>
    <span class="nd">@copydoc</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">read_measures</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_measures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">scp_m</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_SCOPE_M</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">])</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">scp_m</span><span class="p">]</span></div>


<div class="viewcode-block" id="SQLiteDB.read_box">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.read_box">[docs]</a>
    <span class="nd">@copydoc</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">read_box</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">box_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">...scope.box</span><span class="w"> </span><span class="kn">import</span> <span class="n">Box</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_box_parent_name</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">box_name</span><span class="p">)</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">Box</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">box_name</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">,</span>
                  <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_BOX_THRESHOLDS</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">box_name</span><span class="p">]):</span>
            <span class="n">par_name</span><span class="p">,</span> <span class="n">t_value</span><span class="p">,</span> <span class="n">t_type</span> <span class="o">=</span> <span class="n">row</span>
            <span class="k">if</span> <span class="n">t_type</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">box</span><span class="o">.</span><span class="n">set_lower_bound</span><span class="p">(</span><span class="n">par_name</span><span class="p">,</span> <span class="n">t_value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">t_type</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">box</span><span class="o">.</span><span class="n">set_upper_bound</span><span class="p">(</span><span class="n">par_name</span><span class="p">,</span> <span class="n">t_value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">t_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">box</span><span class="o">.</span><span class="n">relevant_features</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">par_name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">t_type</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">box</span><span class="o">.</span><span class="n">add_to_allowed_set</span><span class="p">(</span><span class="n">par_name</span><span class="p">,</span> <span class="n">t_value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">box</span></div>


<div class="viewcode-block" id="SQLiteDB.read_box_names">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.read_box_names">[docs]</a>
    <span class="nd">@copydoc</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">read_box_names</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_box_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_BOX_NAMES</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">])</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span></div>


<div class="viewcode-block" id="SQLiteDB.read_box_parent_name">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.read_box_parent_name">[docs]</a>
    <span class="nd">@copydoc</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">read_box_parent_name</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_box_parent_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">box_name</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_BOX_PARENT_NAME</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">box_name</span><span class="p">])</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="SQLiteDB.read_box_parent_names">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.read_box_parent_names">[docs]</a>
    <span class="nd">@copydoc</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">read_box_parent_names</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_box_parent_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">GET_BOX_PARENT_NAMES</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">])</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">names</span><span class="p">}</span></div>


<div class="viewcode-block" id="SQLiteDB.read_boxes">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.read_boxes">[docs]</a>
    <span class="nd">@copydoc</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">read_boxes</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_boxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope_name</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">...scope.box</span><span class="w"> </span><span class="kn">import</span> <span class="n">Boxes</span>
        <span class="k">if</span> <span class="n">scope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scope_name</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">name</span>
        <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_box_names</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">Boxes</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_box</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span>
            <span class="n">u</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">u</span></div>


<div class="viewcode-block" id="SQLiteDB.write_box">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.write_box">[docs]</a>
    <span class="nd">@copydoc</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">write_box</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">scope_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">...scope.box</span><span class="w"> </span><span class="kn">import</span> <span class="n">Box</span><span class="p">,</span> <span class="n">Bounds</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">Box</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">scope_name_</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">scope_name_</span> <span class="o">=</span> <span class="n">scope_name</span>
            <span class="k">if</span> <span class="n">scope_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">scope_name</span> <span class="o">!=</span> <span class="n">scope_name_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;scope_name mismatch&quot;</span><span class="p">)</span>
            <span class="n">scope_name</span> <span class="o">=</span> <span class="n">scope_name_</span>
            <span class="n">scope_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="n">p_</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_uncertainties</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_levers</span><span class="p">(</span><span class="n">scope_name</span><span class="p">))</span>
            <span class="n">m_</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_measures</span><span class="p">(</span><span class="n">scope_name</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">parent_box_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">INSERT_BOX</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">INSERT_SUBBOX</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                    <span class="n">box</span><span class="o">.</span><span class="n">parent_box_name</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">t_name</span><span class="p">,</span> <span class="n">t_vals</span> <span class="ow">in</span> <span class="n">box</span><span class="o">.</span><span class="n">_thresholds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="k">if</span> <span class="n">t_name</span> <span class="ow">in</span> <span class="n">p_</span><span class="p">:</span>
                    <span class="n">sql_cl</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">CLEAR_BOX_THRESHOLD_P</span>
                    <span class="n">sql_in</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">SET_BOX_THRESHOLD_P</span>
                <span class="k">elif</span> <span class="n">t_name</span> <span class="ow">in</span> <span class="n">m_</span><span class="p">:</span>
                    <span class="n">sql_cl</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">CLEAR_BOX_THRESHOLD_M</span>
                    <span class="n">sql_in</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">SET_BOX_THRESHOLD_M</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t_name</span><span class="si">}</span><span class="s2"> not identifiable as parameter or measure&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_cl</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t_name</span><span class="p">])</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t_vals</span><span class="p">,</span> <span class="n">Bounds</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">t_vals</span><span class="o">.</span><span class="n">lowerbound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_in</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t_name</span><span class="p">,</span> <span class="n">t_vals</span><span class="o">.</span><span class="n">lowerbound</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">t_vals</span><span class="o">.</span><span class="n">upperbound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_in</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t_name</span><span class="p">,</span> <span class="n">t_vals</span><span class="o">.</span><span class="n">upperbound</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t_vals</span><span class="p">,</span> <span class="n">AbstractSet</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">t_vals</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_in</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t_name</span><span class="p">,</span> <span class="n">t_val</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">t_vals</span><span class="p">)))</span>

            <span class="k">for</span> <span class="n">t_name</span> <span class="ow">in</span> <span class="n">box</span><span class="o">.</span><span class="n">relevant_features</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">t_name</span> <span class="ow">in</span> <span class="n">p_</span><span class="p">:</span>
                    <span class="n">sql_cl</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">CLEAR_BOX_THRESHOLD_P</span>
                    <span class="n">sql_in</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">SET_BOX_THRESHOLD_P</span>
                <span class="k">elif</span> <span class="n">t_name</span> <span class="ow">in</span> <span class="n">m_</span><span class="p">:</span>
                    <span class="n">sql_cl</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">CLEAR_BOX_THRESHOLD_M</span>
                    <span class="n">sql_in</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">SET_BOX_THRESHOLD_M</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t_name</span><span class="si">}</span><span class="s2"> not identifiable as parameter or measure&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_cl</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t_name</span><span class="p">])</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_in</span><span class="p">,</span> <span class="p">[</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">t_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span></div>



<div class="viewcode-block" id="SQLiteDB.write_boxes">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.write_boxes">[docs]</a>
    <span class="nd">@copydoc</span><span class="p">(</span><span class="n">Database</span><span class="o">.</span><span class="n">write_boxes</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_boxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">scope_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">boxes</span><span class="o">.</span><span class="n">scope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">scope_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">scope_name</span> <span class="o">!=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;scope name mismatch&#39;</span><span class="p">)</span>
                <span class="n">scope_name</span> <span class="o">=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span>
            <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_box</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">scope_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="SQLiteDB.log">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.log">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Log a message into the SQLite database</span>

<span class="sd">        Args:</span>
<span class="sd">            message (str): A message to log, will be stored verbatim.</span>
<span class="sd">            level (int): A logging level, can be used to filter messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO ema_log(level, content) VALUES (?,?)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">level</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)])</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span></div>


<div class="viewcode-block" id="SQLiteDB.merge_log">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.merge_log">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">merge_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge the log from another SQLiteDB into this database log.</span>

<span class="sd">        Args:</span>
<span class="sd">            other (emat.SQLiteDB): Source of log to merge.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ReadOnlyDatabaseError</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s1">&#39;conn&#39;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">other</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
                <span class="n">selfc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                <span class="n">otherc</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                <span class="n">other_q</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT</span>
<span class="s2">                    timestamp, level, content </span>
<span class="s2">                FROM</span>
<span class="s2">                    ema_log </span>
<span class="s2">                ORDER BY</span>
<span class="s2">                    rowid</span>
<span class="s2">                &quot;&quot;&quot;</span>
                <span class="k">for</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">otherc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">other_q</span><span class="p">):</span>
                        <span class="n">selfc</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                            INSERT INTO ema_log(timestamp, level, content) </span>
<span class="sd">                            SELECT ?1, ?2, ?3</span>
<span class="sd">                            WHERE NOT EXISTS(</span>
<span class="sd">                                SELECT 1 FROM ema_log </span>
<span class="sd">                                WHERE timestamp=?1 AND level=?2 AND content=?3</span>
<span class="sd">                            )</span>
<span class="sd">                            &quot;&quot;&quot;</span><span class="p">,</span>
                            <span class="p">[</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">content</span><span class="p">],</span>
                        <span class="p">)</span></div>


                    <span class="c1"># if not selfc.execute(</span>
                    <span class="c1">#     &quot;SELECT count(*) FROM ema_log WHERE timestamp=? AND level=? AND content=?&quot;,</span>
                    <span class="c1">#     [timestamp, level, content],</span>
                    <span class="c1"># ).fetchall()[0][0]:</span>
                    <span class="c1">#     selfc.execute(</span>
                    <span class="c1">#         &quot;INSERT INTO ema_log(timestamp, level, content) VALUES (?,?,?)&quot;,</span>
                    <span class="c1">#         [timestamp, level, content],</span>
                    <span class="c1">#     )</span>

<div class="viewcode-block" id="SQLiteDB.print_log">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.print_log">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">print_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;DESC&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">like</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print logged messages from the SQLite database</span>

<span class="sd">        Args:</span>
<span class="sd">            file (file-like object):</span>
<span class="sd">                Where to print the output, defaults to the</span>
<span class="sd">                current sys.stdout.</span>
<span class="sd">            limit (int or None, default 20):</span>
<span class="sd">                Maximum number of messages to print</span>
<span class="sd">            order ({&#39;DESC&#39;,&#39;ASC&#39;}):</span>
<span class="sd">                Print log messages in descending or ascending</span>
<span class="sd">                chronological order.</span>
<span class="sd">            level (int):</span>
<span class="sd">                A logging level, only messages logged at this</span>
<span class="sd">                level or higher are printed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ASC&quot;</span><span class="p">,</span> <span class="s2">&quot;DESC&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;order must be ASC or DESC&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;level must be integer&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">like</span><span class="p">:</span>
            <span class="n">qry</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT</span>
<span class="s2">                datetime(timestamp, &#39;localtime&#39;), content </span>
<span class="s2">            FROM</span>
<span class="s2">                ema_log </span>
<span class="s2">            WHERE</span>
<span class="s2">                level &gt;= </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">                AND content LIKE &#39;</span><span class="si">{</span><span class="n">like</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">            ORDER BY</span>
<span class="s2">                timestamp </span><span class="si">{</span><span class="n">order</span><span class="si">}</span><span class="s2">, rowid </span><span class="si">{</span><span class="n">order</span><span class="si">}</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qry</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT</span>
<span class="s2">                datetime(timestamp, &#39;localtime&#39;), content </span>
<span class="s2">            FROM</span>
<span class="s2">                ema_log </span>
<span class="s2">            WHERE</span>
<span class="s2">                level &gt;= </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2"> </span>
<span class="s2">            ORDER BY</span>
<span class="s2">                timestamp </span><span class="si">{</span><span class="n">order</span><span class="si">}</span><span class="s2">, rowid </span><span class="si">{</span><span class="n">order</span><span class="si">}</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">qry</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; LIMIT </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">qry</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span></div>



<div class="viewcode-block" id="SQLiteDB.mark_run_invalid">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.mark_run_invalid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mark_run_invalid</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">run_id</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mark a particular run_id as invalid.</span>

<span class="sd">        Args:</span>
<span class="sd">            run_id (str): The run to mark as invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ReadOnlyDatabaseError</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            UPDATE </span>
<span class="s1">                ema_experiment_run</span>
<span class="s1">            SET</span>
<span class="s1">                run_valid = 0</span>
<span class="s1">            WHERE</span>
<span class="s1">                run_id = @run_id</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">run_id</span><span class="o">=</span><span class="n">run_id</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MARKED AS INVALID RUN_ID </span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FAILED TO MARK AS INVALID RUN_ID </span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_run_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">runs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_query</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            SELECT </span>
<span class="sd">                run_id, </span>
<span class="sd">                experiment_id, </span>
<span class="sd">                run_source,</span>
<span class="sd">                run_status, </span>
<span class="sd">                run_valid, </span>
<span class="sd">                run_timestamp, </span>
<span class="sd">                run_location </span>
<span class="sd">            FROM </span>
<span class="sd">                ema_experiment_run</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">runs</span><span class="p">[</span><span class="s1">&#39;run_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runs</span><span class="p">[</span><span class="s1">&#39;run_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="nb">bytes</span><span class="o">=</span><span class="n">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">runs</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;run_id&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="SQLiteDB.merge_database">
<a class="viewcode-back" href="../../../../source/emat.database/sqlitedb.html#emat.database.SQLiteDB.merge_database">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">merge_database</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">other</span><span class="p">,</span>
            <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">on_conflict</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span>
            <span class="n">max_diffs_in_log</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge results from another database.</span>

<span class="sd">        Only results from a matching identical scope are</span>
<span class="sd">        merged.  Metamodels are copied without checking</span>
<span class="sd">        if they are duplicate.</span>

<span class="sd">        Args:</span>
<span class="sd">            other (emat.Database):</span>
<span class="sd">                The other database from which to draw data.</span>
<span class="sd">            force (bool, default False):</span>
<span class="sd">                By default, database results are merged only</span>
<span class="sd">                when the scopes match exactly between the current</span>
<span class="sd">                and `other` database files.  Setting `force` to</span>
<span class="sd">                `True` will merge results from the `other`</span>
<span class="sd">                database file as long as the scope names match,</span>
<span class="sd">                the names of the the scoped parameters match,</span>
<span class="sd">                and there is some overlap in the names of the</span>
<span class="sd">                scoped performance measures.</span>
<span class="sd">            dryrun (bool, default False):</span>
<span class="sd">                Allows a dry run of the merge, to check how many</span>
<span class="sd">                experiments would be merged, without actually</span>
<span class="sd">                importing any data into the current database.</span>
<span class="sd">            on_conflict ({&#39;ignore&#39;,&#39;replace&#39;}, default &#39;ignore&#39;):</span>
<span class="sd">                When corresponding performance measures for the</span>
<span class="sd">                same experiment exist in both the current and</span>
<span class="sd">                `other` databases, the merge will either ignore</span>
<span class="sd">                the updated value or replace it with the value</span>
<span class="sd">                from the other database.  This only applies to</span>
<span class="sd">                conflicts in performance measures; conflicts in</span>
<span class="sd">                parameters always result in distinct experiments.</span>
<span class="sd">            max_diffs_in_log (int, default 50):</span>
<span class="sd">                When there are fewer than this many changes in</span>
<span class="sd">                a set of experiments, the individual experiment_ids</span>
<span class="sd">                that have been changed are reported.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ReadOnlyDatabaseError</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Database</span><span class="p">)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">...util.deduplicate</span><span class="w"> </span><span class="kn">import</span> <span class="n">count_diff_rows</span><span class="p">,</span> <span class="n">report_diff_rows</span>
        <span class="n">other_db_path</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s1">&#39;database_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">other_db_path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;merging from database at </span><span class="si">{</span><span class="n">other_db_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">scope_name</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">read_scope_names</span><span class="p">():</span>
            <span class="n">scope_other</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">read_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scope_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_scope_names</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">store_scope</span><span class="p">(</span><span class="n">scope_other</span><span class="p">)</span>
            <span class="n">scope_self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_scope</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                <span class="c1"># Force merge if parameter names match, and there are some measures in common</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">scope_self</span><span class="o">.</span><span class="n">get_parameter_names</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">scope_other</span><span class="o">.</span><span class="n">get_parameter_names</span><span class="p">()):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;not merging scope name </span><span class="si">{</span><span class="n">scope_name</span><span class="si">}</span><span class="s2">, parameter names do not match current database&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">common_measure_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">scope_self</span><span class="o">.</span><span class="n">get_measure_names</span><span class="p">())</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">scope_other</span><span class="o">.</span><span class="n">get_measure_names</span><span class="p">()))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">common_measure_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;not merging scope name </span><span class="si">{</span><span class="n">scope_name</span><span class="si">}</span><span class="s2">, measure names do not overlap current database&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Unforced merge only when scopes are identical</span>
                <span class="k">if</span> <span class="n">scope_self</span> <span class="o">!=</span> <span class="n">scope_other</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;not merging scope name </span><span class="si">{</span><span class="n">scope_name</span><span class="si">}</span><span class="s2">, content does not match current database&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">common_measure_names</span> <span class="o">=</span> <span class="n">scope_self</span><span class="o">.</span><span class="n">get_measure_names</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;merging scope name </span><span class="si">{</span><span class="n">scope_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># transfer metamodels</span>
            <span class="n">source_mapping</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">other_metamodel_ids</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">read_metamodel_ids</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">other_metamodel_id</span> <span class="ow">in</span> <span class="n">other_metamodel_ids</span><span class="p">:</span>
                <span class="n">other_metamodel</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">read_metamodel</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">other_metamodel_id</span><span class="p">)</span>
                <span class="n">new_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_new_metamodel_id</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>
                <span class="n">other_metamodel</span><span class="o">.</span><span class="n">metamodel_id</span> <span class="o">=</span> <span class="n">new_id</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dryrun</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_metamodel</span><span class="p">(</span>
                        <span class="n">scope_name</span><span class="p">,</span>
                        <span class="n">metamodel</span><span class="o">=</span><span class="n">other_metamodel</span><span class="p">,</span>
                        <span class="n">metamodel_id</span><span class="o">=</span><span class="n">new_id</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">source_mapping</span><span class="p">[</span><span class="n">other_metamodel_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_id</span>

            <span class="c1"># transfer runs</span>
            <span class="n">n_runs_added</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">other_runs</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">get_run_list</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">other_runs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                        <span class="s1">&#39;run_id&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;experiment_id&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;run_source&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;run_status&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;run_valid&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;run_timestamp&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;run_location&#39;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span>

            <span class="c1"># transfer experiments</span>
            <span class="n">design_names</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">read_design_names</span><span class="p">(</span><span class="n">scope_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">design_name</span> <span class="ow">in</span> <span class="n">design_names</span><span class="p">:</span>
                <span class="n">xl_df</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">read_experiment_parameters</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">)</span>
                <span class="n">proposed_design_name</span> <span class="o">=</span> <span class="n">design_name</span>
                <span class="n">design_match</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">experiment_id_map</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">proposed_design_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_design_names</span><span class="p">(</span><span class="n">scope_name</span><span class="p">):</span>
                    <span class="n">xl_df_self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_experiment_parameters</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">xl_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span>
                            <span class="n">xl_df_self</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span>
                        <span class="k">while</span> <span class="n">proposed_design_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_design_names</span><span class="p">(</span><span class="n">scope_name</span><span class="p">):</span>
                            <span class="n">proposed_design_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">design_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">design_match</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">experiment_id_map</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">xl_df_self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">xl_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">design_match</span><span class="p">:</span>
                    <span class="c1"># transfer parameters</span>
                    <span class="k">if</span> <span class="n">proposed_design_name</span> <span class="o">==</span> <span class="n">design_name</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;experiment parameters updates for </span><span class="si">{</span><span class="n">scope_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">design_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;experiment parameters updates for </span><span class="si">{</span><span class="n">scope_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">design_name</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">proposed_design_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dryrun</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_experiment_parameters</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">proposed_design_name</span><span class="p">,</span> <span class="n">xl_df</span><span class="p">)</span>
                <span class="n">sources</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">read_experiment_measure_sources</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">)</span>

                <span class="c1"># transfer relevant runs</span>
                <span class="k">if</span> <span class="n">experiment_id_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">experiment_id_map_</span> <span class="o">=</span> <span class="n">experiment_id_map</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">experiment_id_map_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">xl_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">xl_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">relevant_runs</span> <span class="o">=</span> <span class="n">other_runs</span><span class="p">[</span><span class="s1">&#39;experiment_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">experiment_id_map_</span><span class="p">)</span>
                <span class="n">copy_runs</span> <span class="o">=</span> <span class="n">other_runs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">copy_runs</span><span class="p">[</span><span class="s1">&#39;experiment_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relevant_runs</span>
                <span class="n">copy_runs</span> <span class="o">=</span> <span class="n">copy_runs</span><span class="p">[</span><span class="o">~</span><span class="n">relevant_runs</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
                    <span class="n">n_runs_added</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">copy_runs</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
                        <span class="n">binding</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                            <span class="n">run_id</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bytes</span><span class="p">,</span>
                            <span class="n">experiment_id</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">run_source</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                            <span class="n">run_status</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                            <span class="n">run_valid</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                            <span class="n">run_timestamp</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                            <span class="n">run_location</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                            INSERT OR IGNORE INTO ema_experiment_run (</span>
<span class="sd">                                run_id           ,</span>
<span class="sd">                                experiment_id    ,</span>
<span class="sd">                                run_source       ,</span>
<span class="sd">                                run_status       ,</span>
<span class="sd">                                run_valid        ,</span>
<span class="sd">                                run_timestamp    ,</span>
<span class="sd">                                run_location     </span>
<span class="sd">                            ) VALUES (</span>
<span class="sd">                                @run_id           ,</span>
<span class="sd">                                @experiment_id    ,</span>
<span class="sd">                                @run_source       ,</span>
<span class="sd">                                @run_status       ,</span>
<span class="sd">                                @run_valid        ,</span>
<span class="sd">                                @run_timestamp    ,</span>
<span class="sd">                                @run_location    </span>
<span class="sd">                            ) </span>
<span class="sd">                            &quot;&quot;&quot;</span><span class="p">,</span>
                            <span class="n">binding</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span><span class="p">:</span>
                            <span class="n">n_runs_added</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">n_runs_added</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;added </span><span class="si">{</span><span class="n">n_runs_added</span><span class="si">}</span><span class="s2"> run_ids to database&quot;</span><span class="p">)</span>

                <span class="c1"># transfer measures</span>
                <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># source is core model, make updates but do not overwrite non-null values</span>
                        <span class="n">m_df0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_experiment_measures</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">runs</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
                        <span class="n">m_df1</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">read_experiment_measures</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">runs</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)[</span><span class="n">common_measure_names</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">experiment_id_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">reindexed</span> <span class="o">=</span> <span class="n">m_df1</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">experiment_id_map</span><span class="p">)</span>
                            <span class="n">m_df1</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">set_levels</span><span class="p">(</span>
                                <span class="n">reindexed</span><span class="p">,</span>
                                <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="n">df0copy</span> <span class="o">=</span> <span class="n">m_df0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">on_conflict</span> <span class="o">==</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span>
                                <span class="n">m_df</span> <span class="o">=</span> <span class="n">m_df1</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">m_df0</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">m_df</span> <span class="o">=</span> <span class="n">m_df0</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">m_df1</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;m_df0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">m_df0</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;m_df1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">m_df1</span><span class="p">)</span>
                            <span class="k">raise</span>

                        <span class="n">n_diffs</span> <span class="o">=</span> <span class="n">count_diff_rows</span><span class="p">(</span><span class="n">m_df</span><span class="p">,</span> <span class="n">df0copy</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;experiment measures </span><span class="si">{</span><span class="n">n_diffs</span><span class="si">}</span><span class="s2"> updates &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;for </span><span class="si">{</span><span class="n">scope_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">design_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">n_diffs</span> <span class="o">&lt;</span> <span class="n">max_diffs_in_log</span><span class="p">:</span>
                            <span class="n">list_diffs</span><span class="p">,</span> <span class="n">list_adds</span><span class="p">,</span> <span class="n">list_drops</span> <span class="o">=</span> <span class="n">report_diff_rows</span><span class="p">(</span><span class="n">m_df</span><span class="p">,</span> <span class="n">df0copy</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">list_diffs</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">scope_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">design_name</span><span class="si">}</span><span class="s2"> experiment measures updated: &quot;</span>
                                         <span class="o">+</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">list_diffs</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">list_adds</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">scope_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">design_name</span><span class="si">}</span><span class="s2"> experiment measures added: &quot;</span>
                                         <span class="o">+</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">list_adds</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">list_drops</span><span class="p">:</span> <span class="c1"># should be none</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">scope_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">design_name</span><span class="si">}</span><span class="s2"> experiment measures dropped: &quot;</span>
                                         <span class="o">+</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">list_drops</span><span class="p">))</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dryrun</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write_experiment_measures</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m_df</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># source is not core model, just copy</span>
                        <span class="n">m_df</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">read_experiment_measures</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)[</span><span class="n">common_measure_names</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">dryrun</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write_experiment_measures</span><span class="p">(</span><span class="n">scope_name</span><span class="p">,</span> <span class="n">source_mapping</span><span class="p">[</span><span class="n">source</span><span class="p">],</span> <span class="n">m_df</span><span class="p">)</span>

        <span class="c1"># merge logs</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">SQLiteDB</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">merge_log</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>