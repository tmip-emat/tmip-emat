

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>emat.model.core_model &mdash; TMIP-EMAT 0.6.4, January 2025 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/tmip_emat.css?v=eec227e2" />
      <link rel="stylesheet" type="text/css" href="../../../_static/jupyter-sphinx.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/thebelab.css" />

  
      <script src="../../../_static/documentation_options.js?v=ff12c608"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/thebelab-helper.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            TMIP-EMAT
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../source/emat.intro.html">Introduction to EMAT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/emat.install.html">Installation and Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/emat.scope/index.html">Exploratory Scoping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/emat.design/emat.design.html">Experimental Designs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/emat.models/index.html">Core Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/emat.metamodels/index.html">Meta Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/emat.database/index.html">Databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/emat.analysis/index.html">Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/emat.examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/emat.glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/emat.method-index.html">Methodology Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/emat.references.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">TMIP-EMAT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">emat.model.core_model</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for emat.model.core_model</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot; core_model.py - define coure model API&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">abc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Mapping</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..workbench.em_framework.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">AbstractModel</span> <span class="k">as</span> <span class="n">AbstractWorkbenchModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..workbench.em_framework.evaluators</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseEvaluator</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Collection</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterable</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..database.database</span><span class="w"> </span><span class="kn">import</span> <span class="n">Database</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..scope.scope</span><span class="w"> </span><span class="kn">import</span> <span class="n">Scope</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..optimization.optimization_result</span><span class="w"> </span><span class="kn">import</span> <span class="n">OptimizationResult</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..optimization</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpsilonProgress</span><span class="p">,</span> <span class="n">ConvergenceMetrics</span><span class="p">,</span> <span class="n">SolutionCount</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..util.evaluators</span><span class="w"> </span><span class="kn">import</span> <span class="n">prepare_evaluator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">MissingArchivePathError</span><span class="p">,</span> <span class="n">ReadOnlyDatabaseError</span><span class="p">,</span> <span class="n">MissingIdWarning</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.._pkg_constants</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..util.loggers</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_module_logger</span>
<span class="n">_logger</span> <span class="o">=</span> <span class="n">get_module_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="AbstractCoreModel">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AbstractCoreModel</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">,</span> <span class="n">AbstractWorkbenchModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An interface for using a model with EMAT.</span>

<span class="sd">    Individual models should be instantiated using derived</span>
<span class="sd">    subclasses of this abstract base class, and not using</span>
<span class="sd">    this class directly.</span>

<span class="sd">    Args:</span>
<span class="sd">        configuration (str or Mapping or None):</span>
<span class="sd">            The configuration for this core model. This can be given</span>
<span class="sd">            explicitly as a `dict`, or as a `str` which gives the</span>
<span class="sd">            filename of a YAML file that will be loaded. If there is</span>
<span class="sd">            no configuration, giving `None` is also acceptable.</span>
<span class="sd">        scope (Scope or str):</span>
<span class="sd">            The exploration scope, as a `Scope` object or as</span>
<span class="sd">            a `str` which gives the filename of a YAML file that will be</span>
<span class="sd">            loaded.</span>
<span class="sd">        safe (bool):</span>
<span class="sd">            Load the configuration YAML file in &#39;safe&#39; mode.</span>
<span class="sd">            This can be disabled if the configuration requires</span>
<span class="sd">            custom Python types or is otherwise not compatible with</span>
<span class="sd">            safe mode. Loading configuration files with safe mode</span>
<span class="sd">            off is not secure and should not be done with files from</span>
<span class="sd">            untrusted sources.</span>
<span class="sd">        db (Database, optional):</span>
<span class="sd">            An optional Database to store experiments and results.</span>
<span class="sd">        name (str, default &quot;EMAT&quot;):</span>
<span class="sd">            A name for this model, given as an alphanumeric string.</span>
<span class="sd">            The name is required by workbench operations.</span>
<span class="sd">        metamodel_id (int, optional):</span>
<span class="sd">            An identifier for this model, if it is a meta-model.</span>
<span class="sd">            Defaults to 0 (i.e., not a meta-model).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">configuration</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Mapping</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span>
                 <span class="n">scope</span><span class="p">,</span>
                 <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="s1">&#39;EMAT&#39;</span><span class="p">,</span>
                 <span class="n">metamodel_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">configuration</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">configuration</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">safe</span><span class="p">:</span>
                    <span class="n">configuration</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">configuration</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">configuration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">configuration</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">configuration</span> <span class="k">if</span> <span class="n">configuration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">Scope</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="n">scope</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="n">Scope</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>

        <span class="n">AbstractWorkbenchModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uncertainties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">_x_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">levers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">_l_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constants</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">_c_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outcomes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">_m_list</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metamodel_id</span> <span class="o">=</span> <span class="n">metamodel_id</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># don&#39;t pickle the db connection</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;db&#39;</span><span class="p">))</span>

<div class="viewcode-block" id="AbstractCoreModel.setup">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.setup">[docs]</a>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure the core model with the experiment variable values.</span>

<span class="sd">        This method is the place where the core model set up takes place,</span>
<span class="sd">        including creating or modifying files as necessary to prepare</span>
<span class="sd">        for a core model run.  When running experiments, this method</span>
<span class="sd">        is called once for each core model experiment, where each experiment</span>
<span class="sd">        is defined by a set of particular values for both the exogenous</span>
<span class="sd">        uncertainties and the policy levers.  These values are passed to</span>
<span class="sd">        the experiment only here, and not in the `run` method itself.</span>
<span class="sd">        This facilitates debugging, as the `setup` method can potentially</span>
<span class="sd">        be used without the `run` method, allowing the user to manually</span>
<span class="sd">        inspect the prepared files and ensure they are correct before</span>
<span class="sd">        actually running a potentially expensive model.</span>

<span class="sd">        Each input exogenous uncertainty or policy lever can potentially</span>
<span class="sd">        be used to manipulate multiple different aspects of the underlying</span>
<span class="sd">        core model.  For example, a policy lever that includes a number of</span>
<span class="sd">        discrete future network &quot;build&quot; options might trigger the replacement</span>
<span class="sd">        of multiple related network definition files.  Or, a single uncertainty</span>
<span class="sd">        relating to the cost of fuel might scale both a parameter linked to</span>
<span class="sd">        the modeled per-mile cost of operating an automobile, as well as the</span>
<span class="sd">        modeled total cost of fuel used by transit services.</span>

<span class="sd">        At the end of the `setup` method, a core model experiment should be</span>
<span class="sd">        ready to run using the `run` method.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (dict):</span>
<span class="sd">                experiment variables including both exogenous</span>
<span class="sd">                uncertainty and policy levers</span>
<span class="sd">                </span>
<span class="sd">        Raises:</span>
<span class="sd">            KeyError:</span>
<span class="sd">                if a defined experiment variable is not supported</span>
<span class="sd">                by the core model        </span>
<span class="sd">        &quot;&quot;&quot;</span>     </div>

 
<div class="viewcode-block" id="AbstractCoreModel.get_experiment_archive_path">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.get_experiment_archive_path">[docs]</a>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_experiment_archive_path</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">experiment_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">makedirs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">run_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a file system location to store model run outputs.</span>

<span class="sd">        For core models with long model run times, it is recommended</span>
<span class="sd">        to store the complete model run results in an archive.  This</span>
<span class="sd">        will facilitate adding additional performance measures to the</span>
<span class="sd">        scope at a later time.</span>

<span class="sd">        Both the scope name and experiment id can be used to create the </span>
<span class="sd">        folder path. </span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            experiment_id (int):</span>
<span class="sd">                The experiment id, which is also the row id of the</span>
<span class="sd">                experiment in the database. If this is omitted, an</span>
<span class="sd">                experiment id is read or created using the parameters.</span>
<span class="sd">            makedirs (bool, default False):</span>
<span class="sd">                If this archive directory does not yet exist, create it.</span>
<span class="sd">            parameters (dict, optional):</span>
<span class="sd">                The parameters for this experiment, used to create or</span>
<span class="sd">                lookup an experiment id. The parameters are ignored</span>
<span class="sd">                if `experiment_id` is given.</span>
<span class="sd">            run_id (UUID, optional):</span>
<span class="sd">                The run_id of this model run.  If not given but a</span>
<span class="sd">                run_id attribute is stored in this FilesCoreModel</span>
<span class="sd">                instance, that value is used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Experiment archive path (no trailing backslashes).</span>
<span class="sd">        &quot;&quot;&quot;</span>     </div>

    
<div class="viewcode-block" id="AbstractCoreModel.run">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.run">[docs]</a>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the core model.</span>

<span class="sd">        This method is the place where the core model run takes place.</span>
<span class="sd">        Note that this method takes no arguments; all the input</span>
<span class="sd">        exogenous uncertainties and policy levers are delivered to the</span>
<span class="sd">        core model in the `setup` method, which will be executed prior</span>
<span class="sd">        to calling this method. This facilitates debugging, as the `setup`</span>
<span class="sd">        method can potentially be used without the `run` method, allowing</span>
<span class="sd">        the user to manually inspect the prepared files and ensure they</span>
<span class="sd">        are correct before actually running a potentially expensive model.</span>
<span class="sd">        When running experiments, this method is called once for each core</span>
<span class="sd">        model experiment, after the `setup` method completes.</span>

<span class="sd">        If the core model requires some post-processing by `post_process`</span>
<span class="sd">        method defined in this API, then when this function terminates</span>
<span class="sd">        the model directory should be in a state that is ready to run the</span>
<span class="sd">        `post_process` command next.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserWarning: If model is not properly setup</span>
<span class="sd">        &quot;&quot;&quot;</span>     </div>

    
<div class="viewcode-block" id="AbstractCoreModel.post_process">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.post_process">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">post_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">measure_names</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs post processors associated with particular performance measures.</span>

<span class="sd">        This method is the place to conduct automatic post-processing</span>
<span class="sd">        of core model run results, in particular any post-processing that</span>
<span class="sd">        is expensive or that will write new output files into the core model&#39;s</span>
<span class="sd">        output directory.  The core model run should already have</span>
<span class="sd">        been completed using `setup` and `run`.  If the relevant performance</span>
<span class="sd">        measures do not require any post-processing to create (i.e. they</span>
<span class="sd">        can all be read directly from output files created during the core</span>
<span class="sd">        model run itself) then this method does not need to be overloaded</span>
<span class="sd">        for a particular core model implementation.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (dict):</span>
<span class="sd">                Dictionary of experiment variables, with keys as variable names</span>
<span class="sd">                and values as the experiment settings. Most post-processing</span>
<span class="sd">                scripts will not need to know the particular values of the</span>
<span class="sd">                inputs (exogenous uncertainties and policy levers), but this</span>
<span class="sd">                method receives the experiment input parameters as an argument</span>
<span class="sd">                in case one or more of these parameter values needs to be known</span>
<span class="sd">                in order to complete the post-processing.</span>
<span class="sd">            measure_names (List[str]):</span>
<span class="sd">                List of measures to be processed.  Normally for the first pass</span>
<span class="sd">                of core model run experiments, post-processing will be completed</span>
<span class="sd">                for all performance measures.  However, it is possible to use</span>
<span class="sd">                this argument to give only a subset of performance measures to</span>
<span class="sd">                post-process, which may be desirable if the post-processing</span>
<span class="sd">                of some performance measures is expensive.  Additionally, this</span>
<span class="sd">                method may also be called on archived model results, allowing</span>
<span class="sd">                it to run to generate only a subset of (probably new) performance</span>
<span class="sd">                measures based on these archived runs.</span>
<span class="sd">            output_path (str, optional):</span>
<span class="sd">                Path to model outputs.  If this is not given (typical for the</span>
<span class="sd">                initial run of core model experiments) then the local/default</span>
<span class="sd">                model directory is used.  This argument is provided primarily</span>
<span class="sd">                to facilitate post-processing archived model runs to make new</span>
<span class="sd">                performance measures (i.e. measures that were not in-scope when</span>
<span class="sd">                the core model was actually run).</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError:</span>
<span class="sd">                If post process is not available for specified measure</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

    
<div class="viewcode-block" id="AbstractCoreModel.load_measures">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.load_measures">[docs]</a>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_measures</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">measure_names</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">rel_output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">abs_output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Import selected measures from the core model.</span>
<span class="sd">        </span>
<span class="sd">        This method is the place to put code that can actually reach into</span>
<span class="sd">        files in the core model&#39;s run results and extract performance</span>
<span class="sd">        measures. It is expected that it should not do any post-processing</span>
<span class="sd">        of results (i.e. it should read from but not write to the model</span>
<span class="sd">        outputs directory).</span>

<span class="sd">        Imports measures from active scenario</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            measure_names (Collection[str]):</span>
<span class="sd">                Collection of measures to be loaded.</span>
<span class="sd">            rel_output_path, abs_output_path (str, optional):</span>
<span class="sd">                Path to model output locations, either relative</span>
<span class="sd">                to the `model_path` directory (when a subclass</span>
<span class="sd">                is a type that has a model path) or as an absolute</span>
<span class="sd">                directory.  If neither is given, the default</span>
<span class="sd">                value is equivalent to setting `rel_output_path` to</span>
<span class="sd">                &#39;Outputs&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict of measure name and values from active scenario</span>
<span class="sd">        </span>
<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If load_measures is not available for specified</span>
<span class="sd">                measure</span>
<span class="sd">        &quot;&quot;&quot;</span>           </div>

        

<div class="viewcode-block" id="AbstractCoreModel.archive">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.archive">[docs]</a>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">archive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">model_results_path</span><span class="p">,</span> <span class="n">experiment_id</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copies model outputs to archive location.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            params (dict): Dictionary of experiment variables</span>
<span class="sd">            model_results_path (str): archive path</span>
<span class="sd">            experiment_id (int, optional): The id number for this experiment.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">allow_short_circuit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bool: Allow model runs to be skipped if measures already appear in the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;allow_short_circuit&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="nd">@allow_short_circuit</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">allow_short_circuit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;allow_short_circuit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ignore_crash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bool: Allow model runs to `post_process` and `archive` even after an apparent crash in `run`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ignore_crash&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@ignore_crash</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ignore_crash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ignore_crash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">success_indicator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        str: The name of a file that indicates the model has run successfully.</span>

<span class="sd">        The flag is the mere existance of a file with this name, not any particular</span>
<span class="sd">        file content. This file is deleted automatically when the model `run` is</span>
<span class="sd">        initiated, so that it can be recreated to indicate a success.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;success_indicator&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@success_indicator</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">success_indicator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;success_indicator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">killed_indicator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        str: The name of a file that indicates the model was killed due to an unrecoverable error.</span>

<span class="sd">        The flag is the mere existance of a file with this name, not any particular</span>
<span class="sd">        file content. This file is deleted automatically when the model `run` is</span>
<span class="sd">        initiated, so that it can be recreated to indicate an unrecoverable error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;killed_indicator&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@killed_indicator</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">killed_indicator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;killed_indicator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">local_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Path: The current local working directory for this model.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;local_directory&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>

    <span class="nd">@local_directory</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">local_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;local_directory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">resolved_model_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Path: The resolved model path.</span>

<span class="sd">        For core models that don&#39;t rely on the file system, this</span>
<span class="sd">        is set to the current working directory and is generally</span>
<span class="sd">        irrelevant. Overload this property for models that do</span>
<span class="sd">        rely on the file system.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_directory</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_db_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">is_locked</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lock_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="k">yield</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span>

<div class="viewcode-block" id="AbstractCoreModel.enter_run_model">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.enter_run_model">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">enter_run_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A hook for actions at the very beginning of the run_model step.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="AbstractCoreModel.exit_run_model">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.exit_run_model">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">exit_run_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A hook for actions at the very end of the run_model step.&quot;&quot;&quot;</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">run_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs an experiment through core model.</span>

<span class="sd">        This method overloads the `run_model` method given in</span>
<span class="sd">        the EMA Workbench, and provides the correct execution</span>
<span class="sd">        of a core model within the workbench framework.  This</span>
<span class="sd">        function assembles and executes the steps laid out in</span>
<span class="sd">        other methods of this class, adding some useful logic</span>
<span class="sd">        to optimize the process (e.g. optionally short-</span>
<span class="sd">        circuiting runs that already have results stored</span>
<span class="sd">        in the database).</span>

<span class="sd">        For each experiment, the core model is called to:</span>

<span class="sd">            1.  `setup` experiment variables, copy files</span>
<span class="sd">                as needed, and otherwise prepare to run the</span>
<span class="sd">                core model for a particular experiment,</span>
<span class="sd">            2.  `run` the experiment,</span>
<span class="sd">            3.  `post_process` the result if needed to</span>
<span class="sd">                produce all relevant performance measures,</span>
<span class="sd">            4.  `archive` model outputs from this experiment</span>
<span class="sd">                (optional), and</span>
<span class="sd">            5.  `load_measures` from the experiment and</span>
<span class="sd">                store those measures in the associated database.</span>

<span class="sd">        Note that this method does *not* return any outcomes.</span>
<span class="sd">        Outcomes are instead written into self.outcomes_output,</span>
<span class="sd">        and can be retrieved from there, or from the database at</span>
<span class="sd">        a later time.</span>

<span class="sd">        In general, it should not be necessary to overload this</span>
<span class="sd">        method in derived classes built for particular core models.</span>
<span class="sd">        Instead, write overloaded methods for `setup`, `run`,</span>
<span class="sd">        `post_process` , `archive`, and `load_measures`.  Moreover,</span>
<span class="sd">        in typical usage a modeler will generally not want to rely</span>
<span class="sd">        on this method directly, but instead use `run_experiments`</span>
<span class="sd">        to automatically run multiple experiments with one command.</span>

<span class="sd">        Args:</span>
<span class="sd">            scenario (Scenario): A dict-like object that</span>
<span class="sd">                has key-value pairs for each uncertainty.</span>
<span class="sd">            policy (Policy): A dict-like object that</span>
<span class="sd">                has key-value pairs for each lever.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserWarning: If there are no experiments associated with</span>
<span class="sd">                this type.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enter_run_model</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comment_on_run</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;run_core_model read_experiment_parameters&quot;</span><span class="p">)</span>

            <span class="n">experiment_id</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_experiment_id_&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">experiment_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">experiment_id</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_experiment_id_&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_db&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>

            <span class="c1"># If running a core files model using the DistributedEvaluator,</span>
            <span class="c1"># the workers won&#39;t have access to the DB directly, so we&#39;ll only</span>
            <span class="c1"># run the short-circuit test and the ad-hoc write-to-database</span>
            <span class="c1"># section of this code if the `db` attribute is available.</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">Database</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">experiment_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_db_locked</span><span class="p">:</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">MissingIdWarning</span><span class="p">)</span>
                        <span class="n">experiment_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">read_experiment_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">experiment_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_short_circuit</span><span class="p">:</span>
                    <span class="c1"># opportunity to short-circuit run by loading pre-computed values.</span>
                    <span class="n">precomputed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">read_experiment_measures</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span>
                        <span class="n">design_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">experiment_id</span><span class="o">=</span><span class="n">experiment_id</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">precomputed</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">outcomes_output</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">precomputed</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;short circuit experiment_id </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;uid&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;no uid&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span>

                <span class="k">if</span> <span class="n">experiment_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_db_locked</span><span class="p">:</span>
                    <span class="n">experiment_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">write_experiment_parameters_1</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;ad hoc&#39;</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">policy</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;YES DATABASE experiment_id </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NO DATABASE experiment_id </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">set_status</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
                <span class="n">run_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;run_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">run_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">experiment_id</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">write_experiment_run_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">experiment_id</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

            <span class="n">xl</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">xl</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
            <span class="n">xl</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>

            <span class="n">m_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_measure_names</span><span class="p">()</span>

            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_core_model setup </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">xl</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_indicator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">success_indicator</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolved_model_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_indicator</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">success_indicator</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">success_indicator</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">success_indicator</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">killed_indicator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">killed_indicator</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolved_model_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">killed_indicator</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">killed_indicator</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">killed_indicator</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">killed_indicator</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_core_model run </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR in run_core_model run </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ex_archive_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_experiment_archive_path</span><span class="p">(</span><span class="n">experiment_id</span><span class="p">,</span> <span class="n">makedirs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">MissingArchivePathError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ex_archive_path</span><span class="p">,</span> <span class="s1">&#39;error.stdout.log&#39;</span><span class="p">),</span> <span class="s1">&#39;ab&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdout</span><span class="p">:</span>
                                <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ex_archive_path</span><span class="p">,</span> <span class="s1">&#39;error.stderr.log&#39;</span><span class="p">),</span> <span class="s1">&#39;ab&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stderr</span><span class="p">:</span>
                                <span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ex_archive_path</span><span class="p">,</span> <span class="s1">&#39;error.log&#39;</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">errlog</span><span class="p">:</span>
                        <span class="n">errlog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="n">measures_dictionary</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">m_names</span><span class="p">}</span>
                <span class="c1"># Assign to outcomes_output, for ema_workbench compatibility</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outcomes_output</span> <span class="o">=</span> <span class="n">measures_dictionary</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_crash</span><span class="p">:</span>
                    <span class="c1"># If &#39;ignore_crash&#39; is False (the default), then abort now and skip</span>
                    <span class="c1"># any post-processing and other archiving steps, which will</span>
                    <span class="c1"># probably fail anyway.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_core_model ABORT </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">comment_on_run</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;FAILED EXPERIMENT </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">set_status</span><span class="p">(</span><span class="s2">&quot;FAILED&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_core_model CONTINUE AFTER ERROR </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">success_indicator</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">success_indicator</span><span class="p">):</span>
                    <span class="c1"># The absence of the `success_indicator` file means that the model</span>
                    <span class="c1"># did not actually terminate correctly, so we do not want to</span>
                    <span class="c1"># post-process or store these results in the database.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">comment_on_run</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;NON-SUCCESSFUL EXPERIMENT </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">: success_indicator missing&quot;</span>
                    <span class="n">set_status</span><span class="p">(</span><span class="s2">&quot;NON-SUCCESS&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;success_indicator missing: </span><span class="si">{</span><span class="n">success_indicator</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">killed_indicator</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">killed_indicator</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">comment_on_run</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;KILLED EXPERIMENT </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">: killed_indicator present&quot;</span>
                    <span class="n">set_status</span><span class="p">(</span><span class="s2">&quot;KILLED&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;killed_indicator present: </span><span class="si">{</span><span class="n">killed_indicator</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_core_model post_process </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_process</span><span class="p">(</span><span class="n">xl</span><span class="p">,</span> <span class="n">m_names</span><span class="p">)</span>

                <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_core_model wrap up </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">measures_dictionary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_measures</span><span class="p">(</span><span class="n">m_names</span><span class="p">)</span>
                <span class="n">m_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">measures_dictionary</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">experiment_id</span><span class="p">])</span>

            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;KeyboardInterrupt in post_process, load_measures or outcome processing </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;error in post_process, load_measures or outcome processing </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;proceeding directly to archive attempt </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">comment_on_run</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">comment_on_run</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PROBLEM IN EXPERIMENT </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">set_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PROBLEM: </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># only write to database if there was no error in post_process, load_measures or outcome processing</span>
                <span class="k">if</span> <span class="n">experiment_id</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_core_model write db </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">run_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;run_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">run_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">run_id</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">new_run_id</span><span class="p">(</span>
                            <span class="n">scope_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">experiment_id</span><span class="o">=</span><span class="n">experiment_id</span><span class="p">,</span>
                            <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metamodel_id</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">write_experiment_measures</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metamodel_id</span><span class="p">,</span> <span class="n">m_df</span><span class="p">,</span> <span class="p">[</span><span class="n">run_id</span><span class="p">])</span>
                    <span class="k">except</span> <span class="n">ReadOnlyDatabaseError</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;database is read-only, not storing model outcomes&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;error in writing results to database: </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_core_model OK write db </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metamodel_id</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">m_df</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">set_status</span><span class="p">(</span><span class="s2">&quot;COMPLETE&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_core_model no db to write to </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">experiment_id</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ex_archive_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_experiment_archive_path</span><span class="p">(</span><span class="n">experiment_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">MissingArchivePathError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_core_model archive </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">archive</span><span class="p">(</span><span class="n">xl</span><span class="p">,</span> <span class="n">ex_archive_path</span><span class="p">,</span> <span class="n">experiment_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_core_model no archive because no experiment_id&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit_run_model</span><span class="p">()</span>

<div class="viewcode-block" id="AbstractCoreModel.read_experiments">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.read_experiments">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_experiments</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">design_name</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">only_pending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">only_complete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">only_with_measures</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads results from a design of experiments from the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            design_name (str): The name of the design to load.</span>
<span class="sd">            db (Database, optional): The Database from which to read experiments.</span>
<span class="sd">                If no db is given, the default `db` for this model is used.</span>
<span class="sd">            only_pending (bool, default False): If True, only pending</span>
<span class="sd">                experiments (which have no performance measure results</span>
<span class="sd">                stored in the database) are returned.</span>
<span class="sd">            only_complete (bool, default False): If True, only complete</span>
<span class="sd">                experiments (which have no performance measure</span>
<span class="sd">                results missing in the database) are returned.</span>
<span class="sd">            only_with_measures (bool, default False): If True, only</span>
<span class="sd">                experiments with at least one stored performance measure</span>
<span class="sd">                are returned.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame:</span>
<span class="sd">                A DataFrame that contains all uncertainties, levers, and measures</span>
<span class="sd">                for the experiments.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError:</span>
<span class="sd">                If there is no Database connection `db` set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">db</span> <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>
        <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no database to read from&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_dtypes</span><span class="p">(</span>
            <span class="n">db</span><span class="o">.</span><span class="n">read_experiment_all</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">design_name</span><span class="p">,</span>
                <span class="n">only_pending</span><span class="o">=</span><span class="n">only_pending</span><span class="p">,</span>
                <span class="n">only_complete</span><span class="o">=</span><span class="n">only_complete</span><span class="p">,</span>
                <span class="n">only_with_measures</span><span class="o">=</span><span class="n">only_with_measures</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="AbstractCoreModel.read_experiment_parameters">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.read_experiment_parameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_experiment_parameters</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">design_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">only_pending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">experiment_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads uncertainties and levers from a design of experiments from the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            design_name (str, optional): If given, only experiments</span>
<span class="sd">                associated with both the scope and the named design</span>
<span class="sd">                are returned, otherwise all experiments associated</span>
<span class="sd">                with the scope are returned.</span>
<span class="sd">            db (Database, optional): The Database from which to read experiments.</span>
<span class="sd">                If no db is given, the default `db` for this model is used.</span>
<span class="sd">            only_pending (bool, default False): If True, only pending</span>
<span class="sd">                experiments (which have no performance measure results</span>
<span class="sd">                stored in the database) are returned.</span>
<span class="sd">            experiment_ids (Collection, optional):</span>
<span class="sd">                A collection of experiment id&#39;s to load.  If given,</span>
<span class="sd">                both `design_name` and `only_pending` are ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame:</span>
<span class="sd">                A DataFrame that contains all uncertainties, levers, and measures</span>
<span class="sd">                for the experiments.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError:</span>
<span class="sd">                If `db` is not given and there is no default</span>
<span class="sd">                Database connection set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">db</span> <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>

        <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no database to read from&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_dtypes</span><span class="p">(</span>
            <span class="n">db</span><span class="o">.</span><span class="n">read_experiment_parameters</span><span class="p">(</span>
                <span class="n">scope_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">design_name</span><span class="o">=</span><span class="n">design_name</span><span class="p">,</span>
                <span class="n">only_pending</span><span class="o">=</span><span class="n">only_pending</span><span class="p">,</span>
                <span class="n">experiment_ids</span><span class="o">=</span><span class="n">experiment_ids</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="AbstractCoreModel.read_experiment_measures">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.read_experiment_measures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_experiment_measures</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads performance measures from a design of experiments from the database.</span>

<span class="sd">        Args:</span>
<span class="sd">            design_name (str): The name of the design to load.</span>
<span class="sd">            experiment_id (int, optional): The id of the experiment to load.</span>
<span class="sd">            db (Database, optional): The Database from which to read experiment(s).</span>
<span class="sd">                If no db is given, the default `db` for this model is used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame:</span>
<span class="sd">                A DataFrame that contains all uncertainties, levers, and measures</span>
<span class="sd">                for the experiments.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError:</span>
<span class="sd">                If `db` is not given and there is no default</span>
<span class="sd">                Database connection set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">db</span> <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>

        <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no database to read from&#39;</span><span class="p">)</span>

        <span class="n">measures</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">ensure_dtypes</span><span class="p">(</span>
            <span class="n">db</span><span class="o">.</span><span class="n">read_experiment_measures</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># only return measures within scope</span>
        <span class="n">measures</span> <span class="o">=</span> <span class="n">measures</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_measure_names</span><span class="p">()</span>
                             <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">measures</span><span class="o">.</span><span class="n">columns</span><span class="p">]]</span>
        
        <span class="k">return</span> <span class="n">measures</span></div>

        

<div class="viewcode-block" id="AbstractCoreModel.ensure_dtypes">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.ensure_dtypes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ensure_dtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert columns of dataframe to correct dtype as needed.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame): A dataframe with column names</span>
<span class="sd">                that are uncertainties, levers, or measures.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame:</span>
<span class="sd">                The same data as input, but with dtypes as appropriate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">ensure_dtypes</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractCoreModel.design_experiments">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.design_experiments">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">design_experiments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a design of experiments based on this model.</span>

<span class="sd">        Args:</span>
<span class="sd">            n_samples_per_factor (int, default 10): The number of samples in the</span>
<span class="sd">                design per random factor.</span>
<span class="sd">            n_samples (int or tuple, optional): The total number of samples in the</span>
<span class="sd">                design.  If `jointly` is False, this is the number of samples in each</span>
<span class="sd">                of the uncertainties and the levers, the total number of samples will</span>
<span class="sd">                be the square of this value.  Give a 2-tuple to set values for</span>
<span class="sd">                uncertainties and levers respectively, to set them independently.</span>
<span class="sd">                If this argument is given, it overrides `n_samples_per_factor`.</span>
<span class="sd">            random_seed (int or None, default 1234): A random seed for reproducibility.</span>
<span class="sd">            db (Database, optional): If provided, this design will be stored in the</span>
<span class="sd">                database indicated.  If not provided, the `db` for this model will</span>
<span class="sd">                be used, if one is set.</span>
<span class="sd">            design_name (str, optional): A name for this design, to identify it in the</span>
<span class="sd">                database. If not given, a unique name will be generated based on the</span>
<span class="sd">                selected sampler.</span>
<span class="sd">            sampler (str or AbstractSampler, default &#39;lhs&#39;): The sampler to use for this</span>
<span class="sd">                design.  Available pre-defined samplers include:</span>
<span class="sd">                    - &#39;lhs&#39;: Latin Hypercube sampling</span>
<span class="sd">                    - &#39;ulhs&#39;: Uniform Latin Hypercube sampling, which ignores defined</span>
<span class="sd">                        distribution shapes from the scope and samples everything</span>
<span class="sd">                        as if it was from a uniform distribution</span>
<span class="sd">                    - &#39;mc&#39;: Monte carlo sampling</span>
<span class="sd">                    - &#39;uni&#39;: Univariate sensitivity testing, whereby experiments are</span>
<span class="sd">                        generated setting each parameter individually to minimum and</span>
<span class="sd">                        maximum values (for numeric dtypes) or all possible values</span>
<span class="sd">                        (for boolean and categorical dtypes).  Note that designs for</span>
<span class="sd">                        univariate sensitivity testing are deterministic and the number</span>
<span class="sd">                        of samples given is ignored.</span>
<span class="sd">            sample_from (&#39;all&#39;, &#39;uncertainties&#39;, or &#39;levers&#39;): Which scope components</span>
<span class="sd">                from which to sample.  Components not sampled are set at their default</span>
<span class="sd">                values in the design.</span>
<span class="sd">            jointly (bool, default True): Whether to sample jointly all uncertainties</span>
<span class="sd">                and levers in a single design, or, if False, to generate separate samples</span>
<span class="sd">                for levers and uncertainties, and then combine the two in a full-factorial</span>
<span class="sd">                manner.  This argument has no effect unless `sample_from` is &#39;all&#39;.</span>
<span class="sd">                Note that setting `jointly` to False may produce a very large design,</span>
<span class="sd">                as the total number of experiments will be the product of the number of</span>
<span class="sd">                experiments for the levers and the number of experiments for the</span>
<span class="sd">                uncertainties, which are set separately (i.e. if `n_samples` is given,</span>
<span class="sd">                the total number of experiments is the square of that value).</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: The resulting design.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;scope&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;scope&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;db&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;db&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">..experiment</span><span class="w"> </span><span class="kn">import</span> <span class="n">experimental_design</span>
        <span class="k">return</span> <span class="n">experimental_design</span><span class="o">.</span><span class="n">design_experiments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractCoreModel.async_experiments">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.async_experiments">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">async_experiments</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">design</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">design_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">evaluator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">max_n_workers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">stagger_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asynchronously runs a design of combined experiments using this model.</span>

<span class="sd">        A combined experiment includes a complete set of input values for</span>
<span class="sd">        all exogenous uncertainties (a Scenario) and all policy levers</span>
<span class="sd">        (a Policy). Unlike the perform_experiments function in the EMA Workbench,</span>
<span class="sd">        this method pairs each Scenario and Policy in sequence, instead</span>
<span class="sd">        of running all possible combinations of Scenario and Policy.</span>
<span class="sd">        This change ensures compatibility with the EMAT database modules, which</span>
<span class="sd">        preserve the complete set of input information (both uncertainties</span>
<span class="sd">        and levers) for each experiment.  To conduct a full cross-factorial set</span>
<span class="sd">        of experiments similar to the default settings for EMA Workbench,</span>
<span class="sd">        use a factorial design, by setting the `jointly` argument for the</span>
<span class="sd">        `design_experiments` to False, or by designing experiments outside</span>
<span class="sd">        of EMAT with your own approach.</span>

<span class="sd">        Args:</span>
<span class="sd">            design (pandas.DataFrame, optional): experiment definitions</span>
<span class="sd">                given as a DataFrame, where each exogenous uncertainties and</span>
<span class="sd">                policy levers is given as a column, and each row is an experiment.</span>
<span class="sd">            db (Database, required): The database to use for loading and saving experiments.</span>
<span class="sd">                If none is given, the default database for this model is used.</span>
<span class="sd">                If there is no default db, and none is given here,</span>
<span class="sd">                these experiments will be aborted.</span>
<span class="sd">            design_name (str, optional): The name of a design of experiments to</span>
<span class="sd">                load from the database.  This design is only used if</span>
<span class="sd">                `design` is None.</span>
<span class="sd">            evaluator (emat.workbench.Evaluator, optional): Optionally give an</span>
<span class="sd">                evaluator instance.  If not given, a default DistributedEvaluator</span>
<span class="sd">                will be instantiated.  Passing any other kind of evaluator will</span>
<span class="sd">                currently cause an error, although in the future other async</span>
<span class="sd">                compatible evaluators may be provided.</span>
<span class="sd">            max_n_workers (int, optional):</span>
<span class="sd">                The maximum number of workers that will be created for a default</span>
<span class="sd">                dask.distributed LocalCluster.  If the number of cores available is</span>
<span class="sd">                smaller than this number, fewer workers will be spawned.  This value</span>
<span class="sd">                is only used if a default LocalCluster has not yet been created.</span>
<span class="sd">            stagger_start (int, optional):</span>
<span class="sd">                If provided, wait this number of seconds between initial dispatch</span>
<span class="sd">                of experiments to the evaluator.  For models that do a lot of</span>
<span class="sd">                file copying up front, this can prevent over-saturating the file</span>
<span class="sd">                storage system.</span>
<span class="sd">            batch_size (int, optional):</span>
<span class="sd">                For fast-running core models, the overhead from multi-processing</span>
<span class="sd">                can represent a big chunk of overall runtime.  Grouping experiments</span>
<span class="sd">                into batches that are sent to workers as a group can mitigate this.</span>
<span class="sd">                Setting batch_size to 1 will process every experiment separately.</span>
<span class="sd">                If no batch size is given, a guess is made as to an efficient</span>
<span class="sd">                batch_size based on the number of experiments and the number of</span>
<span class="sd">                workers.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError:</span>
<span class="sd">                If there are no experiments defined.  This includes</span>
<span class="sd">                the situation where `design` is given but no database is</span>
<span class="sd">                available.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># catch user gives only a design, not experiment_parameters</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">design</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">design_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">design_name</span><span class="p">,</span> <span class="n">design</span> <span class="o">=</span> <span class="n">design</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">design_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">design</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;must give design_name or design&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>

        <span class="k">if</span> <span class="n">design_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">design</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cannot load design &quot;</span><span class="si">{</span><span class="n">design_name</span><span class="si">}</span><span class="s1">&quot;, there is no db&#39;</span><span class="p">)</span>
            <span class="n">design</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_experiment_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">design</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no experiments available&quot;</span><span class="p">)</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">.asynchronous</span><span class="w"> </span><span class="kn">import</span>  <span class="n">asynchronous_experiments</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cannot run async_experiments without a `db` defined&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">asynchronous_experiments</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">design</span><span class="p">,</span>
            <span class="n">evaluator</span><span class="o">=</span><span class="n">evaluator</span><span class="p">,</span>
            <span class="n">max_n_workers</span><span class="o">=</span><span class="n">max_n_workers</span><span class="p">,</span>
            <span class="n">stagger_start</span><span class="o">=</span><span class="n">stagger_start</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="AbstractCoreModel.run_experiments">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.run_experiments">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_experiments</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">design</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">evaluator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">design_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">allow_short_circuit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs a design of combined experiments using this model.</span>

<span class="sd">        A combined experiment includes a complete set of input values for</span>
<span class="sd">        all exogenous uncertainties (a Scenario) and all policy levers</span>
<span class="sd">        (a Policy). Unlike the perform_experiments function in the EMA Workbench,</span>
<span class="sd">        this method pairs each Scenario and Policy in sequence, instead</span>
<span class="sd">        of running all possible combinations of Scenario and Policy.</span>
<span class="sd">        This change ensures compatibility with the EMAT database modules, which</span>
<span class="sd">        preserve the complete set of input information (both uncertainties</span>
<span class="sd">        and levers) for each experiment.  To conduct a full cross-factorial set</span>
<span class="sd">        of experiments similar to the default settings for EMA Workbench,</span>
<span class="sd">        use a factorial design, by setting the `jointly` argument for the</span>
<span class="sd">        `design_experiments` to False, or by designing experiments outside</span>
<span class="sd">        of EMAT with your own approach.</span>

<span class="sd">        Args:</span>
<span class="sd">            design (pandas.DataFrame, optional): experiment definitions</span>
<span class="sd">                given as a DataFrame, where each exogenous uncertainty and</span>
<span class="sd">                policy levers is given as a column, and each row is an experiment.</span>
<span class="sd">            evaluator (emat.workbench.Evaluator, optional): Optionally give an</span>
<span class="sd">                evaluator instance.  If not given, a default SequentialEvaluator</span>
<span class="sd">                will be instantiated.</span>
<span class="sd">            design_name (str, optional): The name of a design of experiments to</span>
<span class="sd">                load from the database.  This design is only used if</span>
<span class="sd">                `design` is None.</span>
<span class="sd">            db (Database, optional): The database to use for loading and saving experiments.</span>
<span class="sd">                If none is given, the default database for this model is used.</span>
<span class="sd">                If there is no default db, and none is given here,</span>
<span class="sd">                the results are not stored in a database. Set to False to explicitly</span>
<span class="sd">                not use the default database, even if it exists.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame:</span>
<span class="sd">                A DataFrame that contains all uncertainties, levers, and measures</span>
<span class="sd">                for the experiments.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError:</span>
<span class="sd">                If there are no experiments defined.  This includes</span>
<span class="sd">                the situation where `design` is given but no database is</span>
<span class="sd">                available.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">..workbench</span><span class="w"> </span><span class="kn">import</span> <span class="n">Scenario</span><span class="p">,</span> <span class="n">Policy</span><span class="p">,</span> <span class="n">perform_experiments</span>

        <span class="c1"># catch user gives only a design, not experiment_parameters</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">design</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">design_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">design_name</span><span class="p">,</span> <span class="n">design</span> <span class="o">=</span> <span class="n">design</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">design_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">design</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;must give design_name or design&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>

        <span class="k">if</span> <span class="n">design_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">design</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cannot load design &quot;</span><span class="si">{</span><span class="n">design_name</span><span class="si">}</span><span class="s1">&quot;, there is no db&#39;</span><span class="p">)</span>
            <span class="n">design</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_experiment_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">design</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no experiments available&quot;</span><span class="p">)</span>

        <span class="c1"># catch metamodels here and run them as a batch, which is much faster</span>
        <span class="n">function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;function&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.meta_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetaModel</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">MetaModel</span><span class="p">):</span>
            <span class="n">outcomes</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">design</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_dtypes</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
                <span class="n">design</span><span class="p">,</span>
                <span class="n">outcomes</span>
            <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">..experiment.experimental_design</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExperimentalDesign</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">ExperimentalDesign</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span>
            <span class="n">result</span><span class="o">.</span><span class="n">design_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">design</span><span class="p">,</span> <span class="s1">&#39;design_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">sampler_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">design</span><span class="p">,</span> <span class="s1">&#39;sampler_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">db</span><span class="p">:</span>
                <span class="n">metamodel_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metamodel_id</span>
                <span class="k">if</span> <span class="n">metamodel_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">metamodel_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_new_metamodel_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">write_experiment_measures</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">metamodel_id</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="n">scenarios</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">scenario_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">_get_uncertainty_and_constant_names</span><span class="p">()</span>
        <span class="n">design_scenarios</span> <span class="o">=</span> <span class="n">design</span><span class="p">[</span><span class="n">scenario_cols</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">rownum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">design</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">design</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;experiment&#39;</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">Scenario</span><span class="p">(</span>
                    <span class="n">_experiment_id_</span><span class="o">=</span><span class="n">design</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">rownum</span><span class="p">],</span>
                    <span class="o">**</span><span class="n">design_scenarios</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">rownum</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">Scenario</span><span class="p">(</span>
                    <span class="n">_experiment_id_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">design_scenarios</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">rownum</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="n">scenarios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="n">lever_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_lever_names</span><span class="p">()</span>
        <span class="n">policies</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Policy</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incognito</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lever_names</span><span class="p">,</span> <span class="n">i</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">design</span><span class="p">[</span><span class="n">lever_names</span><span class="p">]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ExperimentL&#39;</span><span class="p">))</span>
        <span class="p">]</span>

        <span class="n">evaluator</span> <span class="o">=</span> <span class="n">prepare_evaluator</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="s1">&#39;asynchronous&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="c1"># When the evaluator is in asynchronous mode, the core model runs will be</span>
            <span class="c1"># dispatched here but the function will not block waiting on the result, and</span>
            <span class="c1"># instead depend on the model execution process to write the results into</span>
            <span class="c1"># the database when complete.</span>
            <span class="k">with</span> <span class="n">evaluator</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">allow_short_circuit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">_stored_allow_short_circuit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_short_circuit</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">allow_short_circuit</span> <span class="o">=</span> <span class="n">allow_short_circuit</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_stored_allow_short_circuit</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">perform_experiments</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span>
                        <span class="n">scenarios</span><span class="o">=</span><span class="n">scenarios</span><span class="p">,</span>
                        <span class="n">policies</span><span class="o">=</span><span class="n">policies</span><span class="p">,</span>
                        <span class="n">zip_over</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;scenarios&#39;</span><span class="p">,</span> <span class="s1">&#39;policies&#39;</span><span class="p">},</span>
                        <span class="n">evaluator</span><span class="o">=</span><span class="n">evaluator</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_stored_allow_short_circuit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">allow_short_circuit</span> <span class="o">=</span> <span class="n">_stored_allow_short_circuit</span>
            <span class="k">return</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">evaluator</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">_stored_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_stored_db</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">allow_short_circuit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">_stored_allow_short_circuit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_short_circuit</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">allow_short_circuit</span> <span class="o">=</span> <span class="n">allow_short_circuit</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_stored_allow_short_circuit</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">experiments</span><span class="p">,</span> <span class="n">outcomes</span> <span class="o">=</span> <span class="n">perform_experiments</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span>
                        <span class="n">scenarios</span><span class="o">=</span><span class="n">scenarios</span><span class="p">,</span>
                        <span class="n">policies</span><span class="o">=</span><span class="n">policies</span><span class="p">,</span>
                        <span class="n">zip_over</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;scenarios&#39;</span><span class="p">,</span> <span class="s1">&#39;policies&#39;</span><span class="p">},</span>
                        <span class="n">evaluator</span><span class="o">=</span><span class="n">evaluator</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_stored_db</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">_stored_db</span>
                    <span class="k">if</span> <span class="n">_stored_allow_short_circuit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">allow_short_circuit</span> <span class="o">=</span> <span class="n">_stored_allow_short_circuit</span>
            <span class="n">experiments</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">design</span><span class="o">.</span><span class="n">index</span>

            <span class="n">outcomes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">outcomes</span><span class="p">)</span>
            <span class="n">outcomes</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">design</span><span class="o">.</span><span class="n">index</span>

            <span class="c1"># if db:</span>
            <span class="c1">#     metamodel_id = self.metamodel_id</span>
            <span class="c1">#     if metamodel_id is None:</span>
            <span class="c1">#         metamodel_id = 0</span>
            <span class="c1">#     db.write_experiment_measures(self.scope.name, metamodel_id, outcomes)</span>

            <span class="c1"># Put constants back into experiments</span>
            <span class="n">experiments_</span> <span class="o">=</span> <span class="n">experiments</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;scenario&#39;</span><span class="p">,</span> <span class="s1">&#39;policy&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;_experiment_id_&#39;</span><span class="p">],</span>
                <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_constants</span><span class="p">():</span>
                <span class="n">experiments_</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">value</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_dtypes</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
                <span class="n">experiments_</span><span class="p">,</span>
                <span class="n">outcomes</span>
            <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">..experiment.experimental_design</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExperimentalDesign</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">ExperimentalDesign</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span>
            <span class="n">result</span><span class="o">.</span><span class="n">design_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">design</span><span class="p">,</span> <span class="s1">&#39;design_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">sampler_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">design</span><span class="p">,</span> <span class="s1">&#39;sampler_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="AbstractCoreModel.run_reference_experiment">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.run_reference_experiment">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_reference_experiment</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">evaluator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs a reference experiment using this model.</span>

<span class="sd">        This single experiment includes a complete set of input values for</span>
<span class="sd">        all exogenous uncertainties (a Scenario) and all policy levers</span>
<span class="sd">        (a Policy). Each is set to the default value indicated by the scope.</span>

<span class="sd">        Args:</span>
<span class="sd">            evaluator (emat.workbench.Evaluator, optional): Optionally give an</span>
<span class="sd">                evaluator instance.  If not given, a default SequentialEvaluator</span>
<span class="sd">                will be instantiated.</span>
<span class="sd">            db (Database, optional): The database to use for loading and saving experiments.</span>
<span class="sd">                If none is given, the default database for this model is used.</span>
<span class="sd">                If there is no default db, and none is given here,</span>
<span class="sd">                the results are not stored in a database. Set to False to explicitly</span>
<span class="sd">                not use the default database, even if it exists.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame:</span>
<span class="sd">                A DataFrame that contains all uncertainties, levers, and measures</span>
<span class="sd">                for the experiments.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_experiments</span><span class="p">(</span><span class="n">sampler</span><span class="o">=</span><span class="s1">&#39;ref&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_experiments</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">evaluator</span><span class="o">=</span><span class="n">evaluator</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractCoreModel.create_metamodel_from_data">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.create_metamodel_from_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_metamodel_from_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">experiment_inputs</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
            <span class="n">experiment_outputs</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
            <span class="n">output_transforms</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">metamodel_id</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">include_measures</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">exclude_measures</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">db</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">experiment_stratification</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">suppress_converge_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">regressor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">find_best_metamodeltype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a MetaModel from a set of input and output observations.</span>

<span class="sd">        Args:</span>
<span class="sd">            experiment_inputs (pandas.DataFrame): This dataframe</span>
<span class="sd">                should contain all of the experimental inputs, including</span>
<span class="sd">                values for each uncertainty, level, and constant.</span>
<span class="sd">            experiment_outputs (pandas.DataFrame): This dataframe</span>
<span class="sd">                should contain all of the experimental outputs, including</span>
<span class="sd">                a column for each performance measure. The index</span>
<span class="sd">                for the outputs should match the index for the</span>
<span class="sd">                `experiment_inputs`, so that the I-O matches row-by-row.</span>
<span class="sd">            output_transforms (dict): Deprecated.  Specify the</span>
<span class="sd">                output transforms directly in the scope instead.</span>
<span class="sd">            metamodel_id (int, optional): An identifier for this meta-model.</span>
<span class="sd">                If not given, a unique id number will be created randomly.</span>
<span class="sd">            include_measures (Collection[str], optional): If provided, only</span>
<span class="sd">                output performance measures with names in this set will be included.</span>
<span class="sd">            exclude_measures (Collection[str], optional): If provided, only</span>
<span class="sd">                output performance measures with names not in this set will be included.</span>
<span class="sd">            db (Database, optional): The database to use for loading and saving metamodels.</span>
<span class="sd">                If none is given, the default database for this model is used.</span>
<span class="sd">                If there is no default db, and none is given here,</span>
<span class="sd">                the metamodel is not stored in a database.</span>
<span class="sd">            random_state (int, optional): A random state to use in the metamodel</span>
<span class="sd">                regression fitting.</span>
<span class="sd">            experiment_stratification (pandas.Series, optional):</span>
<span class="sd">                A stratification of experiments, used in cross-validation.</span>
<span class="sd">            suppress_converge_warnings (bool, default False):</span>
<span class="sd">                Suppress convergence warnings during metamodel fitting.</span>
<span class="sd">            regressor (Estimator, optional): A scikit-learn estimator implementing a</span>
<span class="sd">                multi-target regression.  If not given, a detrended simple Gaussian</span>
<span class="sd">                process regression is used.</span>
<span class="sd">            find_best_metamodeltype (int, default 0):</span>
<span class="sd">                Run a search to find the best metamodeltype for each</span>
<span class="sd">                performance measure, repeating each cross-validation</span>
<span class="sd">                step this many times.  For more stable results, choose</span>
<span class="sd">                3 or more, although larger numbers will be slow.  If</span>
<span class="sd">                domain knowledge about the normal expected range and</span>
<span class="sd">                behavior of each performance measure is available,</span>
<span class="sd">                it is better to give the metamodeltype explicitly in</span>
<span class="sd">                the Scope.</span>

<span class="sd">        Returns:</span>
<span class="sd">            MetaModel:</span>
<span class="sd">                a callable object that, when called as if a</span>
<span class="sd">                function, accepts keyword arguments as inputs and</span>
<span class="sd">                returns a dictionary of (measure name: value) pairs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.meta_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_metamodel</span>

        <span class="c1"># The outputs index typically has a 2-level multi-index,</span>
        <span class="c1"># giving both experiment_id and run_id.  But for this</span>
        <span class="c1"># analysis, we will strip out the run_id.</span>
        <span class="k">if</span> <span class="n">experiment_outputs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">nlevels</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">experiment_outputs</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">experiment_outputs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">create_metamodel</span><span class="p">(</span>
            <span class="n">scope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span>
            <span class="n">experiments</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">experiment_inputs</span><span class="p">,</span> <span class="n">experiment_outputs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">metamodel_id</span><span class="o">=</span><span class="n">metamodel_id</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
            <span class="n">include_measures</span><span class="o">=</span><span class="n">include_measures</span><span class="p">,</span>
            <span class="n">exclude_measures</span><span class="o">=</span><span class="n">exclude_measures</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
            <span class="n">experiment_stratification</span><span class="o">=</span><span class="n">experiment_stratification</span><span class="p">,</span>
            <span class="n">suppress_converge_warnings</span><span class="o">=</span><span class="n">suppress_converge_warnings</span><span class="p">,</span>
            <span class="n">regressor</span><span class="o">=</span><span class="n">regressor</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">find_best_metamodeltype</span><span class="o">=</span><span class="n">find_best_metamodeltype</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="AbstractCoreModel.create_metamodel_from_design">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.create_metamodel_from_design">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_metamodel_from_design</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">design_name</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">metamodel_id</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">include_measures</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">exclude_measures</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">suppress_converge_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">regressor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">find_best_metamodeltype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a MetaModel from a set of input and output observations.</span>

<span class="sd">        Args:</span>
<span class="sd">            design_name (str): The name of the design to use.</span>
<span class="sd">            metamodel_id (int, optional): An identifier for this meta-model.</span>
<span class="sd">                If not given, a unique id number will be created randomly.</span>
<span class="sd">            include_measures (Collection[str], optional): If provided, only</span>
<span class="sd">                output performance measures with names in this set will be included.</span>
<span class="sd">            exclude_measures (Collection[str], optional): If provided, only</span>
<span class="sd">                output performance measures with names not in this set will be included.</span>
<span class="sd">            random_state (int, optional): A random state to use in the metamodel</span>
<span class="sd">                regression fitting.</span>
<span class="sd">            suppress_converge_warnings (bool, default False):</span>
<span class="sd">                Suppress convergence warnings during metamodel fitting.</span>
<span class="sd">            regressor (Estimator, optional): A scikit-learn estimator implementing a</span>
<span class="sd">                multi-target regression.  If not given, a detrended simple Gaussian</span>
<span class="sd">                process regression is used.</span>
<span class="sd">            find_best_metamodeltype (int, default 0):</span>
<span class="sd">                Run a search to find the best metamodeltype for each</span>
<span class="sd">                performance measure, repeating each cross-validation</span>
<span class="sd">                step this many times.  For more stable results, choose</span>
<span class="sd">                3 or more, although larger numbers will be slow.  If</span>
<span class="sd">                domain knowledge about the normal expected range and</span>
<span class="sd">                behavior of each performance measure is available,</span>
<span class="sd">                it is better to give the metamodeltype explicitly in</span>
<span class="sd">                the Scope.</span>

<span class="sd">        Returns:</span>
<span class="sd">            MetaModel:</span>
<span class="sd">                a callable object that, when called as if a</span>
<span class="sd">                function, accepts keyword arguments as inputs and</span>
<span class="sd">                returns a dictionary of (measure name: value) pairs.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the named design still has pending experiments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">db</span> <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>

        <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;db is None&quot;</span><span class="p">)</span>

        <span class="n">check_df</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_experiment_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">,</span> <span class="n">only_pending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">..exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">PendingExperimentsError</span>
            <span class="k">raise</span> <span class="n">PendingExperimentsError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;design &quot;</span><span class="si">{</span><span class="n">design_name</span><span class="si">}</span><span class="s1">&quot; has pending experiments&#39;</span><span class="p">)</span>

        <span class="n">experiment_inputs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_experiment_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">)</span>
        <span class="n">experiment_outputs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_experiment_measures</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">)</span>

        <span class="n">transforms</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">metamodeltype</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_measures</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_metamodel_from_data</span><span class="p">(</span>
            <span class="n">experiment_inputs</span><span class="p">,</span>
            <span class="n">experiment_outputs</span><span class="p">,</span>
            <span class="n">transforms</span><span class="p">,</span>
            <span class="n">metamodel_id</span><span class="o">=</span><span class="n">metamodel_id</span><span class="p">,</span>
            <span class="n">include_measures</span><span class="o">=</span><span class="n">include_measures</span><span class="p">,</span>
            <span class="n">exclude_measures</span><span class="o">=</span><span class="n">exclude_measures</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
            <span class="n">suppress_converge_warnings</span><span class="o">=</span><span class="n">suppress_converge_warnings</span><span class="p">,</span>
            <span class="n">regressor</span><span class="o">=</span><span class="n">regressor</span><span class="p">,</span>
            <span class="n">find_best_metamodeltype</span><span class="o">=</span><span class="n">find_best_metamodeltype</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="AbstractCoreModel.create_metamodel_from_designs">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.create_metamodel_from_designs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_metamodel_from_designs</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">design_names</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">metamodel_id</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">include_measures</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">exclude_measures</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">suppress_converge_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a MetaModel from multiple sets of input and output observations.</span>

<span class="sd">        Args:</span>
<span class="sd">            design_names (Collection[str]): The names of the designs to use.</span>
<span class="sd">            metamodel_id (int, optional): An identifier for this meta-model.</span>
<span class="sd">                If not given, a unique id number will be created randomly.</span>
<span class="sd">            include_measures (Collection[str], optional): If provided, only</span>
<span class="sd">                output performance measures with names in this set will be included.</span>
<span class="sd">            exclude_measures (Collection[str], optional): If provided, only</span>
<span class="sd">                output performance measures with names not in this set will be included.</span>
<span class="sd">            random_state (int, optional): A random state to use in the metamodel</span>
<span class="sd">                regression fitting.</span>
<span class="sd">            suppress_converge_warnings (bool, default False):</span>
<span class="sd">                Suppress convergence warnings during metamodel fitting.</span>

<span class="sd">        Returns:</span>
<span class="sd">            MetaModel:</span>
<span class="sd">                a callable object that, when called as if a</span>
<span class="sd">                function, accepts keyword arguments as inputs and</span>
<span class="sd">                returns a dictionary of (measure name: value) pairs.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the named design still has pending experiments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">db</span> <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>

        <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">design_name</span> <span class="ow">in</span> <span class="n">design_names</span><span class="p">:</span>
                <span class="n">check_df</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_experiment_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">,</span> <span class="n">only_pending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">check_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">..exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">PendingExperimentsError</span>
                    <span class="k">raise</span> <span class="n">PendingExperimentsError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;design &quot;</span><span class="si">{</span><span class="n">design_name</span><span class="si">}</span><span class="s1">&quot; has pending experiments&#39;</span><span class="p">)</span>

        <span class="n">experiment_inputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">design_name</span> <span class="ow">in</span> <span class="n">design_names</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_experiment_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">)</span>
            <span class="n">f</span><span class="p">[</span><span class="s1">&#39;_design_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">design_name</span>
            <span class="n">experiment_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">experiment_inputs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">experiment_inputs</span><span class="p">)</span>

        <span class="n">experiment_outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">design_name</span> <span class="ow">in</span> <span class="n">design_names</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span>  <span class="n">db</span><span class="o">.</span><span class="n">read_experiment_measures</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">design_name</span><span class="p">)</span>
            <span class="c1"># f[&#39;_design_&#39;] = design_name</span>
            <span class="n">experiment_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">experiment_outputs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">experiment_outputs</span><span class="p">)</span>

        <span class="n">transforms</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">metamodeltype</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_measures</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_metamodel_from_data</span><span class="p">(</span>
            <span class="n">experiment_inputs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;_design_&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">experiment_outputs</span><span class="p">,</span>
            <span class="n">transforms</span><span class="p">,</span>
            <span class="n">metamodel_id</span><span class="o">=</span><span class="n">metamodel_id</span><span class="p">,</span>
            <span class="n">include_measures</span><span class="o">=</span><span class="n">include_measures</span><span class="p">,</span>
            <span class="n">exclude_measures</span><span class="o">=</span><span class="n">exclude_measures</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
            <span class="n">experiment_stratification</span><span class="o">=</span><span class="n">experiment_inputs</span><span class="p">[</span><span class="s1">&#39;_design_&#39;</span><span class="p">],</span>
            <span class="n">suppress_converge_warnings</span><span class="o">=</span><span class="n">suppress_converge_warnings</span><span class="p">,</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="AbstractCoreModel.feature_scores">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.feature_scores">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">feature_scores</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">design</span><span class="p">,</span>
            <span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;styled&#39;</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
            <span class="n">measures</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">shortnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate feature scores based on a design of experiments.</span>

<span class="sd">        This method is provided as a convenient pass-through to the</span>
<span class="sd">        `feature_scores` function in the `analysis` sub-package, using</span>
<span class="sd">        the scope and database attached to this model.</span>

<span class="sd">        Args:</span>
<span class="sd">            design (str or pandas.DataFrame): The name of the design</span>
<span class="sd">                of experiments to use for feature scoring, or a single</span>
<span class="sd">                pandas.DataFrame containing the experimental design and</span>
<span class="sd">                results.</span>
<span class="sd">            return_type ({&#39;styled&#39;, &#39;figure&#39;, &#39;dataframe&#39;}):</span>
<span class="sd">                The format to return, either a heatmap figure as an SVG</span>
<span class="sd">                render in and xmle.Elem, or a plain pandas.DataFrame,</span>
<span class="sd">                or a styled dataframe.</span>
<span class="sd">            random_state (int or numpy.RandomState, optional):</span>
<span class="sd">                Random state to use.</span>
<span class="sd">            cmap (string or colormap, default &#39;viridis&#39;): matplotlib</span>
<span class="sd">                colormap to use for rendering.</span>
<span class="sd">            measures (Collection, optional): The performance measures</span>
<span class="sd">                on which feature scores are to be generated.  By default,</span>
<span class="sd">                all measures are included.</span>

<span class="sd">        Returns:</span>
<span class="sd">            xmle.Elem or pandas.DataFrame:</span>
<span class="sd">                Returns a rendered SVG as xml, or a DataFrame,</span>
<span class="sd">                depending on the `return_type` argument.</span>

<span class="sd">        This function internally uses feature_scoring from the EMA Workbench, which in turn</span>
<span class="sd">        scores features using the &quot;extra trees&quot; regression approach.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">..analysis.feature_scoring</span><span class="w"> </span><span class="kn">import</span> <span class="n">feature_scores</span>
        <span class="k">if</span> <span class="n">shortnames</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">shortnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span>
        <span class="k">return</span> <span class="n">feature_scores</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span>
            <span class="n">design</span><span class="o">=</span><span class="n">design</span><span class="p">,</span>
            <span class="n">return_type</span><span class="o">=</span><span class="n">return_type</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="n">measures</span><span class="o">=</span><span class="n">measures</span><span class="p">,</span>
            <span class="n">shortnames</span><span class="o">=</span><span class="n">shortnames</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_feature_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deprecated, use `Model.feature_scores`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># for compatability with prior versions of TMIP-EMAT</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_scores</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_common_optimization_setup</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">epsilons</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">convergence</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
            <span class="n">display_convergence</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">evaluator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numbers</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">epsilons</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
            <span class="n">epsilons</span> <span class="o">=</span> <span class="p">[</span><span class="n">epsilons</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcomes</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">convergence</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
            <span class="n">convergence</span> <span class="o">=</span> <span class="n">ConvergenceMetrics</span><span class="p">(</span>
                <span class="n">EpsilonProgress</span><span class="p">(),</span>
                <span class="n">SolutionCount</span><span class="p">(),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">display_convergence</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">convergence</span><span class="p">,</span> <span class="n">ConvergenceMetrics</span><span class="p">):</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>
            <span class="n">display</span><span class="p">(</span><span class="n">convergence</span><span class="p">)</span>

        <span class="n">evaluator</span> <span class="o">=</span> <span class="n">prepare_evaluator</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">epsilons</span><span class="p">,</span> <span class="n">convergence</span><span class="p">,</span> <span class="n">display_convergence</span><span class="p">,</span> <span class="n">evaluator</span>

<div class="viewcode-block" id="AbstractCoreModel.optimize">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.optimize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">searchover</span><span class="o">=</span><span class="s1">&#39;levers&#39;</span><span class="p">,</span>
            <span class="n">evaluator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">nfe</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
            <span class="n">convergence</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
            <span class="n">display_convergence</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">convergence_freq</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">reference</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">reverse_targets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">epsilons</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
            <span class="n">min_epsilon</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">cache_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">check_extremes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform multi-objective optimization over levers or uncertainties.</span>

<span class="sd">        The targets for the multi-objective optimization (i.e. whether each</span>
<span class="sd">        individual performance measures is to be maximized or minimized) are</span>
<span class="sd">        read from the model&#39;s scope.</span>

<span class="sd">        Args:</span>
<span class="sd">            searchover ({&#39;levers&#39;, &#39;uncertainties&#39;}):</span>
<span class="sd">                Which group of inputs to search over.  The other group</span>
<span class="sd">                will be set at their default values, unless other values</span>
<span class="sd">                are provided in the `reference` argument.</span>
<span class="sd">            evaluator (Evaluator, optional): The evaluator to use to</span>
<span class="sd">                run the model. If not given, a SequentialEvaluator will</span>
<span class="sd">                be created.</span>
<span class="sd">            nfe (int, default 10_000): Number of function evaluations.</span>
<span class="sd">                This generally needs to be fairly large to achieve stable</span>
<span class="sd">                results in all but the most trivial applications.</span>
<span class="sd">            convergence (&#39;default&#39;, None, or emat.optimization.ConvergenceMetrics):</span>
<span class="sd">                A convergence display during optimization.  The default</span>
<span class="sd">                value is to report the epsilon-progress (the number of</span>
<span class="sd">                solutions that ever enter the candidate pool of non-dominated</span>
<span class="sd">                solutions) and the number of solutions remaining in that candidate</span>
<span class="sd">                pool.  Pass `None` explicitly to disable convergence tracking.</span>
<span class="sd">            display_convergence (bool, default True): Whether to automatically</span>
<span class="sd">                display figures that dynamically track convergence.  Set to</span>
<span class="sd">                `False` if you are not using this method within a Jupyter</span>
<span class="sd">                interactive environment.</span>
<span class="sd">            convergence_freq (int, default 100): How frequently to update the</span>
<span class="sd">                convergence measures.  There is some computational overhead to</span>
<span class="sd">                these convergence updates, so setting a value too small may</span>
<span class="sd">                noticeably slow down the process.</span>
<span class="sd">            constraints (Collection[Constraint], optional):</span>
<span class="sd">                Solutions will be constrained to only include values that</span>
<span class="sd">                satisfy these constraints. The constraints can be based on</span>
<span class="sd">                the search parameters (levers or uncertainties, depending on the</span>
<span class="sd">                value given for `searchover`), or performance measures, or</span>
<span class="sd">                some combination thereof.</span>
<span class="sd">            reference (Mapping): A set of values for the non-active inputs,</span>
<span class="sd">                i.e. the uncertainties if `searchover` is &#39;levers&#39;, or the</span>
<span class="sd">                levers if `searchover` is &#39;uncertainties&#39;.  Any values not</span>
<span class="sd">                set here revert to the default values identified in the scope.</span>
<span class="sd">            reverse_targets (bool, default False): Whether to reverse the</span>
<span class="sd">                optimization targets given in the scope (i.e., changing</span>
<span class="sd">                minimize to maximize, or vice versa).  This will result in</span>
<span class="sd">                the optimization searching for the worst outcomes, instead of</span>
<span class="sd">                the best outcomes.</span>
<span class="sd">            algorithm (platypus.Algorithm, optional): Select an</span>
<span class="sd">                algorithm for multi-objective optimization.  The default</span>
<span class="sd">                algorithm is EpsNSGAII. See `platypus` documentation for details.</span>
<span class="sd">            epsilons (float or array-like): Used to limit the number of</span>
<span class="sd">                distinct solutions generated.  Set to a larger value to get</span>
<span class="sd">                fewer distinct solutions.</span>
<span class="sd">            cache_dir (path-like, optional): A directory in which to</span>
<span class="sd">                cache results.  Most of the arguments will be hashed</span>
<span class="sd">                to develop a unique filename for these results, making this</span>
<span class="sd">                generally safer than `cache_file`.</span>
<span class="sd">            cache_file (path-like, optional): A file into which to</span>
<span class="sd">                cache results.  If this file exists, the contents of the</span>
<span class="sd">                file will be loaded and all other arguments are ignored.</span>
<span class="sd">                Use with great caution.</span>
<span class="sd">            kwargs: Any additional arguments will be passed on to the</span>
<span class="sd">                platypus algorithm.</span>

<span class="sd">        Returns:</span>
<span class="sd">            emat.OptimizationResult:</span>
<span class="sd">                The set of non-dominated solutions found.</span>
<span class="sd">                When `convergence` is given, the convergence measures are</span>
<span class="sd">                included, as a pandas.DataFrame in the `convergence` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">..util.disk_cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_cache_if_available</span><span class="p">,</span> <span class="n">save_cache</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">algorithm</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">algorithm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alg</span> <span class="o">=</span> <span class="n">algorithm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alg</span> <span class="o">=</span> <span class="n">algorithm</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">if</span> <span class="n">reference</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">..workbench</span><span class="w"> </span><span class="kn">import</span> <span class="n">Policy</span><span class="p">,</span> <span class="n">Scenario</span>
            <span class="k">if</span> <span class="n">searchover</span> <span class="o">==</span> <span class="s1">&#39;levers&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">Scenario</span><span class="p">):</span>
                <span class="n">reference</span> <span class="o">=</span> <span class="n">Scenario</span><span class="p">(</span><span class="s2">&quot;ReferenceScenario&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">reference</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">searchover</span> <span class="o">==</span> <span class="s1">&#39;uncertainties&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">Policy</span><span class="p">):</span>
                <span class="n">reference</span> <span class="o">=</span> <span class="n">Policy</span><span class="p">(</span><span class="s2">&quot;ReferencePolicy&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">reference</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">searchover</span> <span class="o">==</span> <span class="s1">&#39;levers&#39;</span><span class="p">:</span>
                <span class="n">reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">default_scenario</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">searchover</span> <span class="o">==</span> <span class="s1">&#39;uncertainties&#39;</span><span class="p">:</span>
                <span class="n">reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">default_policy</span><span class="p">()</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">cache_file</span> <span class="o">=</span> <span class="n">load_cache_if_available</span><span class="p">(</span>
            <span class="n">cache_file</span><span class="o">=</span><span class="n">cache_file</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
            <span class="n">searchover</span><span class="o">=</span><span class="n">searchover</span><span class="p">,</span>
            <span class="n">nfe</span><span class="o">=</span><span class="n">nfe</span><span class="p">,</span>
            <span class="n">convergence</span><span class="o">=</span><span class="n">convergence</span><span class="p">,</span>
            <span class="n">convergence_freq</span><span class="o">=</span><span class="n">convergence_freq</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
            <span class="n">reference</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span>
            <span class="n">reverse_targets</span><span class="o">=</span><span class="n">reverse_targets</span><span class="p">,</span>
            <span class="n">algorithm</span><span class="o">=</span><span class="n">alg</span><span class="p">,</span>
            <span class="n">epsilons</span><span class="o">=</span><span class="n">epsilons</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">epsilons</span><span class="p">,</span> <span class="n">convergence</span><span class="p">,</span> <span class="n">display_convergence</span><span class="p">,</span> <span class="n">evaluator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_common_optimization_setup</span><span class="p">(</span>
                <span class="n">epsilons</span><span class="p">,</span> <span class="n">convergence</span><span class="p">,</span> <span class="n">display_convergence</span><span class="p">,</span> <span class="n">evaluator</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">reverse_targets</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_measures</span><span class="p">():</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">kind_original</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">kind</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">kind</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>

            <span class="n">_db_pause</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">with</span> <span class="n">evaluator</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">epsilons</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">..workbench</span><span class="w"> </span><span class="kn">import</span> <span class="n">perform_experiments</span>
                        <span class="k">if</span> <span class="n">searchover</span> <span class="o">==</span> <span class="s1">&#39;levers&#39;</span><span class="p">:</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">trial_outcomes</span> <span class="o">=</span> <span class="n">perform_experiments</span><span class="p">(</span>
                                <span class="bp">self</span><span class="p">,</span>
                                <span class="n">scenarios</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span>
                                <span class="n">policies</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                                <span class="n">evaluator</span><span class="o">=</span><span class="n">evaluator</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">trial_outcomes</span> <span class="o">=</span> <span class="n">perform_experiments</span><span class="p">(</span>
                                <span class="bp">self</span><span class="p">,</span>
                                <span class="n">scenarios</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                                <span class="n">policies</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span>
                                <span class="n">evaluator</span><span class="o">=</span><span class="n">evaluator</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="n">epsilons</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">min_epsilon</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">trial_outcomes</span><span class="p">[</span><span class="n">mn</span><span class="p">])</span> <span class="o">/</span> <span class="mi">20</span><span class="p">)</span> <span class="k">for</span> <span class="n">mn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_measure_names</span><span class="p">()]</span>

                    <span class="n">results</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span>
                        <span class="n">searchover</span><span class="o">=</span><span class="n">searchover</span><span class="p">,</span>
                        <span class="n">reference</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span>
                        <span class="n">nfe</span><span class="o">=</span><span class="n">nfe</span><span class="p">,</span>
                        <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
                        <span class="n">convergence</span><span class="o">=</span><span class="n">convergence</span><span class="p">,</span>
                        <span class="n">convergence_freq</span><span class="o">=</span><span class="n">convergence_freq</span><span class="p">,</span>
                        <span class="n">epsilons</span><span class="o">=</span><span class="n">epsilons</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">results</span><span class="p">,</span> <span class="n">result_convergence</span> <span class="o">=</span> <span class="n">results</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result_convergence</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="c1"># Put constants back in to results</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_constants</span><span class="p">():</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">value</span>

                    <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_dtypes</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">OptimizationResult</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">result_convergence</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">searchover</span> <span class="o">==</span> <span class="s1">&#39;levers&#39;</span><span class="p">:</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">scenarios</span> <span class="o">=</span> <span class="n">reference</span>
                    <span class="k">elif</span> <span class="n">searchover</span> <span class="o">==</span> <span class="s1">&#39;uncertainties&#39;</span><span class="p">:</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">policies</span> <span class="o">=</span> <span class="n">reference</span>

                    <span class="k">if</span> <span class="n">check_extremes</span><span class="p">:</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">check_extremes</span><span class="p">(</span>
                            <span class="bp">self</span><span class="p">,</span>
                            <span class="mi">1</span> <span class="k">if</span> <span class="n">check_extremes</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">check_extremes</span><span class="p">,</span>
                            <span class="n">evaluator</span><span class="o">=</span><span class="n">evaluator</span><span class="p">,</span>
                            <span class="n">searchover</span><span class="o">=</span><span class="n">searchover</span><span class="p">,</span>
                            <span class="n">robust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="p">)</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">reverse_targets</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_measures</span><span class="p">():</span>
                        <span class="n">k</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">kind_original</span>
                        <span class="k">del</span> <span class="n">k</span><span class="o">.</span><span class="n">kind_original</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">_db_pause</span>

        <span class="k">elif</span> <span class="n">display_convergence</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">convergence</span><span class="p">,</span> <span class="n">display_convergence</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_common_optimization_setup</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span> <span class="n">convergence</span><span class="p">,</span> <span class="n">display_convergence</span><span class="p">,</span> <span class="kc">False</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convergence</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">rebuild</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">convergence</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="n">x</span><span class="o">.</span><span class="n">cache_file</span> <span class="o">=</span> <span class="n">cache_file</span>
        <span class="n">save_cache</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cache_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="AbstractCoreModel.robust_optimize">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.robust_optimize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">robust_optimize</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">robustness_functions</span><span class="p">,</span>
            <span class="n">scenarios</span><span class="p">,</span>
            <span class="n">evaluator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">nfe</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
            <span class="n">convergence</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
            <span class="n">display_convergence</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">convergence_freq</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">epsilons</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">cache_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">check_extremes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform robust optimization.</span>

<span class="sd">        The robust optimization generally a multi-objective optimization task.</span>
<span class="sd">        It is undertaken using statistical measures of outcomes evaluated across</span>
<span class="sd">        a number of scenarios, instead of using the individual outcomes themselves.</span>
<span class="sd">        For each candidate policy, the model is evaluated against all of the considered</span>
<span class="sd">        scenarios, and then the robustness measures are evaluated using the</span>
<span class="sd">        set of outcomes from the original runs.  The robustness measures</span>
<span class="sd">        are aggregate measures that are computed from a set of outcomes.</span>
<span class="sd">        For example, this may be expected value, median, n-th percentile,</span>
<span class="sd">        minimum, or maximum value of any individual outcome.  It is also</span>
<span class="sd">        possible to have joint measures, e.g. expected value of the larger</span>
<span class="sd">        of outcome 1 or outcome 2.</span>

<span class="sd">        Each robustness function is indicated as a maximization or minimization</span>
<span class="sd">        target, where higher or lower values are better, respectively.</span>
<span class="sd">        The optimization process then tries to identify one or more</span>
<span class="sd">        non-dominated solutions for the possible policy levers.</span>

<span class="sd">        Args:</span>
<span class="sd">            robustness_functions (Collection[Measure]): A collection of</span>
<span class="sd">                aggregate statistical performance measures.</span>
<span class="sd">            scenarios (int or Collection): A collection of scenarios to</span>
<span class="sd">                use in the evaluation(s), or give an integer to generate</span>
<span class="sd">                that number of random scenarios.</span>
<span class="sd">            evaluator (Evaluator, optional): The evaluator to use to</span>
<span class="sd">                run the model. If not given, a SequentialEvaluator will</span>
<span class="sd">                be created.</span>
<span class="sd">            nfe (int, default 10_000): Number of function evaluations.</span>
<span class="sd">                This generally needs to be fairly large to achieve stable</span>
<span class="sd">                results in all but the most trivial applications.</span>
<span class="sd">            convergence (&#39;default&#39;, None, or emat.optimization.ConvergenceMetrics):</span>
<span class="sd">                A convergence display during optimization.</span>
<span class="sd">            display_convergence (bool, default True): Automatically display</span>
<span class="sd">                the convergence metric figures when optimizing.</span>
<span class="sd">            convergence_freq (int, default 100): The frequency at which</span>
<span class="sd">                convergence metric figures are updated.</span>
<span class="sd">            constraints (Collection[Constraint], optional)</span>
<span class="sd">                Solutions will be constrained to only include values that</span>
<span class="sd">                satisfy these constraints. The constraints can be based on</span>
<span class="sd">                the policy levers, or on the computed values of the robustness</span>
<span class="sd">                functions, or some combination thereof.</span>
<span class="sd">            epsilons (float or array-like): Used to limit the number of</span>
<span class="sd">                distinct solutions generated.  Set to a larger value to get</span>
<span class="sd">                fewer distinct solutions.</span>
<span class="sd">            cache_dir (path-like, optional): A directory in which to</span>
<span class="sd">                cache results.  Most of the arguments will be hashed</span>
<span class="sd">                to develop a unique filename for these results, making this</span>
<span class="sd">                generally safer than `cache_file`.</span>
<span class="sd">            cache_file (path-like, optional): A file into which to</span>
<span class="sd">                cache results.  If this file exists, the contents of the</span>
<span class="sd">                file will be loaded and all other arguments are ignored.</span>
<span class="sd">                Use with great caution.</span>
<span class="sd">            algorithm (platypus.Algorithm or str, optional): Select an</span>
<span class="sd">                algorithm for multi-objective optimization.  The algorithm can</span>
<span class="sd">                be given directly, or named in a string. See `platypus`</span>
<span class="sd">                documentation for details.</span>
<span class="sd">            check_extremes (bool or int, default False): Conduct additional</span>
<span class="sd">                evaluations, setting individual policy levers to their</span>
<span class="sd">                extreme values, for each candidate Pareto optimal solution.</span>
<span class="sd">            kwargs: any additional arguments will be passed on to the</span>
<span class="sd">                platypus algorithm.</span>

<span class="sd">        Returns:</span>
<span class="sd">            emat.OptimizationResult:</span>
<span class="sd">                The set of non-dominated solutions found.</span>
<span class="sd">                When `convergence` is given, the convergence measures are</span>
<span class="sd">                included, as a pandas.DataFrame in the `convergence` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">..optimization.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">robust_optimize</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">..util.disk_cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_cache_if_available</span><span class="p">,</span> <span class="n">save_cache</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">algorithm</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">algorithm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">alg</span> <span class="o">=</span> <span class="n">algorithm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alg</span> <span class="o">=</span> <span class="n">algorithm</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">cache_file</span> <span class="o">=</span> <span class="n">load_cache_if_available</span><span class="p">(</span>
            <span class="n">cache_file</span><span class="o">=</span><span class="n">cache_file</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
            <span class="n">scenarios</span><span class="o">=</span><span class="n">scenarios</span><span class="p">,</span>
            <span class="n">convergence</span><span class="o">=</span><span class="n">convergence</span><span class="p">,</span>
            <span class="n">convergence_freq</span><span class="o">=</span><span class="n">convergence_freq</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
            <span class="n">epsilons</span><span class="o">=</span><span class="n">epsilons</span><span class="p">,</span>
            <span class="n">nfe</span><span class="o">=</span><span class="n">nfe</span><span class="p">,</span>
            <span class="n">robustness_functions</span><span class="o">=</span><span class="n">robustness_functions</span><span class="p">,</span>
            <span class="n">alg</span><span class="o">=</span><span class="n">alg</span><span class="p">,</span>
            <span class="n">check_extremes</span><span class="o">=</span><span class="n">check_extremes</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_db_pause</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">robust_optimize</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">robustness_functions</span><span class="p">,</span>
                    <span class="n">scenarios</span><span class="p">,</span>
                    <span class="n">evaluator</span><span class="o">=</span><span class="n">evaluator</span><span class="p">,</span>
                    <span class="n">nfe</span><span class="o">=</span><span class="n">nfe</span><span class="p">,</span>
                    <span class="n">convergence</span><span class="o">=</span><span class="n">convergence</span><span class="p">,</span>
                    <span class="n">display_convergence</span><span class="o">=</span><span class="n">display_convergence</span><span class="p">,</span>
                    <span class="n">convergence_freq</span><span class="o">=</span><span class="n">convergence_freq</span><span class="p">,</span>
                    <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
                    <span class="n">epsilons</span><span class="o">=</span><span class="n">epsilons</span><span class="p">,</span>
                    <span class="n">check_extremes</span><span class="o">=</span><span class="n">check_extremes</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">_db_pause</span>
        <span class="k">elif</span> <span class="n">display_convergence</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">convergence</span><span class="p">,</span> <span class="n">display_convergence</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_common_optimization_setup</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span> <span class="n">convergence</span><span class="p">,</span> <span class="n">display_convergence</span><span class="p">,</span> <span class="kc">False</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convergence</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">rebuild</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">convergence</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="n">result</span><span class="o">.</span><span class="n">cache_file</span> <span class="o">=</span> <span class="n">cache_file</span>
        <span class="n">save_cache</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">cache_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="AbstractCoreModel.robust_evaluate">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.robust_evaluate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">robust_evaluate</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">robustness_functions</span><span class="p">,</span>
            <span class="n">scenarios</span><span class="p">,</span>
            <span class="n">policies</span><span class="p">,</span>
            <span class="n">evaluator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">suspend_db</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform robust evaluation(s).</span>

<span class="sd">        The robust evaluation is used to generate statistical measures</span>
<span class="sd">        of outcomes, instead of generating the individual outcomes themselves.</span>
<span class="sd">        For each policy, the model is evaluated against all of the considered</span>
<span class="sd">        scenarios, and then the robustness measures are evaluated using the</span>
<span class="sd">        set of outcomes from the original runs.  The robustness measures</span>
<span class="sd">        are aggregate measures that are computed from a set of outcomes.</span>
<span class="sd">        For example, this may be expected value, median, n-th percentile,</span>
<span class="sd">        minimum, or maximum value of any individual outcome.  It is also</span>
<span class="sd">        possible to have joint measures, e.g. expected value of the larger</span>
<span class="sd">        of outcome 1 or outcome 2.</span>

<span class="sd">        Args:</span>
<span class="sd">            robustness_functions (Collection[Measure]): A collection of</span>
<span class="sd">                aggregate statistical performance measures.</span>
<span class="sd">            scenarios (int or Collection): A collection of scenarios to</span>
<span class="sd">                use in the evaluation(s), or give an integer to generate</span>
<span class="sd">                that number of random scenarios.</span>
<span class="sd">            policies (int, or collection): A collection of policies to</span>
<span class="sd">                use in the evaluation(s), or give an integer to generate</span>
<span class="sd">                that number of random policies.</span>
<span class="sd">            evaluator (Evaluator, optional): The evaluator to use to</span>
<span class="sd">                run the model. If not given, a SequentialEvaluator will</span>
<span class="sd">                be created.</span>
<span class="sd">            cache_dir (path-like, optional): A directory in which to</span>
<span class="sd">                cache results.</span>
<span class="sd">            suspend_db (bool, default True):</span>
<span class="sd">                Suspend writing the results of individual model runs to</span>
<span class="sd">                the database.  Robust evaluation potentially generates a</span>
<span class="sd">                large number of model executions, and storing all these</span>
<span class="sd">                individual results may not be useful.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: The computed value of each item</span>
<span class="sd">                in `robustness_functions`, for each policy in `policies`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">robust_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cache_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">cache_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">..util.hasher</span><span class="w"> </span><span class="kn">import</span> <span class="n">hash_it</span>
                <span class="n">hh</span> <span class="o">=</span> <span class="n">hash_it</span><span class="p">(</span>
                    <span class="n">scenarios</span><span class="p">,</span>
                    <span class="n">policies</span><span class="p">,</span>
                    <span class="n">robustness_functions</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span><span class="n">hh</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span><span class="n">hh</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">cache_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span><span class="n">hh</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span><span class="n">hh</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span><span class="n">hh</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span><span class="o">+</span><span class="s2">&quot;.gz&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cache_file</span><span class="p">):</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;loading from cache_file=</span><span class="si">{</span><span class="n">cache_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">..util.filez</span><span class="w"> </span><span class="kn">import</span> <span class="n">load</span>
                    <span class="n">robust_results</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">cache_file</span><span class="p">)</span>
                    <span class="n">cache_file</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;unable to manage cache&#39;</span><span class="p">)</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">robust_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_db</span><span class="p">(</span><span class="n">suspend_db</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">evaluator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">..workbench.em_framework</span><span class="w"> </span><span class="kn">import</span> <span class="n">SequentialEvaluator</span>
                    <span class="n">evaluator</span> <span class="o">=</span> <span class="n">SequentialEvaluator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="n">BaseEvaluator</span><span class="p">):</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">dask.distributed</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="n">Client</span><span class="p">):</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">..workbench.em_framework.ema_distributed</span><span class="w"> </span><span class="kn">import</span> <span class="n">DistributedEvaluator</span>
                        <span class="n">evaluator</span> <span class="o">=</span> <span class="n">DistributedEvaluator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">evaluator</span><span class="p">)</span>

                <span class="kn">from</span><span class="w"> </span><span class="nn">..workbench.em_framework.samplers</span><span class="w"> </span><span class="kn">import</span> <span class="n">sample_uncertainties</span><span class="p">,</span> <span class="n">sample_levers</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scenarios</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">n_scenarios</span> <span class="o">=</span> <span class="n">scenarios</span>
                    <span class="n">scenarios</span> <span class="o">=</span> <span class="n">sample_uncertainties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_scenarios</span><span class="p">)</span>

                <span class="k">with</span> <span class="n">evaluator</span><span class="p">:</span>
                    <span class="n">robust_results</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">robust_evaluate</span><span class="p">(</span>
                        <span class="n">robustness_functions</span><span class="p">,</span>
                        <span class="n">scenarios</span><span class="p">,</span>
                        <span class="n">policies</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="n">robust_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_dtypes</span><span class="p">(</span><span class="n">robust_results</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cache_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">..util.filez</span><span class="w"> </span><span class="kn">import</span> <span class="n">save</span>
            <span class="n">save</span><span class="p">(</span><span class="n">robust_results</span><span class="p">,</span> <span class="n">cache_file</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cache_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.gz&#39;</span><span class="p">,</span><span class="s1">&#39;.info.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">notes</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;scenarios=&quot;</span><span class="p">,</span> <span class="n">scenarios</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">notes</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;robustness_functions=&quot;</span><span class="p">,</span> <span class="n">robustness_functions</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">notes</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;policies=&quot;</span><span class="p">,</span> <span class="n">policies</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">notes</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">robust_results</span></div>


<div class="viewcode-block" id="AbstractCoreModel.io_experiment">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.io_experiment">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">io_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run an experiment, and return a dictionary of inputs and outputs together.</span>

<span class="sd">        Args:</span>
<span class="sd">            params: dict</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_experiment</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="AbstractCoreModel.log">
<a class="viewcode-back" href="../../../source/emat.models/abstract.html#emat.model.AbstractCoreModel.log">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Log a message.</span>

<span class="sd">        This facility will attempt to send log messages to</span>
<span class="sd">        the attached database, falling back to the regular</span>
<span class="sd">        module logger in case that fails.</span>

<span class="sd">        Args:</span>
<span class="sd">            message (str): Message to send to log.</span>
<span class="sd">            level (int, default logging.INFO): Log level.</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>